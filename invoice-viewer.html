<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Invoice - Systemly</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --primary: #F97316;
  --secondary: #6366F1;
  --accent: #14B8A6;
  --text: #1F2937;
  --gray: #6B7280;
  --gray-light: #F3F4F6;
  --border: #E5E7EB;
  --success: #10B981;
}

body {
  font-family: 'Inter', sans-serif;
  background: #F9FAFB;
  color: var(--text);
  line-height: 1.5;
  padding: 1.5rem;
}

.no-print {
  margin-bottom: 1.5rem;
  display: flex;
  gap: 0.75rem;
  justify-content: center;
}

.btn {
  padding: 0.65rem 1.25rem;
  border: none;
  border-radius: 6px;
  font-weight: 600;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  font-size: 0.875rem;
  transition: all 0.3s;
  text-decoration: none;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
}

.btn-secondary {
  background: white;
  color: var(--text);
  border: 2px solid var(--border);
}

.btn-secondary:hover {
  border-color: var(--secondary);
  color: var(--secondary);
}

.btn-success {
  background: var(--success);
  color: white;
}

.btn-success:hover {
  background: #059669;
}

/* A4 Invoice Container - Optimized for 2 pages */
.invoice-wrapper {
  max-width: 210mm;
  margin: 0 auto;
  background: white;
  box-shadow: 0 0 20px rgba(0,0,0,0.08);
}

.invoice-page {
  width: 210mm;
  min-height: 297mm;
  max-height: 297mm;
  padding: 15mm 20mm;
  background: white;
  page-break-after: always;
}

/* Invoice Header - Compact */
.invoice-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 2px solid var(--primary);
}

.company-info {
  flex: 1;
}

.company-logo {
  font-size: 1.75rem;
  font-weight: 800;
  color: var(--primary);
  margin-bottom: 0.25rem;
  letter-spacing: -0.5px;
}

.company-tagline {
  color: var(--gray);
  font-size: 0.75rem;
  margin-bottom: 0.5rem;
  font-weight: 500;
}

.company-details {
  font-size: 0.7rem;
  color: var(--gray);
  line-height: 1.5;
}

.invoice-title-section {
  text-align: right;
}

.invoice-title {
  font-size: 2.25rem;
  font-weight: 800;
  color: var(--text);
  margin-bottom: 0.25rem;
  letter-spacing: -1px;
}

.invoice-number {
  font-size: 0.9rem;
  color: var(--primary);
  font-weight: 700;
  margin-bottom: 0.15rem;
}

.invoice-date {
  font-size: 0.75rem;
  color: var(--gray);
  font-weight: 500;
}

/* Status Badge - Compact */
.status-badge {
  display: inline-block;
  padding: 0.35rem 0.75rem;
  border-radius: 50px;
  font-weight: 700;
  font-size: 0.7rem;
  margin-top: 0.4rem;
  letter-spacing: 0.5px;
}

.status-paid, .status-completed {
  background: rgba(16, 185, 129, 0.1);
  color: var(--success);
  border: 2px solid var(--success);
}

.status-pending {
  background: rgba(249, 115, 22, 0.1);
  color: var(--primary);
  border: 2px solid var(--primary);
}

/* Parties Section - Compact */
.parties-section {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.party-box {
  padding: 0.9rem;
  background: var(--gray-light);
  border-radius: 6px;
}

.party-title {
  font-size: 0.65rem;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--gray);
  margin-bottom: 0.4rem;
  font-weight: 700;
}

.party-name {
  font-size: 0.9rem;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 0.3rem;
}

.party-details {
  font-size: 0.7rem;
  color: var(--gray);
  line-height: 1.5;
}

/* Invoice Table - Compact */
.invoice-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 1.25rem;
}

.invoice-table thead {
  background: var(--secondary);
  color: white;
}

.invoice-table th {
  padding: 0.65rem 0.75rem;
  text-align: left;
  font-weight: 700;
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.invoice-table th:last-child,
.invoice-table td:last-child {
  text-align: right;
}

.invoice-table tbody tr {
  border-bottom: 1px solid var(--border);
}

.invoice-table td {
  padding: 0.85rem 0.75rem;
  vertical-align: top;
}

.item-description {
  font-weight: 600;
  color: var(--text);
  margin-bottom: 0.2rem;
  font-size: 0.8rem;
}

.item-subdescription {
  font-size: 0.7rem;
  color: var(--gray);
  line-height: 1.5;
}

.item-qty {
  text-align: center;
  color: var(--gray);
  font-size: 0.8rem;
}

/* Totals Section - Compact */
.totals-section {
  display: flex;
  justify-content: flex-end;
  margin-bottom: 1.5rem;
}

.totals-table {
  width: 350px;
}

.total-row {
  display: flex;
  justify-content: space-between;
  padding: 0.5rem 0;
  border-bottom: 1px solid var(--border);
  font-size: 0.8rem;
}

.total-row.subtotal {
  font-weight: 600;
}

.total-row.tax {
  color: var(--gray);
}

.total-row.grand-total {
  padding: 0.75rem 0;
  margin-top: 0.3rem;
  border-top: 2px solid var(--secondary);
  border-bottom: 2px solid var(--secondary);
  font-size: 1.25rem;
  font-weight: 800;
  color: var(--primary);
}

/* Payment Info - Compact */
.payment-info {
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.04), rgba(20, 184, 166, 0.04));
  border: 1.5px solid var(--secondary);
  border-radius: 6px;
  padding: 1rem;
  margin-bottom: 1.25rem;
}

.payment-title {
  font-size: 0.9rem;
  font-weight: 700;
  color: var(--secondary);
  margin-bottom: 0.65rem;
  display: flex;
  align-items: center;
  gap: 0.4rem;
}

.payment-grid {
  display: grid;
  grid-template-columns: 120px 1fr;
  gap: 0.45rem;
  font-size: 0.75rem;
}

.payment-label {
  font-weight: 600;
  color: var(--text);
}

.payment-value {
  color: var(--gray);
}

/* Terms & Notes - Compact */
.terms-section {
  background: var(--gray-light);
  border-left: 3px solid var(--primary);
  padding: 1rem;
  border-radius: 4px;
  margin-bottom: 1.25rem;
}

.terms-title {
  font-size: 0.85rem;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 0.65rem;
}

.terms-list {
  list-style: none;
  counter-reset: item;
}

.terms-list li {
  counter-increment: item;
  margin-bottom: 0.45rem;
  font-size: 0.7rem;
  color: var(--gray);
  line-height: 1.5;
  padding-left: 1.5rem;
  position: relative;
}

.terms-list li::before {
  content: counter(item) ".";
  position: absolute;
  left: 0;
  font-weight: 700;
  color: var(--primary);
  font-size: 0.7rem;
}

/* Footer - Compact */
.invoice-footer {
  text-align: center;
  padding-top: 1rem;
  border-top: 1.5px solid var(--border);
  color: var(--gray);
  font-size: 0.7rem;
}

.invoice-footer p {
  margin-bottom: 0.3rem;
  line-height: 1.4;
}

/* Print Styles - Strict A4 */
@media print {
  body {
    background: white;
    padding: 0;
    margin: 0;
  }
  
  .no-print {
    display: none !important;
  }
  
  .invoice-wrapper {
    box-shadow: none;
    max-width: 100%;
    margin: 0;
  }
  
  .invoice-page {
    width: 210mm;
    min-height: auto;
    max-height: none;
    padding: 15mm 20mm;
    margin: 0;
    page-break-inside: avoid;
    overflow: visible;
  }
  
  @page {
    size: A4 portrait;
    margin: 0;
  }
  
  /* Make company logo visible in print */
  .company-logo {
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
    color: #F97316 !important;
  }
  
  /* More compact spacing for print */
  .invoice-header {
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
  }
  
  .parties-section {
    margin-bottom: 1rem;
  }
  
  .invoice-table {
    margin-bottom: 0.85rem;
    page-break-inside: auto;
  }
  
  .invoice-table tr {
    page-break-inside: avoid;
    page-break-after: auto;
  }
  
  .invoice-table thead {
    display: table-header-group;
  }
  
  .totals-section {
    margin-bottom: 1rem;
    page-break-inside: avoid;
  }
  
  .payment-info {
    margin-bottom: 0.85rem;
    page-break-inside: avoid;
  }
  
  .terms-section {
    margin-bottom: 0.85rem;
    page-break-inside: avoid;
  }
  
  .invoice-footer {
    page-break-inside: avoid;
  }
}

/* Loading State */
.loading-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 400px;
}

.loader {
  width: 45px;
  height: 45px;
  border: 3px solid var(--gray-light);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.error-container {
  text-align: center;
  padding: 3rem;
  color: var(--gray);
}

.error-container i {
  font-size: 3.5rem;
  color: #EF4444;
  margin-bottom: 1rem;
}
</style>
</head>
<body>

<!-- Action Buttons -->
<div class="no-print">
  <button class="btn btn-success" onclick="refreshInvoice()">
    <i class="fas fa-sync"></i> Refresh
  </button>
  <button class="btn btn-primary" onclick="window.print()">
    <i class="fas fa-print"></i> Print Invoice
  </button>
  <button class="btn btn-secondary" onclick="downloadPDF()">
    <i class="fas fa-download"></i> Download PDF
  </button>
  <a href="admin_buyer_page.html?tab=invoices" class="btn btn-secondary">
    <i class="fas fa-arrow-left"></i> Back to Dashboard
  </a>
</div>

<!-- Invoice Container -->
<div class="invoice-wrapper">
  <div class="invoice-page" id="invoiceContent">
    <div class="loading-container">
      <div class="loader"></div>
      <p style="margin-top: 1rem; color: var(--gray);">Loading invoice...</p>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
import { getFirestore, doc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD3PQ5oWrzAXOHnb7wrmpRhL9DWIB7w9rE",
  authDomain: "systemly-db.firebaseapp.com",
  projectId: "systemly-db",
  storageBucket: "systemly-db.firebasestorage.app",
  messagingSenderId: "32599486733",
  appId: "1:32599486733:web:16d34643c8f920a6fd8044"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentInvoice = null;
let unsubscribe = null;

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = 'login.html';
    return;
  }
  
  await loadInvoice();
});

async function loadInvoice() {
  const urlParams = new URLSearchParams(window.location.search);
  const invoiceId = urlParams.get('id');
  
  if (!invoiceId) {
    showError('Invoice ID not provided');
    return;
  }
  
  try {
    const invoiceRef = doc(db, 'invoices', invoiceId);
    
    // Set up real-time listener for invoice updates
    unsubscribe = onSnapshot(invoiceRef, (docSnap) => {
      if (docSnap.exists()) {
        currentInvoice = { id: invoiceId, ...docSnap.data() };
        console.log('âœ… Invoice loaded/updated:', currentInvoice);
        console.log('ðŸ“Š Status:', currentInvoice.status);
        renderInvoice(currentInvoice);
      } else {
        showError('Invoice not found');
      }
    }, (error) => {
      console.error('Error loading invoice:', error);
      showError('Failed to load invoice: ' + error.message);
    });
    
  } catch (error) {
    console.error('Error setting up invoice listener:', error);
    showError('Failed to load invoice: ' + error.message);
  }
}

function renderInvoice(invoice) {
  const content = document.getElementById('invoiceContent');
  
  // Handle both 'paid' and 'completed' status
  const isPaid = invoice.status === 'paid' || invoice.status === 'completed';
  const statusClass = isPaid ? 'paid' : 'pending';
  const statusText = isPaid ? 'PAID' : 'PENDING';
  
  console.log('ðŸŽ¨ Rendering invoice with status:', invoice.status, 'â†’', statusText);
  
  content.innerHTML = `
    <!-- Invoice Header -->
    <div class="invoice-header">
      <div class="company-info">
        <div class="company-logo">Systemly</div>
        <div class="company-tagline">System Marketplace Platform</div>
        <div class="company-details">
          ${invoice.platform.address}<br>
          ${invoice.platform.contact} â€¢ ${invoice.platform.phone}<br>
          ${invoice.platform.taxId !== 'Not provided' ? `Tax ID: ${invoice.platform.taxId}` : ''}
        </div>
      </div>
      
      <div class="invoice-title-section">
        <div class="invoice-title">INVOICE</div>
        <div class="invoice-number">${invoice.invoiceNumber}</div>
        <div class="invoice-date">Issued: ${invoice.issueDate}</div>
        <div class="invoice-date">Due: ${invoice.dueDate}</div>
        <div class="status-badge status-${statusClass}">${statusText}</div>
      </div>
    </div>
    
    <!-- Billing Parties -->
    <div class="parties-section">
      <div class="party-box">
        <div class="party-title">Bill From (Seller)</div>
        <div class="party-name">${invoice.seller.companyName}</div>
        <div class="party-details">
          ${invoice.seller.address}<br>
          ${invoice.seller.contact}<br>
          ${invoice.seller.phone}${invoice.seller.taxId ? '<br>Tax ID: ' + invoice.seller.taxId : ''}
        </div>
      </div>
      
      <div class="party-box">
        <div class="party-title">Bill To (Buyer)</div>
        <div class="party-name">${invoice.buyer.companyName}</div>
        <div class="party-details">
          ${invoice.buyer.address}<br>
          ${invoice.buyer.contact}<br>
          ${invoice.buyer.phone}${invoice.buyer.taxId ? '<br>Tax ID: ' + invoice.buyer.taxId : ''}
        </div>
      </div>
    </div>
    
    <!-- Invoice Items -->
    <table class="invoice-table">
      <thead>
        <tr>
          <th style="width: 40px;">#</th>
          <th>Description</th>
          <th style="width: 60px; text-align: center;">Qty</th>
          <th style="width: 130px; text-align: right;">Unit Price</th>
          <th style="width: 130px; text-align: right;">Amount</th>
        </tr>
      </thead>
      <tbody>
        ${invoice.items.map(item => `
          <tr>
            <td style="font-weight: 600; color: var(--gray);">${item.itemNumber}</td>
            <td>
              <div class="item-description">${item.description}</div>
              <div class="item-subdescription">${item.subDescription}</div>
            </td>
            <td class="item-qty">${item.quantity}</td>
            <td style="text-align: right; font-size: 0.8rem;">â‚±${item.unitPrice.toLocaleString()}</td>
            <td style="text-align: right; font-weight: 700; font-size: 0.85rem;">â‚±${item.lineTotal.toLocaleString()}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
    
    <!-- Totals -->
    <div class="totals-section">
      <div class="totals-table">
        <div class="total-row subtotal">
          <span>Base Amount</span>
          <span>â‚±${invoice.baseAmount ? invoice.baseAmount.toLocaleString() : invoice.subtotal.toLocaleString()}</span>
        </div>
        ${invoice.commissionRate ? `
          <div class="total-row tax" style="color: #DC2626;">
            <span>Platform Fee (${invoice.commissionRate}% - ${invoice.seller.subscriptionPlan ? invoice.seller.subscriptionPlan.toUpperCase() : 'FREE'} Plan)</span>
            <span>-â‚±${invoice.commissionAmount.toLocaleString()}</span>
          </div>
          <div class="total-row subtotal">
            <span>After Commission</span>
            <span>â‚±${invoice.subtotal.toLocaleString()}</span>
          </div>
        ` : ''}
        ${invoice.vatEnabled && invoice.vatAmount > 0 ? `
          <div class="total-row tax" style="color: #DC2626;">
            <span>VAT (${invoice.vatRate}%)</span>
            <span>-â‚±${invoice.vatAmount.toLocaleString()}</span>
          </div>
        ` : ''}
        <div class="total-row grand-total">
          <span>Total Due</span>
          <span>â‚±${invoice.totalDue.toLocaleString()}</span>
        </div>
        ${invoice.sellerReceives ? `
          <div class="total-row" style="font-size: 0.85rem; color: var(--success); border-top: 2px dashed var(--border); margin-top: 0.65rem; padding-top: 0.65rem; font-weight: 700;">
            <span>Seller Net Amount</span>
            <span>â‚±${invoice.sellerReceives.toLocaleString()}</span>
          </div>
        ` : ''}
      </div>
    </div>
    
    <!-- Payment Information -->
    <div class="payment-info">
      <div class="payment-title">
        <i class="fas fa-university"></i>
        Payment Details
      </div>
      <div class="payment-grid">
        <div class="payment-label">Bank:</div>
        <div class="payment-value">${invoice.payment.bankName}</div>
        
        <div class="payment-label">Account Name:</div>
        <div class="payment-value">${invoice.payment.accountName}</div>
        
        <div class="payment-label">Account No.:</div>
        <div class="payment-value">${invoice.payment.accountNumber}</div>
        
        <div class="payment-label">SWIFT Code:</div>
        <div class="payment-value">${invoice.payment.swiftCode}</div>
        
        <div class="payment-label">Terms:</div>
        <div class="payment-value">${invoice.payment.paymentTerms}</div>
      </div>
    </div>
    
    <!-- Terms & Conditions -->
    <div class="terms-section">
      <div class="terms-title">Terms & Conditions</div>
      <ul class="terms-list">
        <li>This invoice corresponds to the purchase and transfer of the system as agreed via the Systemly marketplace.</li>
        <li>The seller certifies full rights to transfer all listed assets and IP with no undisclosed liabilities.</li>
        <li>Transfer of ownership is contingent upon full payment receipt and confirmation by administrator.</li>
        <li>Disputes must be raised within 30 days of invoice date.</li>
        <li>Upon payment confirmation, buyer receives download access to all system files and documentation.</li>
      </ul>
    </div>
    
    <!-- Footer -->
    <div class="invoice-footer">
      <p><strong>Systemly</strong> - System Marketplace Platform â€¢ ${invoice.platform.contact}</p>
      <p>This is a computer-generated invoice and is valid without physical signature</p>
    </div>
  `;
}
function showError(message) {
  const content = document.getElementById('invoiceContent');
  content.innerHTML = `
    <div class="error-container">
      <i class="fas fa-exclamation-triangle"></i>
      <h2 style="margin-bottom: 0.5rem;">Error</h2>
      <p>${message}</p>
      <br>
      <a href="admin_buyer_page.html?tab=invoices" class="btn btn-primary">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
      </a>
    </div>
  `;
}

window.refreshInvoice = function() {
  const btn = event.target.closest('.btn');
  const originalHTML = btn.innerHTML;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
  btn.disabled = true;
  
  setTimeout(() => {
    btn.innerHTML = originalHTML;
    btn.disabled = false;
  }, 1000);
  
  // The real-time listener will automatically update
  console.log('ðŸ”„ Invoice will auto-update via listener');
}

window.downloadPDF = function() {
  window.print();
}

// Clean up listener on page unload
window.addEventListener('beforeunload', () => {
  if (unsubscribe) {
    unsubscribe();
  }
});

console.log('âœ… Invoice viewer loaded with real-time updates');
</script>

</body>
</html>
