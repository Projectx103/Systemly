<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - Systemly</title>
<link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;600;700;900&family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous">

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --primary: #F97316;
  --secondary: #6366F1;
  --accent: #14B8A6;
  --bg: #FFF7ED;
  --text: #1F2937;
  --white: #FFFFFF;
  --gray-light: #F3F4F6;
  --gray: #6B7280;
  --gray-dark: #374151;
  --success: #10B981;
  --warning: #F59E0B;
  --error: #EF4444;
  --info: #3B82F6;
}

body {
  font-family: 'Sarabun', sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  opacity: 0;
  transition: opacity 0.3s;
}

body.loaded { opacity: 1; }

h1,h2,h3,h4,h5,h6 { font-family: 'Archivo', sans-serif; }

/* Loading Screen */
.loading-screen {
  position: fixed;
  inset: 0;
  background: var(--bg);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 1rem;
  z-index: 9999;
}

.loading-screen.hidden { display: none; }

.loader {
  width: 50px;
  height: 50px;
  border: 4px solid var(--gray-light);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

/* Dashboard Layout */
.dashboard-layout {
  display: grid;
  grid-template-columns: 280px 1fr;
  min-height: 100vh;
}

.sidebar {
  background: var(--white);
  border-right: 1px solid var(--gray-light);
  position: sticky;
  top: 0;
  height: 100vh;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

.sidebar-header {
  padding: 2rem 1.5rem;
  border-bottom: 1px solid var(--gray-light);
}

.logo {
  font-family: 'Archivo', sans-serif;
  font-size: 2rem;
  font-weight: 900;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-decoration: none;
  display: block;
}

.user-profile {
  padding: 1.5rem;
  border-bottom: 1px solid var(--gray-light);
}

.user-profile-content {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1rem;
}

.user-avatar {
  width: 50px;
  height: 50px;
  min-width: 50px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--white);
  font-weight: 700;
  font-size: 1.2rem;
  flex-shrink: 0;
}

.user-details {
  flex: 1;
  min-width: 0;
}

.user-name {
  font-weight: 600;
  font-size: 1rem;
  margin-bottom: 0.2rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.user-email {
  font-size: 0.85rem;
  color: var(--gray);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.role-badge {
  padding: 0.4rem 0.8rem;
  border-radius: 50px;
  font-size: 0.85rem;
  font-weight: 600;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: var(--white);
  display: inline-block;
}

.plan-badge {
  padding: 0.5rem 1rem;
  border-radius: 50px;
  font-size: 0.8rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 0.4rem;
  justify-content: center;
  margin-top: 0.5rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.plan-badge.premium {
  background: linear-gradient(135deg, #FFD700, #FFA500);
  color: #1A1A1A;
  border: 2px solid rgba(255, 255, 255, 0.3);
  animation: shimmer 3s ease-in-out infinite;
}

.plan-badge.premium::before { content: 'üëë'; }

.plan-badge.basic {
  background: linear-gradient(135deg, #6366F1, #3B82F6);
  color: #FFFFFF;
  border: 2px solid rgba(255, 255, 255, 0.2);
}

.plan-badge.basic::before { content: 'üíé'; }

.plan-badge.free {
  background: linear-gradient(135deg, #9CA3AF, #6B7280);
  color: #FFFFFF;
  border: 2px solid rgba(255, 255, 255, 0.2);
}

.plan-badge.free::before { content: 'üì¶'; }

@keyframes shimmer {
  0%, 100% { box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4); }
  50% { box-shadow: 0 2px 15px rgba(255, 215, 0, 0.8); }
}

.sidebar-nav {
  flex: 1;
  padding: 1rem 0;
}

.nav-section {
  margin-bottom: 1.5rem;
}

.nav-section-title {
  padding: 0.5rem 1.5rem;
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--gray);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 0.8rem;
  padding: 0.8rem 1.5rem;
  color: var(--text);
  text-decoration: none;
  transition: all 0.2s;
  position: relative;
  cursor: pointer;
}

.nav-item:hover {
  background: var(--bg);
  color: var(--primary);
}

.nav-item.active {
  background: linear-gradient(to right, rgba(249, 115, 22, 0.1), transparent);
  color: var(--primary);
  font-weight: 600;
}

.nav-item.active::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 4px;
  background: linear-gradient(180deg, var(--primary), var(--secondary));
}

.nav-item i {
  width: 20px;
  text-align: center;
  font-size: 1.1rem;
}

.nav-item.locked {
  opacity: 0.5;
  cursor: not-allowed;
}

.nav-item .lock-icon {
  margin-left: auto;
  font-size: 0.85rem;
  color: var(--gray);
}

.sidebar-footer {
  padding: 1.5rem;
  border-top: 1px solid var(--gray-light);
}

.logout-btn {
  width: 100%;
  padding: 0.8rem;
  background: var(--error);
  color: var(--white);
  border: none;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  font-family: 'Sarabun', sans-serif;
  font-size: 1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

.logout-btn:hover {
  background: #dc2626;
  transform: translateY(-2px);
}

/* Main Content */
.main-content {
  overflow-y: auto;
  height: 100vh;
}

.top-bar {
  background: var(--white);
  padding: 1.5rem 2rem;
  border-bottom: 1px solid var(--gray-light);
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 100;
}

.page-title {
  font-size: 1.8rem;
  font-weight: 900;
}

.top-bar-actions {
  display: flex;
  gap: 1rem;
  align-items: center;
}

.content-area {
  padding: 2rem;
}

/* Subscription Banner */
.subscription-banner {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: var(--white);
  padding: 2rem;
  border-radius: 20px;
  margin-bottom: 2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 10px 30px rgba(249, 115, 22, 0.3);
}

.banner-content h2 {
  font-size: 1.8rem;
  margin-bottom: 0.5rem;
}

.banner-content p {
  opacity: 0.95;
  font-size: 1rem;
}

.subscription-badge {
  background: rgba(255,255,255,0.2);
  padding: 0.5rem 1rem;
  border-radius: 50px;
  font-weight: 600;
  font-size: 0.9rem;
  margin-top: 0.8rem;
  display: inline-block;
}

.upgrade-btn {
  background: var(--white);
  color: var(--primary);
  padding: 1rem 2rem;
  border-radius: 50px;
  text-decoration: none;
  font-weight: 600;
  transition: all 0.3s;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  border: none;
  cursor: pointer;
  font-family: 'Sarabun', sans-serif;
  font-size: 1rem;
}

.upgrade-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.3);
}

/* Tab Content */
.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
  animation: fadeIn 0.4s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.stat-card {
  background: var(--white);
  padding: 2rem;
  border-radius: 15px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.06);
  transition: transform 0.3s;
}

.stat-card:hover { transform: translateY(-5px); }

.stat-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.stat-icon {
  width: 50px;
  height: 50px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
}

.stat-icon.primary {
  background: rgba(249, 115, 22, 0.1);
  color: var(--primary);
}

.stat-icon.secondary {
  background: rgba(99, 102, 241, 0.1);
  color: var(--secondary);
}

.stat-icon.accent {
  background: rgba(20, 184, 166, 0.1);
  color: var(--accent);
}

.stat-icon.success {
  background: rgba(16, 185, 129, 0.1);
  color: var(--success);
}

.stat-value {
  font-size: 2rem;
  font-weight: 900;
  color: var(--text);
  margin-bottom: 0.3rem;
}

.stat-label {
  color: var(--gray);
  font-size: 0.9rem;
}

/* Content Cards */
.content-card {
  background: var(--white);
  padding: 2rem;
  border-radius: 15px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.06);
  margin-bottom: 2rem;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--gray-light);
}

.card-header h3 {
  font-size: 1.5rem;
  font-weight: 700;
}

.card-action {
  color: var(--primary);
  text-decoration: none;
  font-weight: 600;
  transition: color 0.3s;
  cursor: pointer;
  background: none;
  border: none;
  font-family: 'Sarabun', sans-serif;
  font-size: 1rem;
}

.card-action:hover { color: var(--secondary); }

/* Locked Feature Overlay */
.locked-feature {
  position: relative;
  opacity: 0.6;
  pointer-events: none;
}

.locked-overlay {
  position: absolute;
  inset: 0;
  background: rgba(255,255,255,0.9);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  border-radius: 15px;
  gap: 1rem;
  z-index: 10;
}

.locked-overlay i {
  font-size: 3rem;
  color: var(--gray);
}

.locked-overlay p {
  color: var(--text);
  font-weight: 600;
  text-align: center;
}

.unlock-btn {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: var(--white);
  padding: 0.8rem 1.5rem;
  border: none;
  border-radius: 50px;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.3s;
  pointer-events: auto;
}

.unlock-btn:hover { transform: scale(1.05); }

/* Modal Styles */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(5px);
  z-index: 2000;
  align-items: center;
  justify-content: center;
  padding: 1rem;
}

.modal.active { display: flex; }

.modal-content {
  background: var(--white);
  padding: 3rem;
  border-radius: 30px;
  max-width: 800px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(30px); }
  to { opacity: 1; transform: translateY(0); }
}

.close-modal {
  position: absolute;
  top: 1.5rem;
  right: 1.5rem;
  background: none;
  border: none;
  font-size: 2rem;
  cursor: pointer;
  color: var(--gray);
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.3s;
}

.close-modal:hover {
  background: var(--gray-light);
  color: var(--text);
}

.modal-header {
  text-align: center;
  margin-bottom: 2rem;
}

.modal-icon { font-size: 4rem; margin-bottom: 1rem; }

.modal-header h2 {
  font-size: 2rem;
  margin-bottom: 0.5rem;
}

/* Form Styles */
.form-group {
  margin-bottom: 1.5rem;
}

.form-label {
  display: block;
  font-weight: 600;
  margin-bottom: 0.5rem;
  color: var(--text);
}

.form-input, .form-select, .form-textarea {
  width: 100%;
  padding: 0.8rem 1rem;
  border: 2px solid var(--gray-light);
  border-radius: 10px;
  font-family: 'Sarabun', sans-serif;
  font-size: 1rem;
  transition: all 0.3s;
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
}

.form-textarea {
  resize: vertical;
  min-height: 100px;
}

.form-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
}

/* Button Styles */
.btn {
  padding: 0.8rem 1.5rem;
  border: none;
  border-radius: 10px;
  font-family: 'Sarabun', sans-serif;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: var(--white);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(249, 115, 22, 0.4);
}

.btn-secondary {
  background: var(--gray-light);
  color: var(--text);
}

.btn-secondary:hover {
  background: var(--gray);
  color: var(--white);
}

.btn-success {
  background: var(--success);
  color: var(--white);
}

.btn-danger {
  background: var(--error);
  color: var(--white);
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Listings Table */
.listings-table {
  width: 100%;
  border-collapse: collapse;
}

.listings-table th {
  text-align: left;
  padding: 1rem;
  background: var(--gray-light);
  font-weight: 600;
  border-bottom: 2px solid var(--gray);
}

.listings-table td {
  padding: 1rem;
  border-bottom: 1px solid var(--gray-light);
}

.listing-image {
  width: 60px;
  height: 60px;
  object-fit: cover;
  border-radius: 8px;
}

.status-badge {
  padding: 0.3rem 0.8rem;
  border-radius: 50px;
  font-size: 0.85rem;
  font-weight: 600;
  display: inline-block;
}

.status-pending {
  background: var(--warning);
  color: white;
}

.status-active, .status-approved {
  background: var(--success);
  color: white;
}

.status-draft {
  background: var(--gray);
  color: white;
}

.status-sold {
  background: var(--secondary);
  color: white;
}

.status-closed {
  background: var(--error);
  color: white;
}

/* Toast Notifications */
.toast {
  position: fixed;
  bottom: 2rem;
  right: 2rem;
  background: var(--white);
  padding: 1rem 1.5rem;
  border-radius: 10px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  display: flex;
  align-items: center;
  gap: 1rem;
  z-index: 3000;
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from { transform: translateX(400px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

.toast.success { border-left: 4px solid var(--success); }
.toast.error { border-left: 4px solid var(--error); }
.toast.info { border-left: 4px solid var(--info); }

.empty-state {
  text-align: center;
  padding: 3rem;
  color: var(--gray);
}

.empty-state i {
  font-size: 3rem;
  margin-bottom: 1rem;
  display: block;
  opacity: 0.3;
}

/* Chart Container */
.chart-container {
  position: relative;
  height: 300px;
  margin-top: 1rem;
}

/* Responsive */
@media (max-width: 1024px) {
  .dashboard-layout {
    grid-template-columns: 1fr;
  }
  
  .sidebar {
    display: none;
  }
  
  .stats-grid {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  }
  
  .listings-table {
    display: block;
    overflow-x: auto;
  }
}

@media (max-width: 768px) {
  .subscription-banner {
    flex-direction: column;
    text-align: center;
    gap: 1.5rem;
  }
  
  .top-bar {
    flex-direction: column;
    gap: 1rem;
  }
  
  .content-area {
    padding: 1rem;
  }
  
  .modal-content {
    padding: 2rem 1.5rem;
  }
  
  .form-row {
    grid-template-columns: 1fr;
  }
}
</style>
</head>
<body>

<div class="loading-screen" id="loadingScreen">
  <div class="loader"></div>
  <p>Loading your dashboard...</p>
</div>

<div class="dashboard-layout">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <a href="index.html" class="logo">Systemly</a>
    </div>
    
    <div class="user-profile">
      <div class="user-profile-content">
        <div class="user-avatar" id="sidebarAvatar">U</div>
        <div class="user-details">
          <div class="user-name" id="sidebarName">User</div>
          <div class="user-email" id="sidebarEmail">user@email.com</div>
        </div>
      </div>
      <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
        <span class="role-badge" id="sidebarRole">Seller</span>
        <span class="plan-badge" id="planBadge">Free</span>
      </div>
    </div>
    
    <nav class="sidebar-nav" id="sidebarNav">
  <div class="nav-section">
    <div class="nav-section-title">Overview</div>
    <div class="nav-item active" onclick="navigateTo('dashboard')">
      <i class="fa-solid fa-house"></i>
      <span>Dashboard</span>
    </div>
    <div class="nav-item" onclick="navigateTo('listings')">
      <i class="fa-solid fa-list"></i>
      <span>My Listings</span>
    </div>
    <div class="nav-item" onclick="navigateTo('offers')">
      <i class="fa-solid fa-money-bill-trend-up"></i>
      <span>Offers</span>
      <span id="offersCountBadge" style="margin-left: auto; background: var(--error); color: white; padding: 0.2rem 0.6rem; border-radius: 50%; font-size: 0.75rem; display: none;"></span>
    </div>
  </div>
  
  <div class="nav-section">
    <div class="nav-section-title">Insights</div>
    <div class="nav-item" onclick="navigateTo('analytics')">
      <i class="fa-solid fa-chart-line"></i>
      <span>Analytics</span>
    </div>
    <div class="nav-item" onclick="navigateTo('messages')">
      <i class="fa-solid fa-envelope"></i>
      <span>Messages</span>
      <span id="messagesCountBadge" style="margin-left: auto; background: var(--error); color: white; padding: 0.2rem 0.6rem; border-radius: 50%; font-size: 0.75rem; display: none;"></span>
    </div>
  </div>
  
  <div class="nav-section">
    <div class="nav-section-title">Account</div>
    <div class="nav-item" onclick="navigateTo('subscription')">
      <i class="fa-solid fa-crown"></i>
      <span>Subscription</span>
    </div>
    <div class="nav-item" onclick="navigateTo('settings')">
      <i class="fa-solid fa-gear"></i>
      <span>Settings</span>
    </div>
  </div>
</nav>
    
    <div class="sidebar-footer">
      <button class="logout-btn" onclick="logout()">
        <i class="fa-solid fa-right-from-bracket"></i>
        Sign Out
      </button>
    </div>
  </aside>
  
  <!-- Main Content -->
  <main class="main-content">
    <div class="top-bar">
      <h1 class="page-title" id="pageTitle">Dashboard</h1>
      <div class="top-bar-actions">
        <a href="marketplace.html" class="btn btn-secondary" style="text-decoration: none;">
          <i class="fa-solid fa-store"></i> Marketplace
        </a>
        <button class="btn btn-primary" id="btn-add-listing" onclick="openAddListingModal()">
          <i class="fa-solid fa-plus"></i> Create Listing
        </button>
      </div>
    </div>
    
    <div class="content-area" id="contentArea">
      <!-- Subscription Banner -->
      <div class="subscription-banner" id="subscriptionBanner">
        <div class="banner-content">
          <h2 id="planTitle">Free Plan</h2>
          <p id="planDescription">Current plan description</p>
          <span class="subscription-badge" id="planBadgeDetail">Plan details</span>
        </div>
        <button class="upgrade-btn" id="btn-upgrade" onclick="openUpgradeModal()">Upgrade Plan</button>
      </div>
      
      <!-- Tab Content Container -->
      <div id="tabContainer"></div>
    </div>
  </main>
</div>

<!-- Add/Edit Listing Modal -->
<div class="modal" id="listingModal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeListingModal()">√ó</button>
    
    <div class="modal-header">
      <div class="modal-icon">üìù</div>
      <h2 id="listingModalTitle">Create New Listing</h2>
    </div>

    <form id="listingForm">
      <input type="hidden" id="listingId">
      
      <div class="form-group">
        <label class="form-label">System Name *</label>
        <input type="text" id="systemName" class="form-input" required placeholder="e.g., Budget Master">
      </div>
      
      <div class="form-group">
        <label class="form-label">Category *</label>
        <select id="category" class="form-select" required>
          <option value="">Select category...</option>
          <option value="saas">SaaS Business</option>
          <option value="ecommerce">E-commerce Store</option>
          <option value="content">Content Site</option>
          <option value="mobile">Mobile App</option>
          <option value="script">Script/Code</option>
          <option value="other">Other</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">Short Description *</label>
        <textarea id="shortDescription" class="form-textarea" required placeholder="Brief overview (max 200 chars)" maxlength="200"></textarea>
      </div>
      
      <div class="form-group">
        <label class="form-label">Detailed Description *</label>
        <textarea id="detailedDescription" class="form-textarea" required placeholder="Comprehensive description..." style="min-height: 150px;"></textarea>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Asking Price (‚Ç±) *</label>
          <input type="number" id="askingPrice" class="form-input" required min="0" step="1000" placeholder="45000">
        </div>
        
        <div class="form-group">
          <label class="form-label">Monthly Revenue (‚Ç±)</label>
          <input type="number" id="monthlyRevenue" class="form-input" min="0" step="100" placeholder="5000">
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">MRR (‚Ç±)</label>
          <input type="number" id="mrr" class="form-input" min="0" step="100" placeholder="5000">
        </div>
        
        <div class="form-group">
          <label class="form-label">Active Subscribers</label>
          <input type="number" id="activeSubscribers" class="form-input" min="0" placeholder="15">
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Churn Rate (‚Ç±)</label>
          <input type="number" id="churnRate" class="form-input" min="0" step="100" placeholder="500">
        </div>
        
        <div class="form-group">
          <label class="form-label">Pricing Model</label>
          <select id="pricingModel" class="form-select">
            <option value="">Select model...</option>
            <option value="Subscription">Subscription</option>
            <option value="One-time">One-time</option>
            <option value="Freemium">Freemium</option>
            <option value="Usage-based">Usage-based</option>
          </select>
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">SaaS Type</label>
        <select id="saasType" class="form-select">
          <option value="">Select type...</option>
          <option value="B2C">B2C</option>
          <option value="B2B">B2B</option>
          <option value="B2B2C">B2B2C</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">Main Image URL *</label>
        <input type="url" id="mainImage" class="form-input" required placeholder="https://example.com/image.jpg">
        <small style="color: var(--gray); font-size: 0.85rem;">Use image hosting services like ImgBB, Imgur, or Cloudinary</small>
      </div>
      
      <div class="form-group">
        <label class="form-label">Additional Images (comma-separated URLs)</label>
        <textarea id="additionalImages" class="form-textarea" placeholder="https://example.com/img1.jpg, https://example.com/img2.jpg"></textarea>
      </div>
      
      <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
        <button type="button" class="btn btn-secondary" onclick="closeListingModal()">Cancel</button>
        <button type="button" id="save-draft" class="btn btn-secondary" onclick="saveListing('draft')">
          <i class="fa-solid fa-file"></i> Save Draft
        </button>
        <button type="button" id="publish" class="btn btn-primary" onclick="saveListing('pending')">
          <i class="fa-solid fa-rocket"></i> Publish
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Upgrade Modal -->
<div class="modal" id="upgradeModal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeUpgradeModal()">√ó</button>
    
    <div class="modal-header">
      <div class="modal-icon">üöÄ</div>
      <h2>Upgrade Your Plan</h2>
      <p>Unlock more features and grow your business</p>
    </div>

    <div class="current-plan-info" style="background: var(--gray-light); padding: 1.5rem; border-radius: 15px; margin-bottom: 2rem;">
      <h4>Your Current Plan</h4>
      <p id="modalCurrentPlan"></p>
    </div>

    <div class="upgrade-options" id="upgradeOptions"></div>

    <p style="text-align: center; color: var(--gray); font-size: 0.9rem;">
      All plans include secure transactions and support
    </p>
  </div>
</div>

<!-- Promote Modal -->
<div class="modal" id="promoteModal">
  <div class="modal-content">
    <button class="close-modal" onclick="closePromoteModal()">√ó</button>
    
    <div class="modal-header">
      <div class="modal-icon">üì¢</div>
      <h2>Promote Your Listing</h2>
      <p>Feature your listing for maximum visibility</p>
    </div>

    <div style="padding: 1rem;">
      <div style="background: var(--bg); padding: 1.5rem; border-radius: 15px; margin-bottom: 1.5rem;">
        <h4 style="margin-bottom: 0.5rem;">Featured Placement</h4>
        <p style="color: var(--gray); margin-bottom: 1rem;">Your listing will appear at the top of search results and on the homepage</p>
        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">‚Ç±500 <span style="font-size: 1rem; font-weight: 400;">/7 days</span></div>
      </div>
      
      <button class="btn btn-primary" style="width: 100%;" onclick="handlePromotePayment()">
        <i class="fa-solid fa-credit-card"></i> Promote Now
      </button>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal" id="deleteModal">
  <div class="modal-content" style="max-width: 500px;">
    <button class="close-modal" onclick="closeDeleteModal()">√ó</button>
    
    <div class="modal-header">
      <div class="modal-icon" style="color: var(--error);">‚ö†Ô∏è</div>
      <h2>Delete Listing</h2>
      <p>Are you sure you want to delete this listing?</p>
    </div>

    <div style="background: var(--gray-light); padding: 1.5rem; border-radius: 15px; margin-bottom: 1.5rem;">
      <p id="deleteListingName" style="font-weight: 600;"></p>
      <p style="color: var(--gray); font-size: 0.9rem; margin-top: 0.5rem;">This action cannot be undone.</p>
    </div>

    <div style="display: flex; gap: 1rem;">
      <button class="btn btn-secondary" style="flex: 1;" onclick="closeDeleteModal()">Cancel</button>
      <button class="btn btn-danger" style="flex: 1;" onclick="confirmDelete()">
        <i class="fa-solid fa-trash"></i> Delete
      </button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
import { 
  getFirestore, 
  doc, 
  getDoc, 
  setDoc, 
  updateDoc, 
  collection, 
  query, 
  where, 
  getDocs, 
  addDoc,
  deleteDoc,
  runTransaction,
  increment,
  serverTimestamp,
  onSnapshot,
  Timestamp
} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD3PQ5oWrzAXOHnb7wrmpRhL9DWIB7w9rE",
  authDomain: "systemly-db.firebaseapp.com",
  projectId: "systemly-db",
  storageBucket: "systemly-db.firebasestorage.app",
  messagingSenderId: "32599486733",
  appId: "1:32599486733:web:16d34643c8f920a6fd8044"
};

const API_URL = 'https://systemly.onrender.com'; // ‚ö†Ô∏è UPDATE with your Render URL
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let userData = null;
let userListings = [];
let listingsUnsubscribe = null;
let currentChart = null;
let deleteListingId = null;

// ============================================
// PLAN CONFIGURATION
// ============================================

const PLAN_LIMITS = {
  free: {
    maxActiveListings: 1,
    canReceiveInquiries: false,
    analytics: "none",
    canPromote: false,
    features: [
      '1 active listing',
      'Basic listing visibility',
      'Buyer inquiry messages',
      'Standard support'
    ]
  },
  basic: {
    maxActiveListings: 5,
    canReceiveInquiries: true,
    analytics: "basic",
    canPromote: true,
    features: [
      'Up to 5 active listings',
      'Priority search placement',
      'Full analytics dashboard',
      'Performance insights',
      'Direct buyer contact',
      'Email support',
      'Featured homepage placement'
    ]
  },
  premium: {
    maxActiveListings: Infinity,
    canReceiveInquiries: true,
    analytics: "advanced",
    canPromote: true,
    features: [
      'Unlimited active listings',
      'Featured homepage placement',
      'Top search ranking',
      'Advanced analytics & insights',
      'Buyer behavior tracking',
      '24/7 priority support',
      'Dedicated account manager'
    ]
  }
};

const PLAN_PRICING = {
  free: { price: 0, currency: '‚Ç±', billing: 'forever' },
  basic: { price: 399, currency: '‚Ç±', billing: 'month' },
  premium: { price: 779, currency: '‚Ç±', billing: 'month' }
};

// ============================================
// AUTH STATE OBSERVER
// ============================================

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    console.log('‚ùå No user authenticated, redirecting to login...');
    window.location.href = 'login.html';
    return;
  }

  console.log('‚úÖ User authenticated:', user.email);

  try {
    const userDocRef = doc(db, 'users', user.uid);
    const userDoc = await getDoc(userDocRef);
    
    if (userDoc.exists()) {
      const data = userDoc.data();
      userData = {
        id: user.uid,
        email: user.email,
        name: data.name || user.displayName || user.email.split('@')[0],
        role: data.role || 'seller',
        subscriptionPlan: data.subscriptionPlan || 'free',
        verified: data.verified || false,
        profile: data.profile || {},
        listings: data.listings || { active: 0, total: 0 },
        stats: data.stats || { totalViews: 0, inquiries: 0, sales: 0 }
      };
      
      console.log('‚úÖ User document loaded:', userData);
      
      // Validate plan
      if (!['free', 'basic', 'premium'].includes(userData.subscriptionPlan)) {
        console.warn('‚ö†Ô∏è Invalid plan detected, defaulting to free');
        userData.subscriptionPlan = 'free';
        await updateDoc(userDocRef, { subscriptionPlan: 'free' });
      }
      
      // Ensure seller role
      if (userData.role !== 'seller') {
        console.warn('‚ö†Ô∏è Non-seller role detected, updating to seller');
        userData.role = 'seller';
        await updateDoc(userDocRef, { role: 'seller' });
      }
    } else {
      console.log('üìù Creating new user document...');
      // Create new user document
      userData = {
        id: user.uid,
        email: user.email,
        name: user.displayName || user.email.split('@')[0],
        role: 'seller',
        subscriptionPlan: 'free',
        verified: false,
        profile: {},
        listings: { active: 0, total: 0 },
        stats: { totalViews: 0, inquiries: 0, sales: 0 }
      };
      
      await setDoc(userDocRef, {
        ...userData,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });
      
      console.log('‚úÖ New user document created');
    }
    
    // Load listings BEFORE initializing dashboard
    await loadUserListings();
    
    // Wait a bit for listener to populate data
    setTimeout(() => {
      console.log('üöÄ Initializing dashboard with', userListings.length, 'listings');
      initializeDashboard();
    }, 500);
    
  } catch (error) {
    console.error('‚ùå Error loading user data:', error);
    showToast('Failed to load dashboard. Please refresh the page.', 'error');
    document.getElementById('loadingScreen').classList.add('hidden');
    document.body.classList.add('loaded');
  }
});

// ============================================
// LOAD USER LISTINGS (REAL-TIME)
// ============================================


async function loadUserListings() {
  try {
    if (!userData || !userData.id) {
      console.error('‚ùå No user data available');
      return;
    }
    
    console.log('üì• Loading listings for user:', userData.id);
    
    const listingsRef = collection(db, 'listings');
    const q = query(listingsRef, where('userId', '==', userData.id));
    
    // Set up real-time listener
    listingsUnsubscribe = onSnapshot(q, (snapshot) => {
      userListings = [];
      
      snapshot.forEach((doc) => {
        const data = doc.data();
        userListings.push({
          id: doc.id,
          ...data
        });
      });
      
      console.log('‚úÖ Loaded listings:', userListings.length);
      
      // Sort by createdAt (newest first)
      userListings.sort((a, b) => {
        const dateA = a.createdAt?.toDate?.() || new Date(0);
        const dateB = b.createdAt?.toDate?.() || new Date(0);
        return dateB - dateA;
      });
      
      // Update active listing count
      const activeStatuses = ['draft', 'pending', 'active', 'approved'];
      const activeCount = userListings.filter(l => activeStatuses.includes(l.status)).length;
      
      userData.listings.active = activeCount;
      userData.listings.total = userListings.length;
      
      console.log('üìä Active listings:', activeCount, '/ Total:', userListings.length);
      
      // Update UI if dashboard is loaded
      if (document.body.classList.contains('loaded')) {
        updateDashboardStats();
        updateSubscriptionBanner();
        
        // Refresh current tab if on listings
        const listingsTab = document.getElementById('tab-listings');
        if (listingsTab && listingsTab.classList.contains('active')) {
          listingsTab.innerHTML = renderListingsTab();
        }
        
        // Refresh overview tab if active
        const overviewTab = document.getElementById('tab-dashboard');
        if (overviewTab && overviewTab.classList.contains('active')) {
          const recentListingsContainer = overviewTab.querySelector('.content-card:last-of-type');
          if (recentListingsContainer) {
            // Re-render recent listings section
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = renderRecentListings();
            if (tempDiv.firstElementChild) {
              recentListingsContainer.replaceWith(tempDiv.firstElementChild);
            }
          }
        }
      }
      
    }, (error) => {
      console.error('‚ùå Error in listings snapshot:', error);
      showToast('Failed to load listings. Check console for details.', 'error');
    });
    
  } catch (error) {
    console.error('‚ùå Error loading user listings:', error);
    showToast('Failed to load listings. Please refresh the page.', 'error');
    userListings = [];
  }
}

// ============================================
// INITIALIZE DASHBOARD
// ============================================

function initializeDashboard() {
  console.log('üéØ Initializing dashboard...');
  console.log('üë§ User data:', userData);
  console.log('üìã User listings:', userListings.length);
  
  document.getElementById('loadingScreen').classList.add('hidden');
  document.body.classList.add('loaded');
  
  updateUserProfile();
  updateSubscriptionBanner();
  renderSidebar();
  renderDashboardContent();
  
  console.log('‚úÖ Dashboard initialized successfully');
}

// ============================================
// ADD: Debug Helper Function
// ============================================

window.debugDashboard = function() {
  console.log('=== DASHBOARD DEBUG INFO ===');
  console.log('User Data:', userData);
  console.log('User Listings:', userListings);
  console.log('Active Tab:', document.querySelector('.tab-content.active')?.id);
  console.log('Plan Limits:', PLAN_LIMITS[userData.subscriptionPlan]);
  console.log('===========================');
}

// Add to console for manual debugging
console.log('üí° Type debugDashboard() in console to see current state');

function updateUserProfile() {
  const initials = userData.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
  
  document.getElementById('sidebarAvatar').textContent = initials;
  document.getElementById('sidebarName').textContent = userData.name;
  document.getElementById('sidebarEmail').textContent = userData.email;
  document.getElementById('sidebarRole').textContent = 'Seller';
  
  const planBadge = document.getElementById('planBadge');
  const userPlan = userData.subscriptionPlan || 'free';
  planBadge.textContent = userPlan.charAt(0).toUpperCase() + userPlan.slice(1);
  planBadge.className = `plan-badge ${userPlan}`;
}

function updateSubscriptionBanner() {
  const plan = PLAN_LIMITS[userData.subscriptionPlan];
  const pricing = PLAN_PRICING[userData.subscriptionPlan];
  
  document.getElementById('planTitle').textContent = userData.subscriptionPlan.charAt(0).toUpperCase() + userData.subscriptionPlan.slice(1) + ' Plan';
  document.getElementById('planDescription').textContent = 
    `Perfect for ${userData.subscriptionPlan === 'free' ? 'trying out' : userData.subscriptionPlan === 'basic' ? 'growing' : 'scaling'} your business`;
  
  const maxListings = plan.maxActiveListings === Infinity ? '‚àû' : plan.maxActiveListings;
  document.getElementById('planBadgeDetail').textContent = 
    `${userData.listings.active}/${maxListings} Active Listings`;
  
  const isTopTier = userData.subscriptionPlan === 'premium';
  const upgradeBtn = document.getElementById('btn-upgrade');
  if (upgradeBtn) {
    upgradeBtn.style.display = isTopTier ? 'none' : 'inline-block';
  }
}

function updateDashboardStats() {
  // Update stat cards if they exist
  const activeListingsEl = document.querySelector('[data-stat="active-listings"]');
  const totalViewsEl = document.querySelector('[data-stat="total-views"]');
  const inquiriesEl = document.querySelector('[data-stat="inquiries"]');
  const salesEl = document.querySelector('[data-stat="sales"]');
  
  if (activeListingsEl) activeListingsEl.textContent = userData.listings.active;
  if (totalViewsEl) totalViewsEl.textContent = userData.stats.totalViews || 0;
  if (inquiriesEl) inquiriesEl.textContent = userData.stats.inquiries || 0;
  if (salesEl) salesEl.textContent = userData.stats.sales || 0;
}

// ============================================
// RENDER SIDEBAR
// ============================================

function renderSidebar() {
  const nav = document.getElementById('sidebarNav');
  const plan = PLAN_LIMITS[userData.subscriptionPlan];
  
  nav.innerHTML = `
    <div class="nav-section">
      <div class="nav-section-title">Overview</div>
      <div class="nav-item active" onclick="navigateTo('dashboard')">
        <i class="fa-solid fa-house"></i>
        <span>Dashboard</span>
      </div>
      <div class="nav-item" onclick="navigateTo('listings')">
        <i class="fa-solid fa-list"></i>
        <span>My Listings</span>
      </div>
    </div>
    
    <div class="nav-section">
      <div class="nav-section-title">Insights</div>
      <div class="nav-item ${plan.analytics === 'none' ? 'locked' : ''}" onclick="navigateTo('analytics')">
        <i class="fa-solid fa-chart-line"></i>
        <span>Analytics</span>
        ${plan.analytics === 'none' ? '<i class="fa-solid fa-lock lock-icon"></i>' : ''}
      </div>
      <div class="nav-item" onclick="navigateTo('messages')">
        <i class="fa-solid fa-envelope"></i>
        <span>Messages</span>
      </div>
    </div>
    
    <div class="nav-section">
      <div class="nav-section-title">Account</div>
      <div class="nav-item" onclick="navigateTo('subscription')">
        <i class="fa-solid fa-crown"></i>
        <span>Subscription</span>
      </div>
      <div class="nav-item" onclick="navigateTo('settings')">
        <i class="fa-solid fa-gear"></i>
        <span>Settings</span>
      </div>
    </div>
  `;
}

// ============================================
// RENDER DASHBOARD CONTENT
// ============================================

function renderDashboardContent() {
  const container = document.getElementById('tabContainer');
  container.innerHTML = renderSellerDashboard();
  
  // Initialize chart if on overview tab
  setTimeout(() => {
    const overviewTab = document.getElementById('tab-dashboard');
    if (overviewTab && overviewTab.classList.contains('active')) {
      initializeChart();
    }
  }, 100);
}

function renderSellerDashboard() {
  const plan = PLAN_LIMITS[userData.subscriptionPlan];
  
  return `
    <!-- DASHBOARD TAB -->
    <div id="tab-dashboard" class="tab-content active">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-header">
            <div>
              <div class="stat-value" data-stat="active-listings">${userData.listings.active}</div>
              <div class="stat-label">Active Listings</div>
            </div>
            <div class="stat-icon primary">
              <i class="fa-solid fa-list"></i>
            </div>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-header">
            <div>
              <div class="stat-value" data-stat="total-views">${userData.stats.totalViews || 0}</div>
              <div class="stat-label">Total Views</div>
            </div>
            <div class="stat-icon secondary">
              <i class="fa-solid fa-eye"></i>
            </div>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-header">
            <div>
              <div class="stat-value" data-stat="inquiries">${userData.stats.inquiries || 0}</div>
              <div class="stat-label">Inquiries</div>
            </div>
            <div class="stat-icon accent">
              <i class="fa-solid fa-envelope"></i>
            </div>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-header">
            <div>
              <div class="stat-value" data-stat="sales">${userData.stats.sales || 0}</div>
              <div class="stat-label">Sales Made</div>
            </div>
            <div class="stat-icon success">
              <i class="fa-solid fa-dollar-sign"></i>
            </div>
          </div>
        </div>
      </div>
      
      <div class="content-card">
        <div class="card-header">
          <h3>Quick Actions</h3>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
          <button class="btn btn-primary" onclick="openAddListingModal()">
            <i class="fa-solid fa-plus"></i> Create Listing
          </button>
          <button class="btn btn-primary" onclick="navigateTo('listings')">
            <i class="fa-solid fa-list"></i> View My Listings
          </button>
          <button class="btn btn-primary" onclick="navigateTo('messages')">
            <i class="fa-solid fa-envelope"></i> Check Messages
          </button>
        </div>
      </div>
      
      ${renderRecentListings()}
      
      ${plan.analytics !== 'none' ? `
        <div class="content-card">
          <div class="card-header">
            <h3>Performance Overview</h3>
          </div>
          <div class="chart-container">
            <canvas id="performanceChart"></canvas>
          </div>
        </div>
      ` : ''}
    </div>
    
    <!-- LISTINGS TAB -->
    <div id="tab-listings" class="tab-content">
      ${renderListingsTab()}
    </div>
    
    <!-- ANALYTICS TAB -->
    <div id="tab-analytics" class="tab-content">
      ${renderAnalyticsTab()}
    </div>
    
<!-- OFFERS TAB -->
<div id="tab-offers" class="tab-content">
  ${renderOffersTab()}
</div>


    <!-- MESSAGES TAB -->
    <div id="tab-messages" class="tab-content">
      ${renderMessagesTab()}
    </div>
    
    <!-- SUBSCRIPTION TAB -->
    <div id="tab-subscription" class="tab-content">
      ${renderSubscriptionTab()}
    </div>
    
    <!-- SETTINGS TAB -->
    <div id="tab-settings" class="tab-content">
      ${renderSettingsTab()}
    </div>
  `;
}





// ============================================
// RECENT LISTINGS PREVIEW
// ============================================

function renderRecentListings() {
  if (userListings.length === 0) {
    return `
      <div class="content-card">
        <div class="card-header">
          <h3>Recent Listings</h3>
        </div>
        <div class="empty-state">
          <i class="fa-solid fa-inbox"></i>
          <p>No listings yet</p>
          <br>
          <button class="btn btn-primary" onclick="openAddListingModal()">
            <i class="fa-solid fa-plus"></i> Create Your First Listing
          </button>
        </div>
      </div>
    `;
  }
  
  const recentListings = userListings.slice(0, 3);
  
  return `
    <div class="content-card">
      <div class="card-header">
        <h3>Recent Listings</h3>
        <button class="card-action" onclick="navigateTo('listings')">View All</button>
      </div>
      <div style="display: grid; gap: 1rem;">
        ${recentListings.map(listing => `
          <div style="display: flex; gap: 1rem; padding: 1rem; background: var(--gray-light); border-radius: 10px; align-items: center;">
            <img src="${listing.mainImage || 'https://via.placeholder.com/80'}" 
                 alt="${listing.systemName}" 
                 style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;">
            <div style="flex: 1;">
              <h4 style="margin-bottom: 0.3rem;">${listing.systemName || 'Untitled'}</h4>
              <p style="color: var(--gray); font-size: 0.9rem; margin-bottom: 0.5rem;">${listing.categoryName || listing.category}</p>
              ${getStatusBadgeHTML(listing.status)}
            </div>
            <div style="text-align: right;">
              <div style="font-size: 1.2rem; font-weight: 700; color: var(--primary);">‚Ç±${parseInt(listing.askingPrice || 0).toLocaleString()}</div>
              <div style="font-size: 0.85rem; color: var(--gray);">${listing.views || 0} views</div>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

// ============================================
// LISTINGS TAB
// ============================================

function renderListingsTab() {
  if (userListings.length === 0) {
    return `
      <div class="content-card">
        <div class="card-header">
          <h3>My Listings</h3>
          <button class="card-action" onclick="openAddListingModal()">
            <i class="fa-solid fa-plus"></i> Create New Listing
          </button>
        </div>
        <div class="empty-state">
          <i class="fa-solid fa-inbox"></i>
          <p>You haven't created any listings yet</p>
          <br>
          <button class="btn btn-primary" onclick="openAddListingModal()">
            <i class="fa-solid fa-plus"></i> Create Your First Listing
          </button>
        </div>
      </div>
    `;
  }
  
  return `
    <div class="content-card">
      <div class="card-header">
        <h3>My Listings (${userListings.length})</h3>
        <button class="card-action" onclick="openAddListingModal()">
          <i class="fa-solid fa-plus"></i> Create New Listing
        </button>
      </div>
      
      <div style="overflow-x: auto;">
        <table class="listings-table">
          <thead>
            <tr>
              <th>Image</th>
              <th>System Name</th>
              <th>Price</th>
              <th>Category</th>
              <th>Status</th>
              <th>Views</th>
              <th>Inquiries</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${userListings.map(listing => `
              <tr>
                <td>
                  <img src="${listing.mainImage || 'https://via.placeholder.com/60'}" 
                       alt="${listing.systemName}" 
                       class="listing-image">
                </td>
                <td>
                  <strong>${listing.systemName || 'Untitled'}</strong>
                  <div style="font-size: 0.85rem; color: var(--gray);">${listing.shortDescription?.substring(0, 50) || ''}...</div>
                </td>
                <td>
                  <strong style="color: var(--primary);">‚Ç±${parseInt(listing.askingPrice || 0).toLocaleString()}</strong>
                </td>
                <td>${listing.categoryName || listing.category}</td>
                <td>${getStatusBadgeHTML(listing.status)}</td>
                <td>${listing.views || 0}</td>
                <td>${listing.inquiries || 0}</td>
                <td>
                  <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    ${canEditListing(listing) ? `
                      <button class="btn btn-secondary btn-edit" onclick="openEditListingModal('${listing.id}')" title="Edit">
                        <i class="fa-solid fa-edit"></i>
                      </button>
                    ` : ''}
                    
                    ${listing.status === 'active' || listing.status === 'approved' ? `
                      <button class="btn btn-secondary btn-view-public" onclick="viewPublicListing('${listing.id}')" title="View Public">
                        <i class="fa-solid fa-external-link"></i>
                      </button>
                    ` : ''}
                    
                    ${PLAN_LIMITS[userData.subscriptionPlan].canPromote && (listing.status === 'active' || listing.status === 'approved') ? `
                      <button class="btn btn-success btn-promote" onclick="openPromoteModal('${listing.id}')" title="Promote">
                        <i class="fa-solid fa-star"></i>
                      </button>
                    ` : ''}
                    
                    ${canMarkSold(listing) ? `
                      <button class="btn btn-success btn-mark-sold" onclick="markAsSold('${listing.id}')" title="Mark as Sold">
                        <i class="fa-solid fa-check"></i>
                      </button>
                    ` : ''}
                    
                    ${canDeleteListing(listing) ? `
                      <button class="btn btn-danger btn-delete" onclick="openDeleteModal('${listing.id}', '${listing.systemName}')" title="Delete">
                        <i class="fa-solid fa-trash"></i>
                      </button>
                    ` : ''}
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

// ============================================
// ANALYTICS TAB
// ============================================

function renderAnalyticsTab() {
  const plan = PLAN_LIMITS[userData.subscriptionPlan];
  
  if (plan.analytics === 'none') {
    return `
      <div class="content-card locked-feature">
        <div class="locked-overlay">
          <i class="fa-solid fa-lock"></i>
          <p>Analytics Dashboard</p>
          <p style="font-weight: 400; font-size: 0.9rem;">Available on Basic and Premium plans</p>
          <button class="unlock-btn" onclick="openUpgradeModal()">Upgrade to Unlock</button>
        </div>
        <div class="card-header">
          <h3>Analytics Dashboard</h3>
        </div>
        <div style="height: 300px; background: var(--gray-light); border-radius: 10px;"></div>
      </div>
    `;
  }
  
  return `
    <div class="content-card">
      <div class="card-header">
        <h3>Analytics Dashboard</h3>
        ${plan.analytics === 'advanced' ? `
          <button class="btn btn-secondary" onclick="exportAnalytics()">
            <i class="fa-solid fa-download"></i> Export CSV
          </button>
        ` : ''}
      </div>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value">${userData.stats.totalViews || 0}</div>
          <div class="stat-label">Total Views</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${Math.round((userData.stats.totalViews || 0) / (userData.listings.active || 1))}</div>
          <div class="stat-label">Avg. Views per Listing</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${userData.stats.inquiries || 0}</div>
          <div class="stat-label">Total Inquiries</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${Math.round(((userData.stats.inquiries || 0) / (userData.stats.totalViews || 1)) * 100)}%</div>
          <div class="stat-label">Conversion Rate</div>
        </div>
      </div>
      
      <div class="chart-container" style="margin-top: 2rem;">
        <canvas id="analyticsChart"></canvas>
      </div>
      
      ${plan.analytics === 'advanced' ? `
        <div style="margin-top: 2rem;">
          <h4 style="margin-bottom: 1rem;">Listing Performance</h4>
          <div style="overflow-x: auto;">
            <table class="listings-table">
              <thead>
                <tr>
                  <th>Listing Name</th>
                  <th>Views</th>
                  <th>Inquiries</th>
                  <th>Conversion</th>
                  <th>Days Active</th>
                </tr>
              </thead>
              <tbody>
                ${userListings.filter(l => l.status === 'active' || l.status === 'approved').map(listing => {
                  const daysActive = listing.createdAt ? 
                    Math.floor((new Date() - listing.createdAt.toDate()) / (1000 * 60 * 60 * 24)) : 0;
                  const conversion = listing.views ? ((listing.inquiries || 0) / listing.views * 100).toFixed(1) : 0;
                  
                  return `
                    <tr>
                      <td>${listing.systemName}</td>
                      <td>${listing.views || 0}</td>
                      <td>${listing.inquiries || 0}</td>
                      <td>${conversion}%</td>
                      <td>${daysActive} days</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>
      ` : ''}
    </div>
  `;
}

// ============================================
// MESSAGES TAB
// ============================================

function renderMessagesTab() {
  const plan = PLAN_LIMITS[userData.subscriptionPlan];
  
  if (!plan.canReceiveInquiries) {
    return `
      <div class="content-card locked-feature">
        <div class="locked-overlay">
          <i class="fa-solid fa-lock"></i>
          <p>Messages & Inquiries</p>
          <p style="font-weight: 400; font-size: 0.9rem;">Available on Basic and Premium plans</p>
          <button class="unlock-btn" onclick="openUpgradeModal()">Upgrade to Unlock</button>
        </div>
        <div class="card-header">
          <h3>Messages</h3>
        </div>
        <div style="height: 200px;"></div>
      </div>
    `;
  }
  
  return `
    <div class="content-card">
      <div class="card-header">
        <h3>Messages & Inquiries</h3>
      </div>
      <div class="empty-state">
        <i class="fa-solid fa-envelope"></i>
        <p>No messages yet</p>
        <p style="font-size: 0.9rem; color: var(--gray);">You'll receive notifications when buyers contact you</p>
      </div>
    </div>
  `;
}

// ============================================
// SUBSCRIPTION TAB
// ============================================

function renderSubscriptionTab() {
  const plan = PLAN_LIMITS[userData.subscriptionPlan];
  const pricing = PLAN_PRICING[userData.subscriptionPlan];
  
  return `
    <div class="content-card">
      <div class="card-header">
        <h3>Current Subscription</h3>
      </div>
      
      <div style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 2rem; border-radius: 15px; margin-bottom: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h3 style="color: white;">${userData.subscriptionPlan.charAt(0).toUpperCase() + userData.subscriptionPlan.slice(1)} Plan</h3>
          <span style="background: rgba(255,255,255,0.3); padding: 0.4rem 0.8rem; border-radius: 50px; font-size: 0.85rem;">Current Plan</span>
        </div>
        <div style="font-size: 2rem; font-weight: 900; margin-bottom: 1rem;">
          ${pricing.currency}${pricing.price}
          <span style="font-size: 1rem; font-weight: 500; opacity: 0.9;">/${pricing.billing}</span>
        </div>
        <ul style="list-style: none; margin-bottom: 1.5rem;">
          ${plan.features.map(f => `<li style="padding: 0.4rem 0;"><i class="fa-solid fa-check"></i> ${f}</li>`).join('')}
        </ul>
        ${userData.subscriptionPlan !== 'premium' ? `
          <button class="btn btn-primary" style="background: white; color: var(--primary); width: 100%;" onclick="openUpgradeModal()">
            Upgrade to ${userData.subscriptionPlan === 'free' ? 'Basic or Premium' : 'Premium'}
          </button>
        ` : ''}
      </div>
      
      <div style="background: var(--bg); padding: 1.5rem; border-radius: 15px;">
        <h4 style="margin-bottom: 1rem;">Usage Statistics</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
          <div>
            <div style="font-size: 0.85rem; color: var(--gray); margin-bottom: 0.3rem;">Active Listings</div>
            <div style="font-size: 1.5rem; font-weight: 700;">${userData.listings.active} / ${plan.maxActiveListings === Infinity ? '‚àû' : plan.maxActiveListings}</div>
          </div>
          <div>
            <div style="font-size: 0.85rem; color: var(--gray); margin-bottom: 0.3rem;">Total Views</div>
            <div style="font-size: 1.5rem; font-weight: 700;">${userData.stats.totalViews || 0}</div>
          </div>
          <div>
            <div style="font-size: 0.85rem; color: var(--gray); margin-bottom: 0.3rem;">Total Inquiries</div>
            <div style="font-size: 1.5rem; font-weight: 700;">${userData.stats.inquiries || 0}</div>
          </div>
        </div>
      </div>
    </div>
  `;
}

// ============================================
// SETTINGS TAB
// ============================================

function renderSettingsTab() {
  return `
    <div class="content-card">
      <div class="card-header">
        <h3>Account Settings</h3>
      </div>
      
      <form id="settingsForm" onsubmit="saveSettings(event)">
        <div class="form-group">
          <label class="form-label">Full Name</label>
          <input type="text" id="settingsName" class="form-input" value="${userData.name}">
        </div>
        
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" value="${userData.email}" disabled>
          <small style="color: var(--gray); font-size: 0.85rem;">Email cannot be changed</small>
        </div>
        
        <div class="form-group">
          <label class="form-label">Bio</label>
          <textarea id="settingsBio" class="form-textarea" placeholder="Tell buyers about yourself...">${userData.profile?.bio || ''}</textarea>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Company</label>
            <input type="text" id="settingsCompany" class="form-input" value="${userData.profile?.company || ''}">
          </div>
          
          <div class="form-group">
            <label class="form-label">Location</label>
            <input type="text" id="settingsLocation" class="form-input" value="${userData.profile?.location || ''}">
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Phone</label>
            <input type="tel" id="settingsPhone" class="form-input" value="${userData.profile?.phone || ''}">
          </div>
          
          <div class="form-group">
            <label class="form-label">Website</label>
            <input type="url" id="settingsWebsite" class="form-input" value="${userData.profile?.website || ''}" placeholder="https://">
          </div>
        </div>
        
        <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--gray-light);">
          <h4 style="margin-bottom: 1rem;">Email Notifications</h4>
          <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.8rem; cursor: pointer;">
            <input type="checkbox" id="notifyMessages" checked> New messages and inquiries
          </label>
          <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.8rem; cursor: pointer;">
            <input type="checkbox" id="notifySummary" checked> Weekly performance summary
          </label>
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="checkbox" id="notifyMarketing"> Marketing and promotions
          </label>
        </div>
        
        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
          <button type="submit" class="btn btn-primary">
            <i class="fa-solid fa-save"></i> Save Settings
          </button>
          <button type="button" class="btn btn-secondary" onclick="resetSettings()">
            <i class="fa-solid fa-undo"></i> Reset
          </button>
        </div>
      </form>
    </div>
  `;
}

// ============================================
// HELPER FUNCTIONS
// ============================================

function getStatusBadgeHTML(status) {
  const badges = {
    'pending': '<span class="status-badge status-pending">‚è≥ Under Review</span>',
    'active': '<span class="status-badge status-active">‚úì Active</span>',
    'approved': '<span class="status-badge status-approved">‚úì Approved</span>',
    'draft': '<span class="status-badge status-draft">üìù Draft</span>',
    'sold': '<span class="status-badge status-sold">üí∞ Sold</span>',
    'closed': '<span class="status-badge status-closed">üîí Closed</span>'
  };
  return badges[status] || badges['draft'];
}

function canEditListing(listing) {
  return ['draft', 'pending', 'active', 'approved'].includes(listing.status);
}

function canDeleteListing(listing) {
  if (listing.status === 'draft' || listing.status === 'pending') return true;
  if ((listing.status === 'active' || listing.status === 'approved') && (listing.inquiries || 0) === 0) return true;
  return false;
}

function canMarkSold(listing) {
  return (listing.status === 'active' || listing.status === 'approved') && listing.status !== 'sold';
}

// ============================================
// NAVIGATION
// ============================================

window.navigateTo = function(page) {
  const plan = PLAN_LIMITS[userData.subscriptionPlan];
  
  // Check if feature is locked
  if (page === 'analytics' && plan.analytics === 'none') {
    openUpgradeModal();
    return;
  }
  
  // Update sidebar navigation
  document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
  event?.target.closest('.nav-item')?.classList.add('active');
  
  // Update page title
  const pageTitles = {
    dashboard: 'Dashboard',
    listings: 'My Listings',
    analytics: 'Analytics',
    messages: 'Messages',
    subscription: 'Subscription',
    settings: 'Settings'
  };
  
  document.getElementById('pageTitle').textContent = pageTitles[page] || 'Dashboard';
  
  // Show the correct tab content
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });
  
  const selectedTab = document.getElementById(`tab-${page}`);
  if (selectedTab) {
    selectedTab.classList.add('active');
    
    // Initialize chart if analytics tab
    if (page === 'analytics' && plan.analytics !== 'none') {
      setTimeout(() => initializeAnalyticsChart(), 100);
    }
  }
}

// ============================================
// ADD/EDIT LISTING MODAL
// ============================================

window.openAddListingModal = function() {
  const plan = PLAN_LIMITS[userData.subscriptionPlan];
  
  // Check listing limit
  if (userData.listings.active >= plan.maxActiveListings) {
    showToast(`You've reached your listing limit (${plan.maxActiveListings}). Upgrade to create more listings.`, 'error');
    openUpgradeModal();
    return;
  }
  
  // Reset form
  document.getElementById('listingForm').reset();
  document.getElementById('listingId').value = '';
  document.getElementById('listingModalTitle').textContent = 'Create New Listing';
  
  // Show modal
  document.getElementById('listingModal').classList.add('active');
}

window.openEditListingModal = function(listingId) {
  const listing = userListings.find(l => l.id === listingId);
  
  if (!listing) {
    showToast('Listing not found', 'error');
    return;
  }
  
  if (!canEditListing(listing)) {
    showToast('This listing cannot be edited', 'error');
    return;
  }
  
  // Populate form
  document.getElementById('listingId').value = listing.id;
  document.getElementById('systemName').value = listing.systemName || '';
  document.getElementById('category').value = listing.category || '';
  document.getElementById('shortDescription').value = listing.shortDescription || '';
  document.getElementById('detailedDescription').value = listing.detailedDescription || '';
  document.getElementById('askingPrice').value = listing.askingPrice || '';
  document.getElementById('monthlyRevenue').value = listing.monthlyRevenue || '';
  document.getElementById('mrr').value = listing.mrr || '';
  document.getElementById('activeSubscribers').value = listing.activeSubscribers || '';
  document.getElementById('churnRate').value = listing.churnRate || '';
  document.getElementById('pricingModel').value = listing.pricingModel || '';
  document.getElementById('saasType').value = listing.saasType || '';
  document.getElementById('mainImage').value = listing.mainImage || '';
  
  // Handle additional images
  if (listing.images && Array.isArray(listing.images)) {
    document.getElementById('additionalImages').value = listing.images.join(', ');
  }
  
  document.getElementById('listingModalTitle').textContent = 'Edit Listing';
  document.getElementById('listingModal').classList.add('active');
}

window.closeListingModal = function() {
  document.getElementById('listingModal').classList.remove('active');
}

// ============================================
// SAVE LISTING (CREATE/UPDATE)
// ============================================

window.saveListing = async function(status) {
  const listingId = document.getElementById('listingId').value;
  const isEditing = !!listingId;
  
  // Validate form
  const systemName = document.getElementById('systemName').value.trim();
  const category = document.getElementById('category').value;
  const shortDescription = document.getElementById('shortDescription').value.trim();
  const detailedDescription = document.getElementById('detailedDescription').value.trim();
  const askingPrice = document.getElementById('askingPrice').value;
  const mainImage = document.getElementById('mainImage').value.trim();
  
  if (!systemName || !category || !shortDescription || !detailedDescription || !askingPrice || !mainImage) {
    showToast('Please fill in all required fields', 'error');
    return;
  }
  
  // Check listing limit for new listings
  if (!isEditing && status !== 'draft') {
    const plan = PLAN_LIMITS[userData.subscriptionPlan];
    if (userData.listings.active >= plan.maxActiveListings) {
      showToast(`You've reached your listing limit (${plan.maxActiveListings})`, 'error');
      return;
    }
  }
  
  // Prepare listing data
  const categoryNames = {
    'saas': 'SaaS Business',
    'ecommerce': 'E-commerce Store',
    'content': 'Content Site',
    'mobile': 'Mobile App',
    'script': 'Script/Code',
    'other': 'Other'
  };
  
  const additionalImagesText = document.getElementById('additionalImages').value.trim();
  const images = additionalImagesText ? 
    additionalImagesText.split(',').map(url => url.trim()).filter(url => url) : [];
  
  const listingData = {
    systemName,
    category,
    categoryName: categoryNames[category] || category,
    shortDescription,
    detailedDescription,
    askingPrice: parseInt(askingPrice),
    monthlyRevenue: parseInt(document.getElementById('monthlyRevenue').value) || 0,
    mrr: parseInt(document.getElementById('mrr').value) || 0,
    activeSubscribers: parseInt(document.getElementById('activeSubscribers').value) || 0,
    churnRate: parseInt(document.getElementById('churnRate').value) || 0,
    pricingModel: document.getElementById('pricingModel').value || '',
    saasType: document.getElementById('saasType').value || '',
    mainImage,
    images,
    status,
    updatedAt: serverTimestamp()
  };
  
  // Disable buttons
  const saveBtn = document.getElementById('save-draft');
  const publishBtn = document.getElementById('publish');
  saveBtn.disabled = true;
  publishBtn.disabled = true;
  
  try {
    if (isEditing) {
      // Update existing listing
      const listingRef = doc(db, 'listings', listingId);
      await updateDoc(listingRef, listingData);
      
      showToast('Listing updated successfully!', 'success');
    } else {
      // Create new listing
      const newListingData = {
        ...listingData,
        userId: userData.id,
        userName: userData.name,
        userEmail: userData.email,
        views: 0,
        inquiries: 0,
        createdAt: serverTimestamp()
      };
      
      await addDoc(collection(db, 'listings'), newListingData);
      
      // Update user document with transaction
      await runTransaction(db, async (transaction) => {
        const userRef = doc(db, 'users', userData.id);
        const userDoc = await transaction.get(userRef);
        
        if (userDoc.exists()) {
          const currentStats = userDoc.data().listings || { active: 0, total: 0 };
          transaction.update(userRef, {
            'listings.total': increment(1),
            'listings.active': status !== 'draft' ? increment(1) : currentStats.active,
            updatedAt: serverTimestamp()
          });
        }
      });
      
      showToast('Listing created successfully!', 'success');
    }
    
    closeListingModal();
    
    // Update local data
    userData.listings.total = userListings.length;
    updateSubscriptionBanner();
    
  } catch (error) {
    console.error('Error saving listing:', error);
    showToast('Failed to save listing. Please try again.', 'error');
  } finally {
    saveBtn.disabled = false;
    publishBtn.disabled = false;
  }
}

// ============================================
// DELETE LISTING
// ============================================

window.openDeleteModal = function(listingId, listingName) {
  deleteListingId = listingId;
  document.getElementById('deleteListingName').textContent = listingName;
  document.getElementById('deleteModal').classList.add('active');
}

window.closeDeleteModal = function() {
  deleteListingId = null;
  document.getElementById('deleteModal').classList.remove('active');
}

window.confirmDelete = async function() {
  if (!deleteListingId) return;
  
  const listing = userListings.find(l => l.id === deleteListingId);
  
  if (!listing) {
    showToast('Listing not found', 'error');
    closeDeleteModal();
    return;
  }
  
  if (!canDeleteListing(listing)) {
    showToast('This listing cannot be deleted. It may have active inquiries.', 'error');
    closeDeleteModal();
    return;
  }
  
  try {
    // Delete listing
    await deleteDoc(doc(db, 'listings', deleteListingId));
    
    // Update user stats with transaction
    await runTransaction(db, async (transaction) => {
      const userRef = doc(db, 'users', userData.id);
      const userDoc = await transaction.get(userRef);
      
      if (userDoc.exists()) {
        const wasActive = ['active', 'approved', 'pending'].includes(listing.status);
        transaction.update(userRef, {
          'listings.total': increment(-1),
          'listings.active': wasActive ? increment(-1) : userDoc.data().listings?.active || 0,
          updatedAt: serverTimestamp()
        });
      }
    });
    
    showToast('Listing deleted successfully!', 'success');
    closeDeleteModal();
    
    // Update local data
    userData.listings.total = Math.max(0, userData.listings.total - 1);
    userData.listings.active = Math.max(0, userData.listings.active - 1);
    updateSubscriptionBanner();
    
  } catch (error) {
    console.error('Error deleting listing:', error);
    showToast('Failed to delete listing. Please try again.', 'error');
  }
}

// ============================================
// MARK AS SOLD
// ============================================

window.markAsSold = async function(listingId) {
  if (!confirm('Mark this listing as sold? This will update your sales count.')) {
    return;
  }
  
  const listing = userListings.find(l => l.id === listingId);
  
  if (!listing) {
    showToast('Listing not found', 'error');
    return;
  }
  
  try {
    // Update listing status
    await updateDoc(doc(db, 'listings', listingId), {
      status: 'sold',
      soldAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    });
    
    // Update user stats with transaction
    await runTransaction(db, async (transaction) => {
      const userRef = doc(db, 'users', userData.id);
      const userDoc = await transaction.get(userRef);
      
      if (userDoc.exists()) {
        transaction.update(userRef, {
          'stats.sales': increment(1),
          'listings.active': increment(-1),
          updatedAt: serverTimestamp()
        });
      }
    });
    
    showToast('Listing marked as sold! Congratulations! üéâ', 'success');
    
    // Update local data
    userData.stats.sales = (userData.stats.sales || 0) + 1;
    userData.listings.active = Math.max(0, userData.listings.active - 1);
    updateDashboardStats();
    updateSubscriptionBanner();
    
  } catch (error) {
    console.error('Error marking as sold:', error);
    showToast('Failed to mark as sold. Please try again.', 'error');
  }
}

// ============================================
// VIEW PUBLIC LISTING
// ============================================

window.viewPublicListing = function(listingId) {
  window.open(`listing-detail.html?id=${listingId}`, '_blank');
}

// ============================================
// PROMOTE MODAL
// ============================================

window.openPromoteModal = function(listingId) {
  const plan = PLAN_LIMITS[userData.subscriptionPlan];
  
  if (!plan.canPromote) {
    showToast('Promotion is available on Basic and Premium plans', 'error');
    openUpgradeModal();
    return;
  }
  
  // Store listing ID for promotion
  document.getElementById('promoteModal').dataset.listingId = listingId;
  document.getElementById('promoteModal').classList.add('active');
}

window.closePromoteModal = function() {
  document.getElementById('promoteModal').classList.remove('active');
}

window.handlePromotePayment = function() {
  showToast('Payment integration coming soon!', 'info');
  closePromoteModal();
}

// ============================================
// UPGRADE MODAL
// ============================================

window.openUpgradeModal = function() {
  const currentPlan = PLAN_LIMITS[userData.subscriptionPlan];
  const currentPricing = PLAN_PRICING[userData.subscriptionPlan];
  
  document.getElementById('modalCurrentPlan').innerHTML = `
    <strong>${userData.subscriptionPlan.charAt(0).toUpperCase() + userData.subscriptionPlan.slice(1)} Plan</strong> - 
    ${currentPricing.currency}${currentPricing.price}/${currentPricing.billing}
  `;
  
  const upgradeOptions = document.getElementById('upgradeOptions');
  upgradeOptions.innerHTML = '';
  
  // Get available upgrades
  const availablePlans = [];
  
  if (userData.subscriptionPlan === 'free') {
    availablePlans.push(['basic', PLAN_LIMITS.basic, PLAN_PRICING.basic]);
    availablePlans.push(['premium', PLAN_LIMITS.premium, PLAN_PRICING.premium]);
  } else if (userData.subscriptionPlan === 'basic') {
    availablePlans.push(['premium', PLAN_LIMITS.premium, PLAN_PRICING.premium]);
  }
  
  availablePlans.forEach(([key, plan, pricing]) => {
    const optionHTML = `
      <div style="border: 2px solid var(--gray-light); padding: 1.5rem; border-radius: 15px; transition: all 0.3s; cursor: pointer;" 
           onmouseenter="this.style.borderColor='var(--primary)'" 
           onmouseleave="this.style.borderColor='var(--gray-light)'"
           onclick="handleUpgrade('${key}')">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <div style="font-size: 1.3rem; font-weight: 700;">${key.charAt(0).toUpperCase() + key.slice(1)} Plan</div>
          <div style="font-size: 1.5rem; font-weight: 900; color: var(--primary);">
            ${pricing.currency}${pricing.price}<span style="font-size: 1rem; font-weight: 400;">/${pricing.billing}</span>
          </div>
        </div>
        <ul style="list-style: none; margin-bottom: 1rem;">
          ${plan.features.map(f => `<li style="padding: 0.4rem 0; display: flex; align-items: center; gap: 0.5rem;"><i class="fa-solid fa-check" style="color: var(--success);"></i> ${f}</li>`).join('')}
        </ul>
        <button class="btn btn-primary" style="width: 100%;">
          Upgrade to ${key.charAt(0).toUpperCase() + key.slice(1)}
        </button>
      </div>
    `;
    upgradeOptions.innerHTML += optionHTML;
  });
  
  document.getElementById('upgradeModal').classList.add('active');
}

window.closeUpgradeModal = function() {
  document.getElementById('upgradeModal').classList.remove('active');
}


window.handleUpgrade = async function(planKey) {
  // REMOVE the automatic upgrade simulation
  // In production, redirect to payment gateway
  
  const pricing = PLAN_PRICING[planKey];
  
  showToast('Redirecting to payment gateway...', 'info');
  
  // Store intended plan in sessionStorage
  sessionStorage.setItem('pendingPlanUpgrade', planKey);
  sessionStorage.setItem('pendingUserId', userData.id);
  
  // Redirect to payment page (replace with your actual payment URL)
  // For PayMongo:
  // window.location.href = `payment.html?plan=${planKey}&amount=${pricing.price}`;
  
  // For Stripe:
  // window.location.href = `https://buy.stripe.com/${planKey}-plan`;
  
  // TEMPORARY: Show alert that payment is needed
  alert(`To upgrade to ${planKey} plan (‚Ç±${pricing.price}/month), please contact support@systemly.com or complete payment integration.`);
  closeUpgradeModal();
}



// Call this function when payment is confirmed (from payment gateway webhook)
async function confirmPlanUpgrade(userId, newPlan, transactionId) {
  try {
    await updateDoc(doc(db, 'users', userId), {
      subscriptionPlan: newPlan,
      subscriptionStatus: 'active',
      subscriptionStartDate: serverTimestamp(),
      lastPaymentId: transactionId,
      updatedAt: serverTimestamp()
    });
    
    console.log('‚úÖ Plan upgraded successfully:', newPlan);
    return true;
  } catch (error) {
    console.error('‚ùå Error upgrading plan:', error);
    return false;
  }
}














// ============================================
// SETTINGS
// ============================================

window.saveSettings = async function(event) {
  event.preventDefault();
  
  const name = document.getElementById('settingsName').value.trim();
  const bio = document.getElementById('settingsBio').value.trim();
  const company = document.getElementById('settingsCompany').value.trim();
  const location = document.getElementById('settingsLocation').value.trim();
  const phone = document.getElementById('settingsPhone').value.trim();
  const website = document.getElementById('settingsWebsite').value.trim();
  
  try {
    await updateDoc(doc(db, 'users', userData.id), {
      name,
      'profile.bio': bio,
      'profile.company': company,
      'profile.location': location,
      'profile.phone': phone,
      'profile.website': website,
      updatedAt: serverTimestamp()
    });
    
    // Update local data
    userData.name = name;
    userData.profile = { ...userData.profile, bio, company, location, phone, website };
    
    updateUserProfile();
    showToast('Settings saved successfully!', 'success');
    
  } catch (error) {
    console.error('Error saving settings:', error);
    showToast('Failed to save settings. Please try again.', 'error');
  }
}

window.resetSettings = function() {
  document.getElementById('settingsName').value = userData.name;
  document.getElementById('settingsBio').value = userData.profile?.bio || '';
  document.getElementById('settingsCompany').value = userData.profile?.company || '';
  document.getElementById('settingsLocation').value = userData.profile?.location || '';
  document.getElementById('settingsPhone').value = userData.profile?.phone || '';
  document.getElementById('settingsWebsite').value = userData.profile?.website || '';
  
  showToast('Settings reset', 'info');
}

// ============================================
// EXPORT ANALYTICS
// ============================================

window.exportAnalytics = function() {
  const plan = PLAN_LIMITS[userData.subscriptionPlan];
  
  if (plan.analytics !== 'advanced') {
    showToast('CSV export is available on Premium plan', 'error');
    return;
  }
  
  // Create CSV content
  let csvContent = 'Listing Name,Views,Inquiries,Conversion Rate,Days Active,Status,Price\n';
  
  userListings.forEach(listing => {
    const daysActive = listing.createdAt ? 
      Math.floor((new Date() - listing.createdAt.toDate()) / (1000 * 60 * 60 * 24)) : 0;
    const conversion = listing.views ? ((listing.inquiries || 0) / listing.views * 100).toFixed(1) : 0;
    
    csvContent += `"${listing.systemName}",${listing.views || 0},${listing.inquiries || 0},${conversion}%,${daysActive},${listing.status},‚Ç±${listing.askingPrice}\n`;
  });
  
  // Download CSV
  const blob = new Blob([csvContent], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `systemly-analytics-${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  window.URL.revokeObjectURL(url);
  
  showToast('Analytics exported successfully!', 'success');
}

// ============================================
// CHART INITIALIZATION
// ============================================

function initializeChart() {
  const canvas = document.getElementById('performanceChart');
  if (!canvas) {
    console.log('‚ö†Ô∏è Performance chart canvas not found');
    return;
  }
  
  const ctx = canvas.getContext('2d');
  
  // Destroy existing chart
  if (currentChart) {
    currentChart.destroy();
  }
  
  // GET REAL DATA FROM LISTINGS
  // Calculate daily views and inquiries from last 7 days
  const today = new Date();
  const last7Days = [];
  const viewsData = [];
  const inquiriesData = [];
  
  for (let i = 6; i >= 0; i--) {
    const date = new Date(today);
    date.setDate(date.getDate() - i);
    const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
    last7Days.push(dayName);
    
    // In a real implementation, you'd track daily stats in Firestore
    // For now, we'll distribute total views/inquiries across days
    const avgViews = Math.floor((userData.stats.totalViews || 0) / 7);
    const avgInquiries = Math.floor((userData.stats.inquiries || 0) / 7);
    
    // Add some variance to make it look more realistic
    const variance = Math.random() * 0.4 + 0.8; // 0.8 to 1.2
    viewsData.push(Math.floor(avgViews * variance));
    inquiriesData.push(Math.floor(avgInquiries * variance));
  }
  
  console.log('üìä Chart data - Views:', viewsData, 'Inquiries:', inquiriesData);
  
  // If no data, show message
  if (viewsData.every(v => v === 0) && inquiriesData.every(i => i === 0)) {
    const chartContainer = canvas.parentElement;
    chartContainer.innerHTML = `
      <div class="empty-state" style="padding: 2rem;">
        <i class="fa-solid fa-chart-line"></i>
        <p>No performance data yet</p>
        <p style="font-size: 0.9rem; color: var(--gray);">Data will appear once your listings start getting views and inquiries</p>
      </div>
    `;
    return;
  }
  
  currentChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: last7Days,
      datasets: [
        {
          label: 'Views',
          data: viewsData,
          borderColor: 'rgb(249, 115, 22)',
          backgroundColor: 'rgba(249, 115, 22, 0.1)',
          tension: 0.4,
          fill: true
        },
        {
          label: 'Inquiries',
          data: inquiriesData,
          borderColor: 'rgb(99, 102, 241)',
          backgroundColor: 'rgba(99, 102, 241, 0.1)',
          tension: 0.4,
          fill: true
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'top',
        },
        title: {
          display: true,
          text: 'Weekly Performance (Last 7 Days)'
        },
        tooltip: {
          callbacks: {
            footer: function(context) {
              return 'Note: Data distributed from total stats';
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1,
            callback: function(value) {
              return Math.floor(value); // Show only integers
            }
          }
        }
      }
    }
  });
}

function initializeAnalyticsChart() {
  const canvas = document.getElementById('analyticsChart');
  if (!canvas) {
    console.log('‚ö†Ô∏è Analytics chart canvas not found');
    return;
  }
  
  const ctx = canvas.getContext('2d');
  
  // Destroy existing chart
  if (currentChart) {
    currentChart.destroy();
  }
  
  // GET REAL DATA FROM ACTUAL LISTINGS
  if (userListings.length === 0) {
    const chartContainer = canvas.parentElement;
    chartContainer.innerHTML = `
      <div class="empty-state" style="padding: 2rem;">
        <i class="fa-solid fa-chart-bar"></i>
        <p>No listings to analyze</p>
        <p style="font-size: 0.9rem; color: var(--gray);">Create listings to see performance analytics</p>
      </div>
    `;
    return;
  }
  
  // Get top 5 listings by views
  const topListings = [...userListings]
    .filter(l => l.status === 'active' || l.status === 'approved')
    .sort((a, b) => (b.views || 0) - (a.views || 0))
    .slice(0, 5);
  
  if (topListings.length === 0) {
    const chartContainer = canvas.parentElement;
    chartContainer.innerHTML = `
      <div class="empty-state" style="padding: 2rem;">
        <i class="fa-solid fa-chart-bar"></i>
        <p>No active listings yet</p>
        <p style="font-size: 0.9rem; color: var(--gray);">Publish listings to see analytics</p>
      </div>
    `;
    return;
  }
  
  const listingNames = topListings.map(l => {
    const name = l.systemName || 'Untitled';
    return name.length > 20 ? name.substring(0, 20) + '...' : name;
  });
  const viewsData = topListings.map(l => l.views || 0);
  const inquiriesData = topListings.map(l => l.inquiries || 0);
  
  console.log('üìä Analytics Chart - Listings:', listingNames);
  console.log('üìä Views:', viewsData, 'Inquiries:', inquiriesData);
  
  currentChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: listingNames,
      datasets: [
        {
          label: 'Views',
          data: viewsData,
          backgroundColor: 'rgba(249, 115, 22, 0.7)',
          borderColor: 'rgb(249, 115, 22)',
          borderWidth: 2
        },
        {
          label: 'Inquiries',
          data: inquiriesData,
          backgroundColor: 'rgba(99, 102, 241, 0.7)',
          borderColor: 'rgb(99, 102, 241)',
          borderWidth: 2
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'top',
        },
        title: {
          display: true,
          text: 'Top Listings Performance (Real Data)'
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1,
            callback: function(value) {
              return Math.floor(value);
            }
          }
        }
      }
    }
  });
}


// ============================================
// TOAST NOTIFICATIONS
// ============================================

function showToast(message, type = 'info') {
  // Remove existing toasts
  document.querySelectorAll('.toast').forEach(t => t.remove());
  
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  
  const icon = type === 'success' ? 'fa-check-circle' : 
               type === 'error' ? 'fa-exclamation-circle' : 
               type === 'info' ? 'fa-info-circle' : 'fa-bell';
  
  toast.innerHTML = `
    <i class="fa-solid ${icon}" style="font-size: 1.5rem;"></i>
    <div>
      <strong>${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
      <div style="font-size: 0.9rem;">${message}</div>
    </div>
  `;
  
  document.body.appendChild(toast);
  
  // Auto remove after 4 seconds
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease-out forwards';
    setTimeout(() => toast.remove(), 300);
  }, 4000);
}

// Add slideOut animation
const style = document.createElement('style');
style.textContent = `
  @keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(400px); opacity: 0; }
  }
`;
document.head.appendChild(style);

// ============================================
// LOGOUT
// ============================================

window.logout = async function() {
  if (confirm('Are you sure you want to sign out?')) {
    try {
      // Unsubscribe from listeners
      if (listingsUnsubscribe) {
        listingsUnsubscribe();
      }
      
      await signOut(auth);
      window.location.href = 'index.html';
    } catch (error) {
      console.error('Error signing out:', error);
      showToast('Failed to sign out. Please try again.', 'error');
    }
  }
}

// ============================================
// CLEANUP ON PAGE UNLOAD
// ============================================

window.addEventListener('beforeunload', () => {
  if (listingsUnsubscribe) {
    listingsUnsubscribe();
  }
  if (currentChart) {
    currentChart.destroy();
  }
});




// ============================================
// OFFERS TAB
// ============================================

function renderOffersTab() {
  return `
    <div class="content-card">
      <div class="card-header">
        <h3>Buyer Offers</h3>
        <button class="btn btn-secondary" onclick="loadSellerOffers()">
          <i class="fa-solid fa-sync"></i> Refresh
        </button>
      </div>
      <div id="offersContent">
        <div class="loading">Loading offers...</div>
      </div>
    </div>
  `;
}

async function loadSellerOffers() {
  if (!userData) return;

  const offersContent = document.getElementById('offersContent');
  offersContent.innerHTML = '<div class="spinner"></div>';

  try {
    const response = await fetch(`${API_URL}/api/offers/seller/${userData.id}`);
    const data = await response.json();

    if (data.offers.length === 0) {
      offersContent.innerHTML = '<p>No offers yet</p>';
      return;
    }

    // Update badge
    const pendingCount = data.offers.filter(o => o.status === 'pending').length;
    const badge = document.getElementById('offersCountBadge');
    if (badge && pendingCount > 0) {
      badge.textContent = pendingCount;
      badge.style.display = 'inline-block';
    }

    offersContent.innerHTML = `
      <table class="listings-table">
        <thead>
          <tr>
            <th>Listing</th>
            <th>Buyer</th>
            <th>Offer</th>
            <th>Message</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${data.offers.map(o => `
            <tr>
              <td><strong>${o.listing_name}</strong></td>
              <td>
                ${o.buyer_name}<br>
                <small style="color: var(--gray);">${o.buyer_email}</small>
              </td>
              <td><strong style="color: var(--primary);">‚Ç±${parseInt(o.offer_amount).toLocaleString()}</strong></td>
              <td>${o.message || 'No message'}</td>
              <td><span class="status-badge status-${o.status}">${o.status.toUpperCase()}</span></td>
              <td>
                ${o.status === 'pending' ? `
                  <button class="btn btn-success" onclick="acceptOffer(${o.id})">Accept</button>
                  <button class="btn btn-danger" onclick="rejectOffer(${o.id})">Reject</button>
                ` : 'No actions'}
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  } catch (error) {
    console.error('‚ùå Error:', error);
    offersContent.innerHTML = '<p class="alert alert-error">Failed to load offers</p>';
  }
}

window.acceptOffer = async function(offerId) {
  if (!confirm('Accept this offer?')) return;

  try {
    const response = await fetch(`${API_URL}/api/offers/${offerId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: 'accepted' })
    });

    if (response.ok) {
      showToast('‚úì Offer accepted!', 'success');
      loadSellerOffers();
    }
  } catch (error) {
    showToast('Failed to accept offer', 'error');
  }
}

window.rejectOffer = async function(offerId) {
  if (!confirm('Reject this offer?')) return;

  try {
    const response = await fetch(`${API_URL}/api/offers/${offerId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: 'rejected' })
    });

    if (response.ok) {
      showToast('Offer rejected', 'info');
      loadSellerOffers();
    }
  } catch (error) {
    showToast('Failed to reject offer', 'error');
  }
}

// Load offers when navigating to offers tab
const originalNavigateTo = window.navigateTo;
window.navigateTo = function(page) {
  originalNavigateTo(page);
  if (page === 'offers') {
    setTimeout(loadSellerOffers, 100);
  }
}

console.log('‚úÖ Offers system loaded');









console.log('üöÄ Systemly Seller Dashboard - Complete Version Loaded');
</script>

</body>
</html>
