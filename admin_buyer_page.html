<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Buyer Dashboard - Systemly</title>
<link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;600;700;900&family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous">

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --primary: #F97316;
  --secondary: #6366F1;
  --accent: #14B8A6;
  --bg: #FFF7ED;
  --text: #1F2937;
  --white: #FFFFFF;
  --gray-light: #F3F4F6;
  --gray: #6B7280;
  --gray-dark: #374151;
  --success: #10B981;
  --warning: #F59E0B;
  --error: #EF4444;
  --info: #3B82F6;
}

body {
  font-family: 'Sarabun', sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  opacity: 0;
  transition: opacity 0.3s;
}

body.loaded { opacity: 1; }

h1,h2,h3,h4,h5,h6 { font-family: 'Archivo', sans-serif; }

/* Loading Screen */
.loading-screen {
  position: fixed;
  inset: 0;
  background: linear-gradient(135deg, #FFF7ED 0%, #FFEDD5 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 1rem;
  z-index: 9999;
  opacity: 1;
  transition: opacity 0.3s;
}

.loading-screen.hidden {
  opacity: 0;
  pointer-events: none;
}

.loading-content {
  background: white;
  padding: 3rem;
  border-radius: 20px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.1);
  max-width: 500px;
  width: 90%;
  text-align: center;
}

#loadingText {
  font-size: 1.2rem;
  font-weight: 600;
  color: var(--text);
  margin: 1rem 0;
}

#loadingSteps {
  margin-top: 1.5rem;
  text-align: left;
}

.loader {
  width: 50px;
  height: 50px;
  border: 4px solid var(--gray-light);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin: 0 auto;
}

@keyframes spin { to { transform: rotate(360deg); } }

/* Dashboard Layout */
.dashboard-layout {
  display: grid;
  grid-template-columns: 280px 1fr;
  min-height: 100vh;
}

.sidebar {
  background: var(--white);
  border-right: 1px solid var(--gray-light);
  position: sticky;
  top: 0;
  height: 100vh;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

.sidebar-header {
  padding: 2rem 1.5rem;
  border-bottom: 1px solid var(--gray-light);
}

.logo {
  font-family: 'Archivo', sans-serif;
  font-size: 2rem;
  font-weight: 900;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-decoration: none;
  display: block;
}

.user-profile {
  padding: 1.5rem;
  border-bottom: 1px solid var(--gray-light);
}

.user-profile-content {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1rem;
}

.user-avatar {
  width: 50px;
  height: 50px;
  min-width: 50px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--secondary), var(--accent));
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--white);
  font-weight: 700;
  font-size: 1.2rem;
  flex-shrink: 0;
}

.user-details {
  flex: 1;
  min-width: 0;
}

.user-name {
  font-weight: 600;
  font-size: 1rem;
  margin-bottom: 0.2rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.user-email {
  font-size: 0.85rem;
  color: var(--gray);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.role-badge {
  padding: 0.4rem 0.8rem;
  border-radius: 50px;
  font-size: 0.85rem;
  font-weight: 600;
  background: linear-gradient(135deg, var(--secondary), var(--accent));
  color: var(--white);
  display: inline-block;
}

.sidebar-nav {
  flex: 1;
  padding: 1rem 0;
}

.nav-section {
  margin-bottom: 1.5rem;
}

.nav-section-title {
  padding: 0.5rem 1.5rem;
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--gray);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 0.8rem;
  padding: 0.8rem 1.5rem;
  color: var(--text);
  text-decoration: none;
  transition: all 0.2s;
  position: relative;
  cursor: pointer;
}

.nav-item:hover {
  background: var(--bg);
  color: var(--secondary);
}

.nav-item.active {
  background: linear-gradient(to right, rgba(99, 102, 241, 0.1), transparent);
  color: var(--secondary);
  font-weight: 600;
}

.nav-item.active::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 4px;
  background: linear-gradient(180deg, var(--secondary), var(--accent));
}

.nav-item i {
  width: 20px;
  text-align: center;
  font-size: 1.1rem;
}

.nav-item .badge {
  margin-left: auto;
  background: var(--error);
  color: white;
  padding: 0.2rem 0.5rem;
  border-radius: 50px;
  font-size: 0.75rem;
  font-weight: 700;
}

.sidebar-footer {
  padding: 1.5rem;
  border-top: 1px solid var(--gray-light);
}

.logout-btn {
  width: 100%;
  padding: 0.8rem;
  background: var(--error);
  color: var(--white);
  border: none;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  font-family: 'Sarabun', sans-serif;
  font-size: 1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

.logout-btn:hover {
  background: #dc2626;
  transform: translateY(-2px);
}

/* Main Content */
.main-content {
  overflow-y: auto;
  height: 100vh;
}

.top-bar {
  background: var(--white);
  padding: 1.5rem 2rem;
  border-bottom: 1px solid var(--gray-light);
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 100;
}

.page-title {
  font-size: 1.8rem;
  font-weight: 900;
}

.top-bar-actions {
  display: flex;
  gap: 1rem;
  align-items: center;
}

.content-area {
  padding: 2rem;
}

/* Tab Content */
.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
  animation: fadeIn 0.4s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.stat-card {
  background: var(--white);
  padding: 2rem;
  border-radius: 15px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.06);
  transition: transform 0.3s;
}

.stat-card:hover { transform: translateY(-5px); }

.stat-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.stat-icon {
  width: 50px;
  height: 50px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
}

.stat-icon.primary {
  background: rgba(249, 115, 22, 0.1);
  color: var(--primary);
}

.stat-icon.secondary {
  background: rgba(99, 102, 241, 0.1);
  color: var(--secondary);
}

.stat-icon.accent {
  background: rgba(20, 184, 166, 0.1);
  color: var(--accent);
}

.stat-icon.success {
  background: rgba(16, 185, 129, 0.1);
  color: var(--success);
}

.stat-value {
  font-size: 2rem;
  font-weight: 900;
  color: var(--text);
  margin-bottom: 0.3rem;
}

.stat-label {
  color: var(--gray);
  font-size: 0.9rem;
}

/* Content Cards */
.content-card {
  background: var(--white);
  padding: 2rem;
  border-radius: 15px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.06);
  margin-bottom: 2rem;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--gray-light);
}

.card-header h3 {
  font-size: 1.5rem;
  font-weight: 700;
}

.card-action {
  color: var(--primary);
  text-decoration: none;
  font-weight: 600;
  transition: color 0.3s;
  cursor: pointer;
  background: none;
  border: none;
  font-family: 'Sarabun', sans-serif;
  font-size: 1rem;
}

.card-action:hover { color: var(--secondary); }

/* Listing Grid */
.listing-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 1.5rem;
}

.listing-card {
  background: var(--white);
  border-radius: 15px;
  overflow: hidden;
  box-shadow: 0 4px 15px rgba(0,0,0,0.06);
  transition: all 0.3s;
  cursor: pointer;
}

.listing-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.12);
}

.listing-image {
  width: 100%;
  height: 200px;
  object-fit: cover;
}

.listing-content {
  padding: 1.5rem;
}

.listing-title {
  font-size: 1.2rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
}

.listing-description {
  color: var(--gray);
  font-size: 0.9rem;
  margin-bottom: 1rem;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.listing-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 1rem;
  border-top: 1px solid var(--gray-light);
}

.listing-price {
  font-size: 1.3rem;
  font-weight: 900;
  color: var(--primary);
}

.listing-category {
  font-size: 0.85rem;
  color: var(--gray);
  padding: 0.3rem 0.8rem;
  background: var(--gray-light);
  border-radius: 50px;
}

.favorite-btn {
  position: absolute;
  top: 1rem;
  right: 1rem;
  background: white;
  border: none;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.favorite-btn:hover {
  transform: scale(1.1);
  background: var(--error);
  color: white;
}

.favorite-btn.active {
  background: var(--error);
  color: white;
}

/* ROI Calculator */
.calculator-form {
  display: grid;
  gap: 1.5rem;
}

.form-group {
  margin-bottom: 1rem;
}

.form-label {
  display: block;
  font-weight: 600;
  margin-bottom: 0.5rem;
  color: var(--text);
}

.form-input, .form-select {
  width: 100%;
  padding: 0.8rem 1rem;
  border: 2px solid var(--gray-light);
  border-radius: 10px;
  font-family: 'Sarabun', sans-serif;
  font-size: 1rem;
  transition: all 0.3s;
}

.form-input:focus, .form-select:focus {
  outline: none;
  border-color: var(--secondary);
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.calculator-results {
  background: linear-gradient(135deg, var(--secondary), var(--accent));
  color: white;
  padding: 2rem;
  border-radius: 15px;
  margin-top: 2rem;
}

.result-item {
  display: flex;
  justify-content: space-between;
  padding: 1rem 0;
  border-bottom: 1px solid rgba(255,255,255,0.2);
}

.result-item:last-child {
  border-bottom: none;
}

.result-label {
  font-size: 1rem;
  opacity: 0.9;
}

.result-value {
  font-size: 1.5rem;
  font-weight: 900;
}

/* Button Styles */
.btn {
  padding: 0.8rem 1.5rem;
  border: none;
  border-radius: 10px;
  font-family: 'Sarabun', sans-serif;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: var(--white);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(249, 115, 22, 0.4);
}

.btn-secondary {
  background: var(--gray-light);
  color: var(--text);
}

.btn-secondary:hover {
  background: var(--gray);
  color: var(--white);
}

.btn-success {
  background: var(--success);
  color: var(--white);
}

.btn-full {
  width: 100%;
  justify-content: center;
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: 3rem;
  color: var(--gray);
}

.empty-state i {
  font-size: 3rem;
  margin-bottom: 1rem;
  display: block;
  opacity: 0.3;
}

/* Search Bar */
.search-bar {
  position: relative;
  margin-bottom: 2rem;
}

.search-input {
  width: 100%;
  padding: 1rem 3rem 1rem 1rem;
  border: 2px solid var(--gray-light);
  border-radius: 50px;
  font-size: 1rem;
  transition: all 0.3s;
}

.search-input:focus {
  outline: none;
  border-color: var(--secondary);
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.search-icon {
  position: absolute;
  right: 1.5rem;
  top: 50%;
  transform: translateY(-50%);
  color: var(--gray);
}

/* Filter Buttons */
.filter-buttons {
  display: flex;
  gap: 1rem;
  margin-bottom: 2rem;
  flex-wrap: wrap;
}

.filter-btn {
  padding: 0.6rem 1.2rem;
  border: 2px solid var(--gray-light);
  background: white;
  border-radius: 50px;
  cursor: pointer;
  transition: all 0.3s;
  font-weight: 600;
}

.filter-btn:hover {
  border-color: var(--secondary);
  color: var(--secondary);
}

.filter-btn.active {
  background: linear-gradient(135deg, var(--secondary), var(--accent));
  color: white;
  border-color: transparent;
}

/* Toast Notifications */
.toast {
  position: fixed;
  bottom: 2rem;
  right: 2rem;
  background: var(--white);
  padding: 1rem 1.5rem;
  border-radius: 10px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  display: flex;
  align-items: center;
  gap: 1rem;
  z-index: 3000;
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from { transform: translateX(400px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

.toast.success { border-left: 4px solid var(--success); }
.toast.error { border-left: 4px solid var(--error); }
.toast.info { border-left: 4px solid var(--info); }

/* Inquiry Card */
.inquiry-card {
  background: var(--gray-light);
  padding: 1.5rem;
  border-radius: 10px;
  margin-bottom: 1rem;
}

.inquiry-header {
  display: flex;
  justify-content: space-between;
  align-items: start;
  margin-bottom: 1rem;
}

.inquiry-status {
  padding: 0.3rem 0.8rem;
  border-radius: 50px;
  font-size: 0.85rem;
  font-weight: 600;
}

.inquiry-status.pending {
  background: var(--warning);
  color: white;
}

.inquiry-status.responded {
  background: var(--success);
  color: white;
}

/* Responsive */
@media (max-width: 1024px) {
  .dashboard-layout {
    grid-template-columns: 1fr;
  }
  
  .sidebar {
    display: none;
  }
  
  .stats-grid {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  }
  
  .listing-grid {
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  }
}

@media (max-width: 768px) {
  .top-bar {
    flex-direction: column;
    gap: 1rem;
  }
  
  .content-area {
    padding: 1rem;
  }
  
  .filter-buttons {
    overflow-x: auto;
    flex-wrap: nowrap;
  }
}

.inquiry-card.unread {
  border-left: 4px solid var(--primary);
  background: rgba(249, 115, 22, 0.05);
}

/* Professional Offer Card Redesign */
.offer-card {
  background: var(--white);
  border: 1px solid var(--gray-light);
  border-radius: 12px;
  padding: 1.25rem;
  margin-bottom: 1rem;
  transition: all 0.3s;
}

.offer-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  border-color: var(--secondary);
}

.offer-card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 1rem;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid var(--gray-light);
}

.offer-title {
  font-size: 1rem;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 0.25rem;
}

.offer-subtitle {
  font-size: 0.813rem;
  color: var(--gray);
}

.offer-status-badge {
  padding: 0.375rem 0.75rem;
  border-radius: 6px;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.offer-status-badge.pending {
  background: rgba(245, 158, 11, 0.1);
  color: #D97706;
}

.offer-status-badge.accepted {
  background: rgba(16, 185, 129, 0.1);
  color: #059669;
}

.offer-status-badge.paid {
  background: rgba(16, 185, 129, 0.15);
  color: #047857;
}

.offer-status-badge.rejected {
  background: rgba(239, 68, 68, 0.1);
  color: #DC2626;
}

.offer-status-badge.countered {
  background: rgba(59, 130, 246, 0.1);
  color: #2563EB;
}

.offer-amount-section {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
  padding: 1rem;
  background: var(--bg);
  border-radius: 8px;
  margin-bottom: 1rem;
}

.amount-box {
  text-align: center;
}

.amount-label {
  font-size: 0.75rem;
  color: var(--gray);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 0.25rem;
}

.amount-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--primary);
}

.offer-message-box {
  padding: 0.75rem;
  background: var(--gray-light);
  border-left: 3px solid var(--secondary);
  border-radius: 4px;
  margin-bottom: 1rem;
}

.offer-message-label {
  font-size: 0.75rem;
  color: var(--gray);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 0.25rem;
}

.offer-message-text {
  font-size: 0.875rem;
  color: var(--text);
  line-height: 1.5;
}

.offer-action-banner {
  padding: 1rem;
  border-radius: 8px;
  margin-bottom: 1rem;
}

.offer-action-banner.success {
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(20, 184, 166, 0.1));
  border: 1px solid rgba(16, 185, 129, 0.2);
}

.offer-action-banner.info {
  background: rgba(59, 130, 246, 0.05);
  border: 1px solid rgba(59, 130, 246, 0.15);
}

.offer-action-banner-title {
  font-size: 0.875rem;
  font-weight: 600;
  margin-bottom: 0.375rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.offer-action-banner-text {
  font-size: 0.813rem;
  color: var(--gray-dark);
}

.offer-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 0.75rem;
  border-top: 1px solid var(--gray-light);
}

.offer-date {
  font-size: 0.75rem;
  color: var(--gray);
  display: flex;
  align-items: center;
  gap: 0.375rem;
}

.offer-actions {
  display: flex;
  gap: 0.5rem;
}

.btn-sm {
  padding: 0.5rem 0.875rem;
  font-size: 0.813rem;
  border-radius: 6px;
}

/* Invoice Card */
.invoice-card {
  background: var(--white);
  border: 1px solid var(--gray-light);
  border-radius: 12px;
  padding: 1.25rem;
  margin-bottom: 1rem;
  transition: all 0.3s;
}

.invoice-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  border-color: var(--primary);
}

.invoice-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid var(--gray-light);
}

.invoice-number {
  font-size: 1.125rem;
  font-weight: 700;
  color: var(--primary);
}

.invoice-meta {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1rem;
  margin-bottom: 1rem;
}

.invoice-meta-item {
  text-align: center;
  padding: 0.75rem;
  background: var(--bg);
  border-radius: 8px;
}

.invoice-meta-label {
  font-size: 0.75rem;
  color: var(--gray);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 0.25rem;
}

.invoice-meta-value {
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--text);
}

.invoice-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 0.75rem;
  border-top: 1px solid var(--gray-light);
}



/* Loading Progress */
.loading-step {
  padding: 0.5rem 1rem;
  margin: 0.3rem 0;
  border-radius: 8px;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.85rem;
  opacity: 0;
  animation: fadeInStep 0.3s forwards;
}

@keyframes fadeInStep {
  to { opacity: 1; }
}

.loading-step.pending {
  background: rgba(107, 114, 128, 0.1);
  color: var(--gray);
}

.loading-step.loading {
  background: rgba(59, 130, 246, 0.1);
  color: var(--info);
}

.loading-step.success {
  background: rgba(16, 185, 129, 0.1);
  color: var(--success);
}

.loading-step.error {
  background: rgba(239, 68, 68, 0.1);
  color: var(--error);
}

/* Ensure loading screen is visible on page load */
body:not(.loaded) .dashboard-layout {
  display: none;
}

.loading-screen:not(.hidden) {
  display: flex !important;
}

.loader {
  width: 50px;
  height: 50px;
  border: 4px solid var(--gray-light);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin: 0 auto;
}

@keyframes spin { to { transform: rotate(360deg); } }

</style>
</head>


<body>

<div class="loading-screen" id="loadingScreen">
  <div class="loading-content">
    <div class="loader"></div>
    <p id="loadingText">Initializing dashboard...</p>
    <div id="loadingSteps"></div>
  </div>
</div>

<div class="dashboard-layout">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <a href="index.html" class="logo">Systemly</a>
    </div>
    
    <div class="user-profile">
      <div class="user-profile-content">
        <div class="user-avatar" id="sidebarAvatar">B</div>
        <div class="user-details">
          <div class="user-name" id="sidebarName">Buyer</div>
          <div class="user-email" id="sidebarEmail">buyer@email.com</div>
        </div>
      </div>
      <span class="role-badge">Buyer</span>
    </div>
    
    <nav class="sidebar-nav">
      <div class="nav-section">
        <div class="nav-section-title">Browse</div>
        <div class="nav-item active" onclick="navigateTo('overview')">
          <i class="fa-solid fa-house"></i>
          <span>Overview</span>
        </div>
        
        <div class="nav-item" onclick="navigateTo('saved')">
          <i class="fa-solid fa-heart"></i>
          <span>Saved Listings</span>
          <span class="badge" id="savedCount">0</span>
        </div>
      </div>
      
      <div class="nav-section">
        <div class="nav-section-title">Tools</div>
        <div class="nav-item" onclick="navigateTo('calculator')">
          <i class="fa-solid fa-calculator"></i>
          <span>ROI Calculator</span>
        </div>
        <div class="nav-item" onclick="navigateTo('inquiries')">
          <i class="fa-solid fa-envelope"></i>
          <span>My Inquiries</span>
        </div>
      </div>
      
     <div class="nav-section">
  <div class="nav-section-title">Activity</div>
  <div class="nav-item" onclick="navigateTo('offers')">
    <i class="fa-solid fa-handshake"></i>
    <span>My Offers</span>
    <span class="badge" id="offersCount">0</span>
  </div>
  <div class="nav-item" onclick="navigateTo('invoices')">
    <i class="fa-solid fa-file-invoice-dollar"></i>
    <span>Invoices</span>
  </div>
  <div class="nav-item" onclick="navigateTo('inquiries')">
    <i class="fa-solid fa-comments"></i>
    <span>My Inquiries</span>
  </div>
</div>
    
    <div class="sidebar-footer">
      <button class="logout-btn" onclick="logout()">
        <i class="fa-solid fa-right-from-bracket"></i>
        Sign Out
      </button>
    </div>
  </aside>
  
  <!-- Main Content -->
  <main class="main-content">
<div class="top-bar">
  <button class="mobile-menu-toggle" id="mobileMenuToggle">
    <i class="fa-solid fa-bars"></i>
  </button>
  <h1 class="page-title" id="pageTitle">Overview</h1>
  <div class="top-bar-actions">
    <button class="btn btn-secondary" onclick="window.location.href='marketplace.html'">
      <i class="fa-solid fa-store"></i> <span class="btn-text">Browse</span>
    </button>
    <button class="btn btn-primary" onclick="navigateTo('calculator')">
      <i class="fa-solid fa-calculator"></i> <span class="btn-text">Calculator</span>
    </button>
  </div>
</div>
    
    <div class="content-area" id="contentArea">
      <!-- OVERVIEW TAB -->
      <div id="tab-overview" class="tab-content active">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-header">
              <div>
                <div class="stat-value" id="savedListingsCount">0</div>
                <div class="stat-label">Saved Listings</div>
              </div>
              <div class="stat-icon secondary">
                <i class="fa-solid fa-heart"></i>
              </div>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-header">
              <div>
                <div class="stat-value" id="activeInquiriesCount">0</div>
                <div class="stat-label">Active Inquiries</div>
              </div>
              <div class="stat-icon accent">
                <i class="fa-solid fa-envelope"></i>
              </div>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-header">
              <div>
                <div class="stat-value" id="totalPurchasesCount">0</div>
                <div class="stat-label">Purchases Made</div>
              </div>
              <div class="stat-icon success">
                <i class="fa-solid fa-shopping-bag"></i>
              </div>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-header">
              <div>
                <div class="stat-value" id="totalSpentAmount">â‚±0</div>
                <div class="stat-label">Total Invested</div>
              </div>
              <div class="stat-icon primary">
                <i class="fa-solid fa-peso-sign"></i>
              </div>
            </div>
          </div>
        </div>
        
        <div class="content-card">
          <div class="card-header">
            <h3>Quick Actions</h3>
          </div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <button class="btn btn-primary" onclick="window.location.href='marketplace.html'">
  <i class="fa-solid fa-store"></i> Browse Marketplace
</button>
            <button class="btn btn-primary" onclick="navigateTo('calculator')">
              <i class="fa-solid fa-calculator"></i> Calculate ROI
            </button>
            <button class="btn btn-primary" onclick="navigateTo('saved')">
              <i class="fa-solid fa-heart"></i> View Saved
            </button>
          </div>
        </div>
        
        <div class="content-card">
          <div class="card-header">
            <h3>Recently Viewed</h3>
            <button class="card-action" onclick="navigateTo('marketplace')">View All</button>
          </div>
          <div id="recentlyViewed"></div>
        </div>
      </div>
      
      <!-- MARKETPLACE TAB -->
    
      
      <!-- SAVED LISTINGS TAB -->
      <div id="tab-saved" class="tab-content">
        <div class="content-card">
          <div class="card-header">
            <h3>Saved Listings</h3>
          </div>
          <div class="listing-grid" id="savedListings"></div>
        </div>
      </div>
      
      <!-- ROI CALCULATOR TAB -->
      <div id="tab-calculator" class="tab-content">
        <div class="content-card">
          <div class="card-header">
            <h3>ROI Calculator</h3>
          </div>
          
          <form class="calculator-form" id="calculatorForm">
            <div class="form-group">
              <label class="form-label">Purchase Price (â‚±)</label>
              <input type="number" id="calcPurchasePrice" class="form-input" placeholder="50000" required>
            </div>
            
            <div class="form-group">
              <label class="form-label">Monthly Revenue (â‚±)</label>
              <input type="number" id="calcMonthlyRevenue" class="form-input" placeholder="5000" required>
            </div>
            
            <div class="form-group">
              <label class="form-label">Monthly Operating Costs (â‚±)</label>
              <input type="number" id="calcOperatingCosts" class="form-input" placeholder="1000">
            </div>
            
            <div class="form-group">
              <label class="form-label">Expected Growth Rate (%)</label>
              <input type="number" id="calcGrowthRate" class="form-input" placeholder="10" step="0.1">
            </div>
            
            <div class="form-group">
              <label class="form-label">Investment Period (months)</label>
              <input type="number" id="calcPeriod" class="form-input" placeholder="12" min="1" max="60">
            </div>
            
            <button type="button" class="btn btn-primary btn-full" onclick="calculateROI()">
              <i class="fa-solid fa-calculator"></i> Calculate ROI
            </button>
          </form>
          
          <div id="calculatorResults" style="display: none;">
            <div class="calculator-results">
              <h4 style="margin-bottom: 1.5rem; font-size: 1.5rem;">Investment Analysis</h4>
              
              <div class="result-item">
                <span class="result-label">Monthly Net Profit</span>
                <span class="result-value" id="resultMonthlyProfit">â‚±0</span>
              </div>
              
              <div class="result-item">
                <span class="result-label">Annual Return</span>
                <span class="result-value" id="resultAnnualReturn">â‚±0</span>
              </div>
              
              <div class="result-item">
                <span class="result-label">ROI Percentage</span>
                <span class="result-value" id="resultROI">0%</span>
              </div>
              
              <div class="result-item">
                <span class="result-label">Break-Even Period</span>
                <span class="result-value" id="resultBreakEven">0 months</span>
              </div>
              
              <div class="result-item">
                <span class="result-label">Total Return (${document.getElementById('calcPeriod')?.value || 12} months)</span>
                <span class="result-value" id="resultTotalReturn">â‚±0</span>
              </div>
              
              <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.2);">
                <p style="opacity: 0.9; font-size: 0.95rem; line-height: 1.6;">
                  <strong>Analysis:</strong> <span id="resultAnalysis">Calculate to see analysis</span>
                </p>
              </div>
            </div>
            
            <button class="btn btn-secondary btn-full" style="margin-top: 1rem;" onclick="resetCalculator()">
              <i class="fa-solid fa-undo"></i> Calculate Another
            </button>
          </div>
        </div>
      </div>
      
      <!-- INQUIRIES TAB -->
      <div id="tab-inquiries" class="tab-content">
        <div class="content-card">
          <div class="card-header">
            <h3>My Inquiries</h3>
            <button class="card-action" onclick="navigateTo('marketplace')">Browse Listings</button>
          </div>
          <div id="inquiriesList"></div>
        </div>
      </div>
      
      <!-- PURCHASES TAB -->
      <div id="tab-purchases" class="tab-content">
        <div class="content-card">
          <div class="card-header">
            <h3>Purchase History</h3>
          </div>
          <div id="purchasesList"></div>
        </div>
      </div>
      


<!-- MY OFFERS TAB -->
<div id="tab-offers" class="tab-content">
  <div class="content-card">
    <div class="card-header">
      <h3>My Offers</h3>
      <button class="card-action" onclick="window.location.href='marketplace.html'">
        <i class="fa-solid fa-plus"></i> Make New Offer
      </button>
    </div>
    <div id="offersList"></div>
  </div>
</div>

<!-- MESSAGES TAB -->
<div id="tab-messages" class="tab-content">
  <div class="content-card">
    <div class="card-header">
      <h3>My Messages</h3>
      <button class="card-action" onclick="loadMessages()">
        <i class="fa-solid fa-sync"></i> Refresh
      </button>
    </div>
    <div id="messagesList"></div>
  </div>
</div>

<!-- INVOICES / PURCHASE HISTORY TAB -->
<div id="tab-invoices" class="tab-content">
  <div class="content-card">
    <div class="card-header">
      <h3>Invoice History</h3>
      <button class="card-action" onclick="loadInvoices()">
        <i class="fa-solid fa-rotate"></i> Refresh
      </button>
    </div>
    <div id="invoicesList"></div>
  </div>
</div>












      <!-- SETTINGS TAB -->
      <div id="tab-settings" class="tab-content">
        <div class="content-card">
          <div class="card-header">
            <h3>Account Settings</h3>
          </div>
          
          <form id="settingsForm" onsubmit="saveSettings(event)">
            <div class="form-group">
              <label class="form-label">Full Name</label>
              <input type="text" id="settingsName" class="form-input" required>
            </div>
            
            <div class="form-group">
              <label class="form-label">Email</label>
              <input type="email" id="settingsEmail" class="form-input" disabled>
              <small style="color: var(--gray); font-size: 0.85rem;">Email cannot be changed</small>
            </div>
            
            <div class="form-group">
              <label class="form-label">Phone</label>
              <input type="tel" id="settingsPhone" class="form-input">
            </div>
            
            <div class="form-group">
              <label class="form-label">Location</label>
              <input type="text" id="settingsLocation" class="form-input" placeholder="City, Country">
            </div>
            
            <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--gray-light);">
              <h4 style="margin-bottom: 1rem;">Notification Preferences</h4>
              <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.8rem; cursor: pointer;">
                <input type="checkbox" id="notifyNewListings" checked> New listings matching my interests
              </label>
              <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.8rem; cursor: pointer;">
                <input type="checkbox" id="notifyPriceDrops" checked> Price drops on saved listings
              </label>
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="notifyNewsletter"> Weekly marketplace newsletter
              </label>
            </div>
            
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
              <button type="submit" class="btn btn-primary">
                <i class="fa-solid fa-save"></i> Save Changes
              </button>
              <button type="button" class="btn btn-secondary" onclick="resetSettings()">
                <i class="fa-solid fa-undo"></i> Reset
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </main>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
import { 
  getFirestore, 
  doc, 
  getDoc, 
  setDoc, 
  updateDoc, 
  collection, 
  query, 
  where, 
  getDocs, 
  addDoc,
  deleteDoc,
  serverTimestamp,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD3PQ5oWrzAXOHnb7wrmpRhL9DWIB7w9rE",
  authDomain: "systemly-db.firebaseapp.com",
  projectId: "systemly-db",
  storageBucket: "systemly-db.firebasestorage.app",
  messagingSenderId: "32599486733",
  appId: "1:32599486733:web:16d34643c8f920a6fd8044"
};

const API_URL = 'https://systemly.onrender.com'; //
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let userData = null;
let allListings = [];
let savedListings = [];
let inquiries = [];
let purchases = [];
let recentlyViewed = [];
let myOffers = [];
let myMessages = [];
let fileReviews = [];
let listingsUnsubscribe = null;

// ============================================
// LOAD OFFERS
// ============================================

async function loadOffers() {
  try {
    console.log('ðŸ“¥ Loading buyer offers from Firebase...');
    
    // Query Firebase 'offers' collection where buyerId matches
    const offersRef = collection(db, 'offers');
    const q = query(offersRef, where('buyerId', '==', userData.id));
    
    onSnapshot(q, async (snapshot) => {
      myOffers = [];
      
      snapshot.forEach((doc) => {
        const data = doc.data();
        myOffers.push({
          id: doc.id,
          listing_id: data.listingId,
          listing_name: data.listingName,
          seller_id: data.sellerId,
          seller_email: data.sellerEmail,
          buyer_id: data.buyerId,
          buyer_email: data.buyerEmail,
          buyer_name: data.buyerName,
          offer_amount: data.offerAmount,
          message: data.message,
          status: data.status,
          created_at: data.createdAt?.toDate?.() || new Date(),
          counter_amount: data.counterAmount || null,
          fileReviewStatus: null,
          fileReviewId: null
        });
      });
      
      console.log('âœ… Loaded', myOffers.length, 'offers from Firebase');
      await loadFileReviews();
      renderOffers();
      updateStats();
    }, (error) => {
      console.error('âŒ Error in offers snapshot:', error);
    }); 
    
  } catch (error) {
    console.error('âŒ Error loading offers:', error);
    myOffers = [];
  }
}



// ============================================
// LOAD FILE REVIEWS - FIXED
// ============================================
async function loadFileReviews() {
  try {
    console.log('ðŸ“¥ Loading file reviews for buyer offers...');
    
    const timeout = (ms) => new Promise((_, reject) => 
      setTimeout(() => reject(new Error('Timeout')), ms)
    );
    
    for (const offer of myOffers) {
      // Only check for accepted, admin-approved, or paid offers
      if (offer.status !== 'accepted' && offer.status !== 'admin-approved' && offer.status !== 'paid') {
        console.log(`â­ï¸ Skipping offer ${offer.id} - status: ${offer.status}`);
        continue;
      }
      
      try {
        const response = await Promise.race([
          fetch(`${API_URL}/api/file-reviews/offer/${offer.id}`),
          timeout(5000) // 5 seconds timeout
        ]);
        
        if (response.ok) {
          const data = await response.json();
          
          if (data.success && data.review) {
            offer.fileReviewStatus = data.review.status;
            offer.fileReviewId = data.review.id;
            offer.fileCount = data.review.fileCount || 0;
            offer.instructions = data.review.instructions || '';
            
            console.log(`âœ… Offer ${offer.id}:`, {
              status: data.review.status,
              files: offer.fileCount,
              reviewId: offer.fileReviewId
            });
            
            // ðŸ”¥ NEW: Auto-check if invoice is paid when files are approved
            if (offer.status === 'admin-approved' && data.review.status === 'admin-approved') {
              console.log(`ðŸ” Files approved for offer ${offer.id}, checking invoice payment status...`);
              await checkInvoiceStatusAndUpdate(offer.id);
            }
          } else {
            console.log(`â„¹ï¸ Offer ${offer.id}: No file review found`);
          }
        } else {
          console.warn(`âš ï¸ Offer ${offer.id}: Server returned ${response.status}`);
        }
      } catch (err) {
        console.warn(`â±ï¸ Offer ${offer.id}: ${err.message}`);
      }
    }
    
    console.log('âœ… File reviews loaded for', myOffers.filter(o => o.fileReviewId).length, 'offers');
    
  } catch (error) {
    console.error('âŒ Error in loadFileReviews:', error);
  }
}



// ============================================
// CHECK INVOICE STATUS AND AUTO-UPDATE OFFER
// ============================================
async function checkInvoiceStatusAndUpdate(offerId) {
  try {
    console.log(`ðŸ’° Checking invoice status for offer ${offerId}...`);
    
    // Check if there's a paid invoice for this offer
    const invoicesRef = collection(db, 'invoices');
    const q = query(invoicesRef, where('offerId', '==', offerId));
    const snapshot = await getDocs(q);
    
    if (!snapshot.empty) {
      const invoiceDoc = snapshot.docs[0];
      const invoiceData = invoiceDoc.data();
      
      console.log(`ðŸ“‹ Found invoice: ${invoiceData.invoiceNumber}, status: ${invoiceData.status}`);
      
      if (invoiceData.status === 'paid') {
        // Invoice is paid, update offer to paid
        console.log(`âœ… Invoice is PAID! Updating offer ${offerId} to 'paid' status...`);
        
        const offerRef = doc(db, 'offers', offerId);
        await updateDoc(offerRef, {
          status: 'paid',
          paidAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
        
        console.log(`âœ… Offer ${offerId} status updated to 'paid'`);
        showToast('Payment confirmed! Files are now available for download.', 'success');
        
        return true;
      } else {
        console.log(`â³ Invoice status is '${invoiceData.status}' - waiting for payment confirmation`);
      }
    } else {
      console.log(`â„¹ï¸ No invoice found for offer ${offerId}`);
    }
  } catch (error) {
    console.error('âŒ Error checking invoice status:', error);
  }
  return false;
}









// ============================================
// LOAD MESSAGES - FIXED
// ============================================
async function loadMessages() {
  try {
    console.log('ðŸ“¥ Loading buyer messages...');
    myMessages = [];
    console.log('âœ… Messages loaded');
  } catch (error) {
    console.error('âŒ Error loading messages:', error);
    myMessages = [];
  }
}


// ============================================
// LOAD INVOICES - FIXED
// ============================================
let myInvoices = [];
// ============================================
// LOADING PROGRESS SYSTEM
// ============================================
const loadingSteps = [
  { id: 'auth', label: 'Authenticating user', status: 'pending' },
  { id: 'user', label: 'Loading profile', status: 'pending' },
  { id: 'listings', label: 'Loading marketplace', status: 'pending' },
  { id: 'saved', label: 'Loading saved listings', status: 'pending' },
  { id: 'inquiries', label: 'Loading inquiries', status: 'pending' },
  { id: 'purchases', label: 'Loading purchases', status: 'pending' },
  { id: 'offers', label: 'Loading offers', status: 'pending' },
  { id: 'invoices', label: 'Loading invoices', status: 'pending' }
];

function updateLoadingStep(stepId, status) {
  const step = loadingSteps.find(s => s.id === stepId);
  if (step) {
    step.status = status;
    renderLoadingSteps();
  }
}

function renderLoadingSteps() {
  const container = document.getElementById('loadingSteps');
  if (!container) return;
  
  container.innerHTML = loadingSteps.map(step => {
    const icon = step.status === 'success' ? 'âœ“' :
                 step.status === 'error' ? 'âœ—' :
                 step.status === 'loading' ? 'â‹¯' : 'â—‹';
    
    return `
      <div class="loading-step ${step.status}">
        <span style="font-weight: bold;">${icon}</span>
        <span>${step.label}</span>
      </div>
    `;
  }).join('');
}






async function loadInvoices() {
  try {
    console.log('ðŸ“¥ Loading invoices for user:', userData.id);
    console.log('User email:', userData.email);
    
    const invoicesRef = collection(db, 'invoices');
    
    // Query ALL invoices (we'll filter client-side due to nested field limitations)
    const snapshot = await getDocs(invoicesRef);
    myInvoices = [];
    
    console.log('ðŸ“‹ Total invoices in database:', snapshot.size);
    
    // Filter invoices where the current user is buyer or seller
    snapshot.forEach((doc) => {
      const invoiceData = doc.data();
      
      console.log('Checking invoice:', doc.id);
      console.log('Buyer contact:', invoiceData.buyer?.contact);
      console.log('Seller contact:', invoiceData.seller?.contact);
      console.log('User email:', userData.email);
      
      // Check if this invoice belongs to the user (as buyer or seller)
      const isBuyer = invoiceData.buyer?.contact?.toLowerCase() === userData.email.toLowerCase();
      const isSeller = invoiceData.seller?.contact?.toLowerCase() === userData.email.toLowerCase();
      
      if (isBuyer || isSeller) {
        myInvoices.push({
          id: doc.id,
          ...invoiceData
        });
        console.log('âœ… Matched invoice:', doc.id, isBuyer ? '(buyer)' : '(seller)');
      } else {
        console.log('âŒ No match for invoice:', doc.id);
      }
    });

    // Sort by issue date (newest first)
    myInvoices.sort((a, b) => {
      const dateA = a.issueDate ? new Date(a.issueDate) : new Date(0);
      const dateB = b.issueDate ? new Date(b.issueDate) : new Date(0);
      return dateB - dateA;
    });
    
    console.log('âœ… Loaded invoices:', myInvoices.length);
    if (myInvoices.length > 0) {
      console.log('Invoice IDs:', myInvoices.map(inv => inv.id));
    }
    
    // Force render even if no invoices to show empty state
    renderInvoices();
    
  } catch (error) {
    console.error('âŒ Error loading invoices:', error);
    console.error('Error code:', error.code);
    console.error('Error message:', error.message);
    myInvoices = [];
    renderInvoices(); // Still render to show error/empty state
  }
}

// Make sure this is accessible globally
window.loadInvoices = loadInvoices;









// Show loading screen immediately
document.addEventListener('DOMContentLoaded', function() {
  const loadingScreen = document.getElementById('loadingScreen');
  if (loadingScreen) {
    loadingScreen.style.display = 'flex';
    loadingScreen.style.opacity = '1';
  }
});



onAuthStateChanged(auth, async (user) => {
  updateLoadingStep('auth', 'loading');
  
  if (!user) {
    console.log('âŒ No user authenticated, redirecting to login...');
    updateLoadingStep('auth', 'error');
    document.getElementById('loadingText').textContent = 'Redirecting to login...';
    
    setTimeout(() => {
      document.getElementById('loadingScreen').classList.add('hidden');
      window.location.href = 'login.html';
    }, 1000);
    return;
  }
  
  updateLoadingStep('auth', 'success');
  console.log('âœ… User authenticated:', user.email);
  
  try {
    // Load user document
    updateLoadingStep('user', 'loading');
    document.getElementById('loadingText').textContent = 'Loading your profile...';
    
    const userDocRef = doc(db, 'users', user.uid);
    const userDoc = await getDoc(userDocRef);
    
    if (userDoc.exists()) {
      const data = userDoc.data();
      userData = {
        id: user.uid,
        email: user.email,
        name: data.name || user.displayName || user.email.split('@')[0],
        role: data.role || 'buyer',
        profile: data.profile || {},
        savedListings: data.savedListings || [],
        recentlyViewed: data.recentlyViewed || []
      };
      
      updateLoadingStep('user', 'success');
      console.log('âœ… User document loaded:', userData);
      
      // Set up real-time listener for user document updates
      onSnapshot(userDocRef, async (docSnap) => {
        if (docSnap.exists()) {
          const data = docSnap.data();
          
          const oldSaved = userData.savedListings || [];
          const newSaved = data.savedListings || [];
          
          if (JSON.stringify(oldSaved) !== JSON.stringify(newSaved)) {
            console.log('ðŸ”„ Saved listings updated:', newSaved.length);
            userData.savedListings = newSaved;
            
            // Reload and render saved listings
            if (newSaved.length > 0) {
              try {
                const listingsRef = collection(db, 'listings');
                const q = query(listingsRef, where('__name__', 'in', newSaved));
                const snapshot = await getDocs(q);
                savedListings = [];
                
                snapshot.forEach((doc) => {
                  savedListings.push({
                    id: doc.id,
                    ...doc.data()
                  });
                });
                
                console.log('âœ… Reloaded saved listings:', savedListings.length);
              } catch (err) {
                console.error('Error reloading saved listings:', err);
              }
            } else {
              savedListings = [];
            }
            
            renderSavedListings();
            updateStats();
          }
        }
      }, (error) => {
        console.error('âŒ Error in user snapshot:', error);
      });
      
    } else {
      console.log('ðŸ“ Creating new buyer user document...');
      userData = {
        id: user.uid,
        email: user.email,
        name: user.displayName || user.email.split('@')[0],
        role: 'buyer',
        profile: {},
        savedListings: [],
        recentlyViewed: []
      };
      
      await setDoc(userDocRef, {
        ...userData,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });
      
      updateLoadingStep('user', 'success');
      console.log('âœ… New buyer user document created');
    }
    
    // Load all data sequentially with progress updates
    console.log('ðŸ”„ Starting data load...');
    
    // Step 3: Marketplace
    try {
      updateLoadingStep('listings', 'loading');
      document.getElementById('loadingText').textContent = 'Loading marketplace...';
      await loadMarketplaceListings();
      // Wait a bit for snapshot to populate
      await new Promise(resolve => setTimeout(resolve, 500));
      updateLoadingStep('listings', 'success');
      console.log('âœ… Marketplace loaded');
    } catch (e) {
      console.error('âŒ Marketplace load failed:', e);
      updateLoadingStep('listings', 'error');
    }
    
    // Step 4: Saved Listings
    try {
      updateLoadingStep('saved', 'loading');
      document.getElementById('loadingText').textContent = 'Loading saved listings...';
      await loadSavedListings();
      await new Promise(resolve => setTimeout(resolve, 300));
      updateLoadingStep('saved', 'success');
      console.log('âœ… Saved listings loaded');
    } catch (e) {
      console.error('âŒ Saved listings load failed:', e);
      updateLoadingStep('saved', 'error');
    }
    
    // Step 5: Inquiries
    try {
      updateLoadingStep('inquiries', 'loading');
      document.getElementById('loadingText').textContent = 'Loading inquiries...';
      await loadInquiries();
      await new Promise(resolve => setTimeout(resolve, 300));
      updateLoadingStep('inquiries', 'success');
      console.log('âœ… Inquiries loaded');
    } catch (e) {
      console.error('âŒ Inquiries load failed:', e);
      updateLoadingStep('inquiries', 'error');
    }
    
    // Step 6: Purchases
    try {
      updateLoadingStep('purchases', 'loading');
      document.getElementById('loadingText').textContent = 'Loading purchases...';
      await loadPurchases();
      await new Promise(resolve => setTimeout(resolve, 300));
      updateLoadingStep('purchases', 'success');
      console.log('âœ… Purchases loaded');
    } catch (e) {
      console.error('âŒ Purchases load failed:', e);
      updateLoadingStep('purchases', 'error');
    }
    
    // Step 7: Offers
    try {
      updateLoadingStep('offers', 'loading');
      document.getElementById('loadingText').textContent = 'Loading offers...';
      await loadOffers();
      await new Promise(resolve => setTimeout(resolve, 300));
      updateLoadingStep('offers', 'success');
      console.log('âœ… Offers loaded');
    } catch (e) {
      console.error('âŒ Offers load failed:', e);
      updateLoadingStep('offers', 'error');
    }
    
    // Step 8: Invoices
    try {
      updateLoadingStep('invoices', 'loading');
      document.getElementById('loadingText').textContent = 'Loading invoices...';
      await loadInvoices();
      await new Promise(resolve => setTimeout(resolve, 300));
      updateLoadingStep('invoices', 'success');
      console.log('âœ… Invoices loaded');
    } catch (e) {
      console.error('âŒ Invoices load failed:', e);
      updateLoadingStep('invoices', 'error');
    }
    
    console.log('ðŸŽ¯ All data loaded, initializing dashboard...');
    document.getElementById('loadingText').textContent = 'Finalizing...';
    
    // Wait a moment before showing dashboard
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // Initialize dashboard
    initializeDashboard();
    
  } catch (error) {
    console.error('âŒ Critical error loading user data:', error);
    document.getElementById('loadingText').textContent = 'Error loading dashboard';
    updateLoadingStep('user', 'error');
    
    setTimeout(() => {
      document.getElementById('loadingScreen').classList.add('hidden');
      document.body.classList.add('loaded');
      showToast('Failed to load dashboard. Please refresh the page.', 'error');
    }, 2000);
  }
});

// Loading timeout fallback
setTimeout(() => {
  const loadingScreen = document.getElementById('loadingScreen');
  if (loadingScreen && !loadingScreen.classList.contains('hidden')) {
    console.warn('â° Loading timeout - forcing dashboard to display');
    document.getElementById('loadingText').textContent = 'Loading completed with warnings';
    
    setTimeout(() => {
      loadingScreen.classList.add('hidden');
      document.body.classList.add('loaded');
      showToast('Dashboard loaded (some data may be incomplete)', 'info');
    }, 1000);
  }
}, 15000); // Increased to 15 seconds
// ============================================
// LOAD MARKETPLACE LISTINGS
// ============================================

async function loadMarketplaceListings() {
  try {
    console.log('ðŸ“¥ Loading marketplace listings...');
    
    const listingsRef = collection(db, 'listings');
    const q = query(listingsRef, where('status', 'in', ['active', 'approved']));
    
    // Set up real-time listener
    listingsUnsubscribe = onSnapshot(q, (snapshot) => {
      allListings = [];
      
      snapshot.forEach((doc) => {
        const data = doc.data();
        allListings.push({
          id: doc.id,
          ...data
        });
      });
      
      console.log('âœ… Loaded marketplace listings:', allListings.length);
      
      // Update UI if dashboard is loaded
      if (document.body.classList.contains('loaded')) {
        renderMarketplace();
        updateRecentlyViewed();
      }
    }, (error) => {
      console.error('âŒ Error in listings snapshot:', error);
      showToast('Failed to load listings', 'error');
    });
    
  } catch (error) {
    console.error('âŒ Error loading marketplace listings:', error);
    allListings = [];
  }
}

// ============================================
// LOAD SAVED LISTINGS
// ============================================

async function loadSavedListings() {
  try {
    if (!userData || !userData.savedListings || userData.savedListings.length === 0) {
      console.log('No saved listings');
      savedListings = [];
      return;
    }
    
    console.log('ðŸ“¥ Loading saved listings...');
    
    const listingsRef = collection(db, 'listings');
    const q = query(listingsRef, where('__name__', 'in', userData.savedListings));
    
    const snapshot = await getDocs(q);
    savedListings = [];
    
    snapshot.forEach((doc) => {
      savedListings.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    console.log('âœ… Loaded saved listings:', savedListings.length);
    
  } catch (error) {
    console.error('âŒ Error loading saved listings:', error);
    savedListings = [];
  }
}

// ============================================
// LOAD INQUIRIES
// ============================================

async function loadInquiries() {
  try {
    console.log('ðŸ“¥ Loading inquiries...');
    
    const inquiriesRef = collection(db, 'inquiries');
    const q = query(inquiriesRef, where('buyerId', '==', userData.id));
    
    const snapshot = await getDocs(q);
    inquiries = [];
    
    snapshot.forEach((doc) => {
      inquiries.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    console.log('âœ… Loaded inquiries:', inquiries.length);
    
  } catch (error) {
    console.error('âŒ Error loading inquiries:', error);
    inquiries = [];
  }
}

// ============================================
// LOAD PURCHASES
// ============================================

async function loadPurchases() {
  try {
    console.log('ðŸ“¥ Loading purchases...');
    
    const purchasesRef = collection(db, 'purchases');
    const q = query(purchasesRef, where('buyerId', '==', userData.id));
    
    const snapshot = await getDocs(q);
    purchases = [];
    
    snapshot.forEach((doc) => {
      purchases.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    console.log('âœ… Loaded purchases:', purchases.length);
    
  } catch (error) {
    console.error('âŒ Error loading purchases:', error);
    purchases = [];
  }
}

// ============================================
// INITIALIZE DASHBOARD
// ============================================

function initializeDashboard() {
  console.log('ðŸŽ¯ Initializing buyer dashboard...');
  console.log('Data loaded:', {
    savedListings: savedListings.length,
    invoices: myInvoices.length,
    offers: myOffers.length,
    inquiries: inquiries.length,
    purchases: purchases.length
  });
  
  try {
    updateUserProfile();
    console.log('âœ… User profile updated');
  } catch (e) {
    console.error('âŒ Error updating user profile:', e);
  }
  
  try {
    updateStats();
    console.log('âœ… Stats updated');
  } catch (e) {
    console.error('âŒ Error updating stats:', e);
  }
  
  try {
    renderSavedListings();
    console.log('âœ… Saved listings rendered');
  } catch (e) {
    console.error('âŒ Error rendering saved listings:', e);
  }
  
  try {
    renderInquiries();
    console.log('âœ… Inquiries rendered');
  } catch (e) {
    console.error('âŒ Error rendering inquiries:', e);
  }
  
  try {
    renderPurchases();
    console.log('âœ… Purchases rendered');
  } catch (e) {
    console.error('âŒ Error rendering purchases:', e);
  }
  
  try {
    renderOffers();
    console.log('âœ… Offers rendered');
  } catch (e) {
    console.error('âŒ Error rendering offers:', e);
  }
  
  try {
    renderMessages();
    console.log('âœ… Messages rendered');
  } catch (e) {
    console.error('âŒ Error rendering messages:', e);
  }
  
  try {
    renderInvoices();
    console.log('âœ… Invoices rendered');
  } catch (e) {
    console.error('âŒ Error rendering invoices:', e);
  }
  
  try {
    updateRecentlyViewed();
    console.log('âœ… Recently viewed updated');
  } catch (e) {
    console.error('âŒ Error updating recently viewed:', e);
  }
  
  // Force a re-render after a short delay to ensure DOM is ready
  setTimeout(() => {
    console.log('ðŸ”„ Force re-render...');
    try {
      renderSavedListings();
      renderInvoices();
      updateStats();
      console.log('âœ… Re-render complete');
    } catch (e) {
      console.error('âŒ Error in re-render:', e);
    }
  }, 100);
  
  // Hide loading screen with fade out
  setTimeout(() => {
    const loadingScreen = document.getElementById('loadingScreen');
    if (loadingScreen) {
      loadingScreen.style.opacity = '0';
      
      setTimeout(() => {
        loadingScreen.classList.add('hidden');
        document.body.classList.add('loaded');
        console.log('âœ… Buyer dashboard fully initialized');
      }, 300);
    }
  }, 500);
}


function updateUserProfile() {
  const initials = userData.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
  
  document.getElementById('sidebarAvatar').textContent = initials;
  document.getElementById('sidebarName').textContent = userData.name;
  document.getElementById('sidebarEmail').textContent = userData.email;
}

function updateStats() {
  // Safely update stat elements
  const savedListingsCountEl = document.getElementById('savedListingsCount');
  const savedCountEl = document.getElementById('savedCount');
  const activeInquiriesCountEl = document.getElementById('activeInquiriesCount');
  const totalPurchasesCountEl = document.getElementById('totalPurchasesCount');
  const totalSpentAmountEl = document.getElementById('totalSpentAmount');
  const offersCountEl = document.getElementById('offersCount');
  
  if (savedListingsCountEl) savedListingsCountEl.textContent = savedListings.length;
  if (savedCountEl) savedCountEl.textContent = savedListings.length;
  if (activeInquiriesCountEl) activeInquiriesCountEl.textContent = inquiries.filter(i => i.status === 'pending').length;
  if (totalPurchasesCountEl) totalPurchasesCountEl.textContent = purchases.length;
  
  const totalSpent = purchases.reduce((sum, p) => sum + (p.amount || 0), 0);
  if (totalSpentAmountEl) totalSpentAmountEl.textContent = `â‚±${totalSpent.toLocaleString()}`;
  
  // Update badges
  const pendingOffers = myOffers.filter(o => o.status === 'pending').length;
  if (offersCountEl) offersCountEl.textContent = pendingOffers;
  
  console.log('âœ… Stats updated:', {
    saved: savedListings.length,
    inquiries: inquiries.length,
    purchases: purchases.length,
    offers: pendingOffers
  });
}

// ============================================
// RENDER MARKETPLACE
// ============================================

function renderMarketplace() {
  const container = document.getElementById('marketplaceListings');
  
  if (allListings.length === 0) {
    container.innerHTML = `
      <div class="empty-state" style="grid-column: 1 / -1;">
        <i class="fa-solid fa-store-slash"></i>
        <p>No listings available at the moment</p>
        <p style="font-size: 0.9rem; color: var(--gray);">Check back soon for new systems!</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = allListings.map(listing => `
    <div class="listing-card" onclick="viewListing('${listing.id}')" style="position: relative;">
      <button class="favorite-btn ${isSaved(listing.id) ? 'active' : ''}" 
              onclick="event.stopPropagation(); toggleSave('${listing.id}')">
        <i class="fa-${isSaved(listing.id) ? 'solid' : 'regular'} fa-heart"></i>
      </button>
      <img src="${listing.mainImage || 'https://via.placeholder.com/400x200'}" 
           alt="${listing.systemName}" 
           class="listing-image">
      <div class="listing-content">
        <h3 class="listing-title">${listing.systemName || 'Untitled'}</h3>
        <p class="listing-description">${listing.shortDescription || 'No description available'}</p>
        <div class="listing-footer">
          <div class="listing-price">â‚±${parseInt(listing.askingPrice || 0).toLocaleString()}</div>
          <div class="listing-category">${listing.categoryName || listing.category}</div>
        </div>
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--gray-light); display: flex; justify-content: space-between; font-size: 0.9rem; color: var(--gray);">
          <span><i class="fa-solid fa-eye"></i> ${listing.views || 0} views</span>
          <span><i class="fa-solid fa-dollar-sign"></i> MRR: â‚±${(listing.mrr || 0).toLocaleString()}</span>
        </div>
      </div>
    </div>
  `).join('');
}

// ============================================
// RENDER SAVED LISTINGS
// ============================================

function renderSavedListings() {
  const container = document.getElementById('savedListings');
  
  console.log('ðŸŽ¨ Rendering saved listings:', savedListings.length);
  console.log('Container found:', !!container);
  
  if (!container) {
    console.error('âŒ savedListings container not found!');
    return;
  }
  
  if (savedListings.length === 0) {
    container.innerHTML = `
      <div class="empty-state" style="grid-column: 1 / -1;">
        <i class="fa-solid fa-heart-crack"></i>
        <p>No saved listings yet</p>
        <p style="font-size: 0.9rem; color: var(--gray);">Browse the marketplace and save your favorites!</p>
        <br>
        <button class="btn btn-primary" onclick="window.location.href='marketplace.html'">
          <i class="fa-solid fa-store"></i> Browse Marketplace
        </button>
      </div>
    `;
    return;
  }
  
  container.innerHTML = savedListings.map(listing => `
    <div class="listing-card" onclick="viewListing('${listing.id}')" style="position: relative;">
      <button class="favorite-btn active" 
              onclick="event.stopPropagation(); toggleSave('${listing.id}')">
        <i class="fa-solid fa-heart"></i>
      </button>
      <img src="${listing.mainImage || 'https://via.placeholder.com/400x200'}" 
           alt="${listing.systemName}" 
           class="listing-image">
      <div class="listing-content">
        <h3 class="listing-title">${listing.systemName || 'Untitled'}</h3>
        <p class="listing-description">${listing.shortDescription || 'No description available'}</p>
        <div class="listing-footer">
          <div class="listing-price">â‚±${parseInt(listing.askingPrice || 0).toLocaleString()}</div>
          <div class="listing-category">${listing.categoryName || listing.category}</div>
        </div>
      </div>
    </div>
  `).join('');
}

// ============================================
// RENDER INQUIRIES
// ============================================

function renderInquiries() {
  const container = document.getElementById('inquiriesList');
  
  if (inquiries.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fa-solid fa-envelope-open"></i>
        <p>No inquiries sent yet</p>
        <p style="font-size: 0.9rem; color: var(--gray);">Contact sellers about listings you're interested in</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = inquiries.map(inquiry => `
    <div class="inquiry-card">
      <div class="inquiry-header">
        <div>
          <h4>${inquiry.listingName || 'Listing Inquiry'}</h4>
          <p style="color: var(--gray); font-size: 0.9rem; margin-top: 0.3rem;">
            To: ${inquiry.sellerName || 'Seller'}
          </p>
        </div>
        <span class="inquiry-status ${inquiry.status}">${inquiry.status || 'pending'}</span>
      </div>
      <p style="color: var(--text); margin-bottom: 0.5rem;">${inquiry.message || 'No message'}</p>
      <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--gray);">
        <span><i class="fa-solid fa-calendar"></i> ${inquiry.createdAt?.toDate?.().toLocaleDateString() || 'N/A'}</span>
        <button class="btn btn-secondary" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;" 
                onclick="viewListing('${inquiry.listingId}')">
          View Listing
        </button>
      </div>
    </div>
  `).join('');
}

// ============================================
// RENDER PURCHASES
// ============================================

function renderPurchases() {
  const container = document.getElementById('purchasesList');
  
  if (purchases.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fa-solid fa-shopping-bag"></i>
        <p>No purchases yet</p>
        <p style="font-size: 0.9rem; color: var(--gray);">Your purchase history will appear here</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = purchases.map(purchase => `
    <div class="inquiry-card">
      <div class="inquiry-header">
        <div>
          <h4>${purchase.listingName || 'System Purchase'}</h4>
          <p style="color: var(--gray); font-size: 0.9rem; margin-top: 0.3rem;">
            From: ${purchase.sellerName || 'Seller'}
          </p>
        </div>
        <span class="inquiry-status ${purchase.status === 'completed' ? 'responded' : 'pending'}">
          ${purchase.status || 'processing'}
        </span>
      </div>
      <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
        <div>
          <div style="font-size: 1.5rem; font-weight: 900; color: var(--primary);">
            â‚±${parseInt(purchase.amount || 0).toLocaleString()}
          </div>
          <div style="font-size: 0.85rem; color: var(--gray);">
            ${purchase.createdAt?.toDate?.().toLocaleDateString() || 'N/A'}
          </div>
        </div>
        <button class="btn btn-primary" style="padding: 0.6rem 1.2rem;">
          <i class="fa-solid fa-download"></i> Download Assets
        </button>
      </div>
    </div>
  `).join('');
}





// ============================================
// RENDER OFFERS
// ============================================

function renderOffers() {
  const container = document.getElementById('offersList');
  
  if (!container) return;
  
  if (myOffers.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fa-regular fa-handshake"></i>
        <p>No offers made yet</p>
        <p style="font-size: 0.9rem; color: var(--gray);">Browse listings and make offers to sellers</p>
        <br>
        <button class="btn btn-primary" onclick="window.location.href='marketplace.html'">
          <i class="fa-solid fa-store"></i> Browse Marketplace
        </button>
      </div>
    `;
    return;
  }
  
  container.innerHTML = myOffers.map(offer => {
    const statusColors = {
      pending: 'pending',
      accepted: 'accepted',
      rejected: 'rejected',
      countered: 'countered',
      paid: 'paid'
    };
    
    let displayStatus = offer.status;
    if (offer.status === 'paid') {
      displayStatus = 'COMPLETED';
    } else if (offer.fileReviewStatus === 'admin-approved' && offer.status !== 'paid') {
      displayStatus = 'READY FOR PAYMENT';
    } else if (offer.fileReviewStatus === 'pending-admin-review') {
      displayStatus = 'FILES UNDER REVIEW';
    }
    
    const statusClass = statusColors[offer.status] || 'pending';
    const hasApprovedFiles = offer.fileReviewStatus === 'admin-approved';
    
    return `
      <div class="offer-card">
        <div class="offer-card-header">
          <div>
            <div class="offer-title">${offer.listing_name || 'Listing Offer'}</div>
            <div class="offer-subtitle">
              <i class="fa-regular fa-envelope"></i> ${offer.seller_email}
            </div>
          </div>
          <span class="offer-status-badge ${statusClass}">${displayStatus}</span>
        </div>
        
        ${offer.status === 'paid' ? `
  <div class="offer-action-banner success">
    <div class="offer-action-banner-title">
      <i class="fa-solid fa-circle-check" style="color: var(--success);"></i>
      Payment Completed
    </div>
    <div class="offer-action-banner-text">
      Your purchase is complete. ${offer.fileCount || 0} file(s) ready for download.
    </div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-top: 0.75rem;">
      <button class="btn btn-secondary btn-full" 
              onclick="viewPurchasedFiles('${offer.fileReviewId}')">
        <i class="fa-solid fa-folder-open"></i> View Files
      </button>
      <button class="btn btn-success btn-full" 
              onclick="downloadPurchasedFiles('${offer.fileReviewId}')">
        <i class="fa-solid fa-download"></i> Download All
      </button>
    </div>
  </div>
        ` : offer.fileReviewStatus === 'pending-admin-review' ? `
          <div class="offer-action-banner info">
            <div class="offer-action-banner-title">
              <i class="fa-solid fa-clock" style="color: var(--info);"></i>
              Files Under Review
            </div>
            <div class="offer-action-banner-text">
              Seller uploaded ${offer.fileCount || 0} file(s). Admin team is reviewing them now.
            </div>
          </div>
        ` : hasApprovedFiles ? `
          <div class="offer-action-banner success">
            <div class="offer-action-banner-title">
              <i class="fa-solid fa-circle-check" style="color: var(--success);"></i>
              Files Approved
            </div>
            <div class="offer-action-banner-text">
              ${offer.fileCount || 0} file(s) verified and ready. Proceed with payment.
            </div>
            <button class="btn btn-success btn-full" style="margin-top: 0.75rem;" 
                    onclick="proceedToPayment('${offer.id}', '${offer.fileReviewId}')">
              <i class="fa-solid fa-credit-card"></i> Proceed to Payment - â‚±${parseFloat(offer.offer_amount).toLocaleString()}
            </button>
          </div>
        ` : ''}
        
        <div class="offer-amount-section">
          <div class="amount-box">
            <div class="amount-label">Your Offer</div>
            <div class="amount-value">â‚±${parseFloat(offer.offer_amount).toLocaleString()}</div>
          </div>
          ${offer.status === 'countered' ? `
            <div class="amount-box">
              <div class="amount-label">Counter Offer</div>
              <div class="amount-value" style="color: var(--secondary);">â‚±${parseFloat(offer.counter_amount || 0).toLocaleString()}</div>
            </div>
          ` : ''}
        </div>
        
        ${offer.message ? `
          <div class="offer-message-box">
            <div class="offer-message-label">Your Message</div>
            <div class="offer-message-text">${offer.message}</div>
          </div>
        ` : ''}
        
        <div class="offer-footer">
          <div class="offer-date">
            <i class="fa-regular fa-calendar"></i>
            ${new Date(offer.created_at).toLocaleDateString()}
          </div>
          <div class="offer-actions">
            <button class="btn btn-secondary btn-sm" onclick="viewListing('${offer.listing_id}')">
              <i class="fa-regular fa-eye"></i> View Listing
            </button>
            ${offer.status === 'pending' ? `
              <button class="btn btn-sm" style="background: var(--error); color: white;" 
                      onclick="cancelOffer('${offer.id}')">
                <i class="fa-solid fa-xmark"></i> Cancel
              </button>
            ` : ''}
            ${offer.status === 'countered' ? `
              <button class="btn btn-success btn-sm" 
                      onclick="acceptCounterOffer('${offer.id}', '${offer.counter_amount}')">
                <i class="fa-solid fa-check"></i> Accept Counter
              </button>
            ` : ''}
          </div>
        </div>
      </div>
    `;
  }).join('');
}


function renderInvoices() {
  const container = document.getElementById('invoicesList');
  
  console.log('ðŸŽ¨ Rendering invoices:', myInvoices.length);
  console.log('Container found:', !!container);
  
  if (!container) {
    console.error('âŒ invoicesList container not found!');
    return;
  }
  
  if (myInvoices.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fa-regular fa-file-lines"></i>
        <p>No invoices yet</p>
        <p style="font-size: 0.9rem; color: var(--gray);">Your invoices will appear here after completing transactions</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = myInvoices.map(invoice => `
    <div class="invoice-card">
      <div class="invoice-card-header">
        <div>
          <div class="invoice-number">
            <i class="fa-solid fa-file-invoice-dollar"></i> ${invoice.invoiceNumber}
          </div>
          <div style="font-size: 0.875rem; color: var(--gray); margin-top: 0.25rem;">
            ${invoice.items[0]?.description || 'System Purchase'}
          </div>
        </div>
        <span class="offer-status-badge ${invoice.status === 'paid' ? 'paid' : 'pending'}">
          ${invoice.status === 'paid' ? 'PAID' : 'PENDING'}
        </span>
      </div>
      
      <div class="invoice-meta">
        <div class="invoice-meta-item">
          <div class="invoice-meta-label">Issue Date</div>
          <div class="invoice-meta-value">${invoice.issueDate}</div>
        </div>
        <div class="invoice-meta-item">
          <div class="invoice-meta-label">Due Date</div>
          <div class="invoice-meta-value">${invoice.dueDate}</div>
        </div>
        <div class="invoice-meta-item">
          <div class="invoice-meta-label">Amount</div>
          <div class="invoice-meta-value" style="color: var(--primary); font-size: 1.125rem;">
            â‚±${invoice.totalDue.toLocaleString()}
          </div>
        </div>
      </div>
      
      <div class="invoice-footer">
        <div style="font-size: 0.813rem; color: var(--gray);">
          <i class="fa-regular fa-building"></i> ${invoice.seller.companyName}
        </div>
        <button class="btn btn-secondary btn-sm" onclick="viewInvoice('${invoice.id}')">
          <i class="fa-regular fa-file-pdf"></i> View Invoice
        </button>
      </div>
    </div>
  `).join('');
}

window.viewInvoice = function(invoiceId) {
  window.open(`invoice-viewer.html?id=${invoiceId}`, '_blank');
}

















// ============================================
// RENDER MESSAGES
// ============================================

function renderMessages() {
  const container = document.getElementById('messagesList');
  
  if (!container) return;
  
  if (myMessages.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fa-solid fa-envelope-open"></i>
        <p>No messages yet</p>
        <p style="font-size: 0.9rem; color: var(--gray);">Contact sellers about listings you're interested in</p>
        <br>
        <button class="btn btn-primary" onclick="window.location.href='marketplace.html'">
          <i class="fa-solid fa-store"></i> Browse Marketplace
        </button>
      </div>
    `;
    return;
  }
  
  container.innerHTML = myMessages.map(msg => `
    <div class="inquiry-card ${!msg.is_read ? 'unread' : ''}">
      <div class="inquiry-header">
        <div>
          <h4>${msg.subject || 'Message'}</h4>
          <p style="color: var(--gray); font-size: 0.9rem; margin-top: 0.3rem;">
            To: ${msg.seller_email}
          </p>
        </div>
        ${!msg.is_read ? '<span class="inquiry-status pending">NEW</span>' : ''}
      </div>
      
      <div style="margin: 1rem 0; padding: 1rem; background: white; border-radius: 5px;">
        <p style="color: var(--text); line-height: 1.6;">${msg.message}</p>
      </div>
      
      <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; color: var(--gray);">
        <span>
          <i class="fa-solid fa-calendar"></i> 
          ${new Date(msg.created_at).toLocaleDateString()}
        </span>
        <button class="btn btn-secondary" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;" 
                onclick="viewListing('${msg.listing_id}')">
          View Listing
        </button>
      </div>
    </div>
  `).join('');
}





window.proceedToPayment = async function(offerId, fileReviewId) {
  const offer = myOffers.find(o => o.id === offerId);
  if (!offer) {
    showToast('Offer not found', 'error');
    return;
  }
  
  try {
    // Create transaction checkout summary in Firebase
    const transactionData = {
      offerId: offerId,
      fileReviewId: fileReviewId,
      buyerId: userData.id,
      buyerEmail: userData.email,
      buyerName: userData.name,
      sellerId: offer.seller_id,
      sellerEmail: offer.seller_email,
      listingId: offer.listing_id,
      listingName: offer.listing_name,
      amount: parseFloat(offer.offer_amount),
      status: 'pending', // pending, processing, completed, failed
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    };
    
    console.log('ðŸ’³ Creating transaction:', transactionData);
    
    const transactionRef = await addDoc(collection(db, 'transactions'), transactionData);
    
    console.log('âœ… Transaction created:', transactionRef.id);
    
    // Store transaction ID in sessionStorage for checkout page
    sessionStorage.setItem('pendingTransactionId', transactionRef.id);
    
    // Redirect to checkout summary page
    window.location.href = `checkout.html?transaction=${transactionRef.id}`;
    
  } catch (error) {
    console.error('âŒ Error creating transaction:', error);
    showToast('Failed to proceed to payment: ' + error.message, 'error');
  }
}

window.downloadPurchasedFiles = async function(fileReviewId) {
  try {
    // Get the button that triggered this (if called from button)
    const btn = event && event.target ? event.target : null;
    
    if (btn) {
      btn.disabled = true;
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Preparing files...';
    }
    
    console.log('ðŸ“¥ Downloading files for review:', fileReviewId);
    
    // USE BUYER ENDPOINT - GET FILE LIST
    const response = await fetch(`${API_URL}/api/buyer/file-reviews/${fileReviewId}/files`);
    const data = await response.json();
    
    console.log('File list response:', data);
    
    if (!data.success) {
      throw new Error(data.error || 'Failed to fetch files');
    }
    
    if (!data.files || data.files.length === 0) {
      throw new Error('No files available for download');
    }
    
    const files = data.files;
    console.log(`Found ${files.length} files to download`);
    
    // Download each file
    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      
      if (btn) {
        btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Downloading ${i + 1}/${files.length}...`;
      }
      
      try {
        // USE BUYER ENDPOINT FOR DOWNLOAD
        const downloadResponse = await fetch(`${API_URL}/api/buyer/file-reviews/${fileReviewId}/download/${encodeURIComponent(file.filename)}`);
        
        if (!downloadResponse.ok) {
          console.warn(`Failed to download ${file.filename}`);
          continue;
        }
        
        const blob = await downloadResponse.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = file.filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        console.log(`âœ… Downloaded: ${file.filename}`);
        
        // Delay between downloads
        await new Promise(resolve => setTimeout(resolve, 500));
      } catch (err) {
        console.error(`Error downloading ${file.filename}:`, err);
      }
    }
    
    if (btn) {
      btn.disabled = false;
      btn.innerHTML = '<i class="fa-solid fa-check"></i> Downloaded!';
      
      setTimeout(() => {
        btn.innerHTML = '<i class="fa-solid fa-download"></i> Download All Files';
      }, 3000);
    }
    
    showToast(`Successfully downloaded ${files.length} file(s)!`, 'success');
    
  } catch (error) {
    console.error('âŒ Download error:', error);
    showToast('Failed to download files: ' + error.message, 'error');
    
    if (event && event.target) {
      const btn = event.target;
      btn.disabled = false;
      btn.innerHTML = '<i class="fa-solid fa-download"></i> Download All Files';
    }
  }
}

window.viewPurchasedFiles = async function(fileReviewId) {
  try {
    console.log('ðŸ‘ï¸ Viewing files for review:', fileReviewId);
    
    // USE BUYER ENDPOINT - NOT ADMIN ENDPOINT
    const response = await fetch(`${API_URL}/api/buyer/file-reviews/${fileReviewId}/files`);
    const data = await response.json();
    
    if (!data.success || !data.files || data.files.length === 0) {
      throw new Error('No files available');
    }
    
    // Create modal to show file list
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(5px);
      z-index: 3000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    `;
    
    modal.innerHTML = `
      <div style="background: white; border-radius: 16px; max-width: 700px; width: 100%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div style="padding: 2rem; border-bottom: 1px solid var(--gray-light); position: sticky; top: 0; background: white; z-index: 10;">
          <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">
            <i class="fa-solid fa-folder-open" style="color: var(--primary);"></i> 
            Your Purchased Files
          </h2>
          <p style="color: var(--gray); font-size: 0.9rem;">
            ${data.files.length} file(s) ready for download
          </p>
        </div>
        
        <div style="padding: 2rem;">
          ${data.files.map((file, index) => `
            <div style="background: var(--gray-light); padding: 1rem; border-radius: 10px; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
              <div style="flex: 1;">
                <div style="font-weight: 600; margin-bottom: 0.3rem;">
                  <i class="fa-solid fa-file"></i> ${file.filename}
                </div>
                <div style="font-size: 0.85rem; color: var(--gray);">
                  ${(file.size / 1024 / 1024).toFixed(2)} MB
                </div>
              </div>
              <button class="btn btn-primary btn-sm" onclick="downloadSingleFile('${fileReviewId}', '${encodeURIComponent(file.filename)}')">
                <i class="fa-solid fa-download"></i> Download
              </button>
            </div>
          `).join('')}
          
          ${data.instructions ? `
            <div style="background: rgba(59, 130, 246, 0.1); padding: 1.5rem; border-radius: 10px; border-left: 4px solid var(--info); margin-top: 1.5rem;">
              <h4 style="margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fa-solid fa-info-circle"></i> Transfer Instructions
              </h4>
              <p style="white-space: pre-wrap; line-height: 1.6; font-size: 0.9rem;">${data.instructions}</p>
            </div>
          ` : ''}
        </div>
        
        <div style="padding: 1.5rem; border-top: 1px solid var(--gray-light); display: flex; gap: 1rem; justify-content: flex-end;">
          <button class="btn btn-secondary" onclick="this.closest('div[style*=\"fixed\"]').remove()">
            Close
          </button>
          <button class="btn btn-primary" onclick="downloadPurchasedFiles('${fileReviewId}')">
            <i class="fa-solid fa-download"></i> Download All Files
          </button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // Close on backdrop click
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
    
  } catch (error) {
    console.error('Error viewing files:', error);
    showToast('Failed to load files: ' + error.message, 'error');
  }
}
window.downloadSingleFile = async function(fileReviewId, filename) {
  try {
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Downloading...';
    
    // USE BUYER ENDPOINT
    const response = await fetch(`${API_URL}/api/buyer/file-reviews/${fileReviewId}/download/${filename}`);
    
    if (!response.ok) throw new Error('Download failed');
    
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = decodeURIComponent(filename);
    a.click();
    window.URL.revokeObjectURL(url);
    
    btn.disabled = false;
    btn.innerHTML = '<i class="fa-solid fa-check"></i> Downloaded!';
    
    setTimeout(() => {
      btn.innerHTML = '<i class="fa-solid fa-download"></i> Download';
    }, 2000);
    
    showToast('File downloaded successfully!', 'success');
    
  } catch (error) {
    console.error('Download error:', error);
    showToast('Failed to download file', 'error');
    
    const btn = event.target;
    btn.disabled = false;
    btn.innerHTML = '<i class="fa-solid fa-download"></i> Download';
  }
}


window.viewPurchasedFiles = async function(fileReviewId) {
  try {
    console.log('ðŸ‘ï¸ Viewing files for review:', fileReviewId);
    
    const response = await fetch(`${API_URL}/api/buyer/file-reviews/${fileReviewId}/files`);
    const data = await response.json();
    
    if (!data.success || !data.files || data.files.length === 0) {
      throw new Error('No files available');
    }
    
    // Create modal to show file list WITH FILE VIEWER
    const modal = document.createElement('div');
    modal.id = 'fileViewerModal';
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(5px);
      z-index: 3000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    `;
    
    modal.innerHTML = `
      <div style="background: white; border-radius: 16px; max-width: 900px; width: 100%; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div style="padding: 2rem; border-bottom: 1px solid var(--gray-light); flex-shrink: 0;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">
                <i class="fa-solid fa-folder-open" style="color: var(--primary);"></i> 
                Your Purchased Files
              </h2>
              <p style="color: var(--gray); font-size: 0.9rem;">
                ${data.files.length} file(s) ready for download
              </p>
            </div>
            <button onclick="document.getElementById('fileViewerModal').remove()" style="background: var(--gray-light); border: none; width: 40px; height: 40px; border-radius: 8px; cursor: pointer; font-size: 1.5rem; color: var(--gray-dark);">Ã—</button>
          </div>
        </div>
        
        <div style="padding: 2rem; overflow-y: auto; flex: 1;">
          ${data.files.map((file, index) => `
            <div style="background: var(--gray-light); padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="flex: 1;">
                  <div style="font-weight: 600; margin-bottom: 0.3rem;">
                    <i class="fa-solid fa-file"></i> ${file.filename}
                  </div>
                  <div style="font-size: 0.85rem; color: var(--gray);">
                    ${(file.size / 1024 / 1024).toFixed(2)} MB â€¢ ${file.type || 'Unknown type'}
                  </div>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                  <button class="btn btn-secondary btn-sm" onclick="viewSingleFile('${fileReviewId}', '${encodeURIComponent(file.filename)}', '${file.type || ''}')">
                    <i class="fa-solid fa-eye"></i> View
                  </button>
                  <button class="btn btn-primary btn-sm" onclick="downloadSingleFile('${fileReviewId}', '${encodeURIComponent(file.filename)}')">
                    <i class="fa-solid fa-download"></i> Download
                  </button>
                </div>
              </div>
            </div>
          `).join('')}
          
          ${data.instructions ? `
            <div style="background: rgba(59, 130, 246, 0.1); padding: 1.5rem; border-radius: 10px; border-left: 4px solid var(--info); margin-top: 1.5rem;">
              <h4 style="margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fa-solid fa-info-circle"></i> Transfer Instructions
              </h4>
              <p style="white-space: pre-wrap; line-height: 1.6; font-size: 0.9rem;">${data.instructions}</p>
            </div>
          ` : ''}
        </div>
        
        <div style="padding: 1.5rem; border-top: 1px solid var(--gray-light); display: flex; gap: 1rem; justify-content: flex-end; flex-shrink: 0;">
          <button class="btn btn-secondary" onclick="document.getElementById('fileViewerModal').remove()">
            Close
          </button>
          <button class="btn btn-primary" onclick="downloadPurchasedFiles('${fileReviewId}')">
            <i class="fa-solid fa-download"></i> Download All Files
          </button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // Close on backdrop click
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
    
  } catch (error) {
    console.error('Error viewing files:', error);
    showToast('Failed to load files: ' + error.message, 'error');
  }
}


window.viewSingleFile = async function(fileReviewId, filename, fileType) {
  try {
    const decodedFilename = decodeURIComponent(filename);
    console.log('ðŸ‘ï¸ Viewing file:', decodedFilename);
    
    // Create viewer modal
    const viewerModal = document.createElement('div');
    viewerModal.id = 'singleFileViewerModal';
    viewerModal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(5px);
      z-index: 3001;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    `;
    
    viewerModal.innerHTML = `
      <div style="background: white; border-radius: 16px; max-width: 1200px; width: 100%; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div style="padding: 1.5rem; border-bottom: 1px solid var(--gray-light); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
          <h3 style="font-size: 1.2rem; font-weight: 700; margin: 0;">
            <i class="fa-solid fa-file"></i> ${decodedFilename}
          </h3>
          <button onclick="document.getElementById('singleFileViewerModal').remove()" style="background: var(--gray-light); border: none; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; font-size: 1.5rem; color: var(--gray-dark);">Ã—</button>
        </div>
        
        <div id="singleFileViewerBody" style="padding: 2rem; overflow-y: auto; flex: 1;">
          <div style="text-align: center; padding: 3rem;">
            <div class="loader"></div>
            <p style="margin-top: 1rem; color: var(--gray);">Loading file...</p>
          </div>
        </div>
        
        <div style="padding: 1.5rem; border-top: 1px solid var(--gray-light); display: flex; gap: 1rem; justify-content: flex-end; flex-shrink: 0;">
          <button class="btn btn-secondary" onclick="document.getElementById('singleFileViewerModal').remove()">Close</button>
          <button class="btn btn-primary" onclick="downloadSingleFile('${fileReviewId}', '${filename}')">
            <i class="fa-solid fa-download"></i> Download
          </button>
        </div>
      </div>
    `;
    
    document.body.appendChild(viewerModal);
    
    // Fetch and display file
    const response = await fetch(`${API_URL}/api/buyer/file-reviews/${fileReviewId}/view/${filename}`);
    const data = await response.json();
    
    if (!data.success) throw new Error(data.error || 'Failed to load file');
    
    const body = document.getElementById('singleFileViewerBody');
    const fileExtension = decodedFilename.split('.').pop().toLowerCase();
    
    // Render based on file type (same logic as admin dashboard)
    if (fileType.startsWith('image/')) {
      body.innerHTML = `
        <div style="text-align: center;">
          <img src="data:${fileType};base64,${data.data}" 
               alt="${decodedFilename}" 
               style="max-width: 100%; height: auto; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
        </div>
      `;
    } else if (fileType === 'application/pdf' || fileExtension === 'pdf') {
      body.innerHTML = `
        <iframe src="data:application/pdf;base64,${data.data}" 
                style="width: 100%; height: 600px; border: none; border-radius: 10px;">
        </iframe>
        <p style="text-align: center; color: var(--gray); margin-top: 1rem;">
          If PDF doesn't display, click the download button.
        </p>
      `;
    } else if (fileType.startsWith('text/') || ['txt', 'md', 'json', 'xml', 'csv', 'log'].includes(fileExtension)) {
      const textContent = atob(data.data);
      body.innerHTML = `
        <pre style="background: #1e1e1e; color: #d4d4d4; padding: 1.5rem; border-radius: 10px; overflow-x: auto; max-height: 600px; font-family: 'Courier New', monospace; font-size: 0.9rem;">${escapeHtml(textContent)}</pre>
      `;
    } else if (['js', 'jsx', 'ts', 'tsx', 'py', 'java', 'cpp', 'c', 'php', 'rb', 'go', 'rs', 'swift', 'kt'].includes(fileExtension)) {
      const codeContent = atob(data.data);
      body.innerHTML = `
        <div style="background: #1e1e1e; padding: 1.5rem; border-radius: 10px; overflow-x: auto; max-height: 600px;">
          <div style="color: #6a9955; margin-bottom: 0.5rem;">// ${decodedFilename}</div>
          <pre style="color: #d4d4d4; font-family: 'Courier New', monospace; font-size: 0.9rem; margin: 0;">${escapeHtml(codeContent)}</pre>
        </div>
      `;
    } else if (fileType.startsWith('video/')) {
      body.innerHTML = `
        <div style="text-align: center;">
          <video controls style="max-width: 100%; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
            <source src="data:${fileType};base64,${data.data}" type="${fileType}">
            Your browser doesn't support video playback.
          </video>
        </div>
      `;
    } else {
      body.innerHTML = `
        <div style="text-align: center; padding: 3rem;">
          <div style="font-size: 4rem; margin-bottom: 1rem;">ðŸ“„</div>
          <h3>Preview Not Available</h3>
          <p style="color: var(--gray);">This file type (${fileType || fileExtension}) cannot be previewed.</p>
          <p style="font-size: 0.9rem; color: var(--gray); margin-top: 0.5rem;">
            <strong>File:</strong> ${decodedFilename}<br>
            <strong>Size:</strong> ${(data.size / 1024 / 1024).toFixed(2)} MB
          </p>
          <button class="btn btn-primary" onclick="downloadSingleFile('${fileReviewId}', '${filename}')" style="margin-top: 1rem;">
            <i class="fa-solid fa-download"></i> Download to View
          </button>
        </div>
      `;
    }
    
    // Close on backdrop click
    viewerModal.addEventListener('click', (e) => {
      if (e.target === viewerModal) viewerModal.remove();
    });
    
  } catch (error) {
    console.error('Error viewing file:', error);
    showToast('Failed to view file: ' + error.message, 'error');
    const modal = document.getElementById('singleFileViewerModal');
    if (modal) modal.remove();
  }
}










async function downloadFile(reviewId, filename) {
  try {
    const response = await fetch(`${API_URL}/api/admin/download-file/${reviewId}/${encodeURIComponent(filename)}`);
    
    if (!response.ok) throw new Error('Download failed');
    
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    window.URL.revokeObjectURL(url);
    
  } catch (error) {
    console.error('Download error for ' + filename + ':', error);
    throw error;
  }
}














// ============================================
// OFFER ACTIONS
// ============================================

window.cancelOffer = async function(offerId) {
  if (!confirm('Are you sure you want to cancel this offer?')) return;
  
  try {
    const response = await fetch(`${API_URL}/api/offers/${offerId}`, {
      method: 'DELETE'
    });
    
    const data = await response.json();
    
    if (data.success) {
      showToast('Offer cancelled successfully', 'success');
      await loadOffers();
      renderOffers();
      updateStats();
    } else {
      throw new Error(data.error || 'Failed to cancel offer');
    }
  } catch (error) {
    console.error('Error cancelling offer:', error);
    showToast('Failed to cancel offer', 'error');
  }
}

window.acceptCounterOffer = async function(offerId, counterAmount) {
  if (!confirm(`Accept the counter offer of â‚±${parseFloat(counterAmount).toLocaleString()}?`)) return;
  
  try {
    const response = await fetch(`${API_URL}/api/offers/${offerId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        status: 'accepted',
        offerAmount: counterAmount
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      showToast('Counter offer accepted!', 'success');
      await loadOffers();
      renderOffers();
      updateStats();
    } else {
      throw new Error(data.error || 'Failed to accept counter offer');
    }
  } catch (error) {
    console.error('Error accepting counter offer:', error);
    showToast('Failed to accept counter offer', 'error');
  }
}










// ============================================
// UPDATE RECENTLY VIEWED
// ============================================

function updateRecentlyViewed() {
  const container = document.getElementById('recentlyViewed');
  
  if (!userData.recentlyViewed || userData.recentlyViewed.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fa-solid fa-clock-rotate-left"></i>
        <p>No recently viewed listings</p>
      </div>
    `;
    return;
  }
  
  const recentIds = userData.recentlyViewed.slice(0, 3);
  const recentListings = allListings.filter(l => recentIds.includes(l.id));
  
  container.innerHTML = `
    <div class="listing-grid">
      ${recentListings.map(listing => `
        <div class="listing-card" onclick="viewListing('${listing.id}')">
          <img src="${listing.mainImage || 'https://via.placeholder.com/400x200'}" 
               alt="${listing.systemName}" 
               class="listing-image">
          <div class="listing-content">
            <h3 class="listing-title">${listing.systemName || 'Untitled'}</h3>
            <p class="listing-description">${listing.shortDescription || 'No description available'}</p>
            <div class="listing-footer">
              <div class="listing-price">â‚±${parseInt(listing.askingPrice || 0).toLocaleString()}</div>
              <div class="listing-category">${listing.categoryName || listing.category}</div>
            </div>
          </div>
        </div>
      `).join('')}
    </div>
  `;
}

// ============================================
// SEARCH AND FILTERS
// ============================================

function setupSearchAndFilters() {
  const searchInput = document.getElementById('searchInput');
  const filterButtons = document.querySelectorAll('.filter-btn');
  
  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      filterListings(searchTerm, getCurrentCategory());
    });
  }
  
  filterButtons.forEach(btn => {
    btn.addEventListener('click', (e) => {
      filterButtons.forEach(b => b.classList.remove('active'));
      e.target.classList.add('active');
      
      const category = e.target.dataset.category;
      const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
      filterListings(searchTerm, category);
    });
  });
}

function getCurrentCategory() {
  const activeBtn = document.querySelector('.filter-btn.active');
  return activeBtn ? activeBtn.dataset.category : 'all';
}

function filterListings(searchTerm, category) {
  let filtered = allListings;
  
  // Filter by category
  if (category !== 'all') {
    filtered = filtered.filter(l => l.category === category);
  }
  
  // Filter by search term
  if (searchTerm) {
    filtered = filtered.filter(l => 
      (l.systemName || '').toLowerCase().includes(searchTerm) ||
      (l.shortDescription || '').toLowerCase().includes(searchTerm) ||
      (l.detailedDescription || '').toLowerCase().includes(searchTerm)
    );
  }
  
  // Re-render
  const container = document.getElementById('marketplaceListings');
  if (filtered.length === 0) {
    container.innerHTML = `
      <div class="empty-state" style="grid-column: 1 / -1;">
        <i class="fa-solid fa-search"></i>
        <p>No listings found</p>
        <p style="font-size: 0.9rem; color: var(--gray);">Try adjusting your search or filters</p>
      </div>
    `;
  } else {
    container.innerHTML = filtered.map(listing => `
      <div class="listing-card" onclick="viewListing('${listing.id}')" style="position: relative;">
        <button class="favorite-btn ${isSaved(listing.id) ? 'active' : ''}" 
                onclick="event.stopPropagation(); toggleSave('${listing.id}')">
          <i class="fa-${isSaved(listing.id) ? 'solid' : 'regular'} fa-heart"></i>
        </button>
        <img src="${listing.mainImage || 'https://via.placeholder.com/400x200'}" 
             alt="${listing.systemName}" 
             class="listing-image">
        <div class="listing-content">
          <h3 class="listing-title">${listing.systemName || 'Untitled'}</h3>
          <p class="listing-description">${listing.shortDescription || 'No description available'}</p>
          <div class="listing-footer">
            <div class="listing-price">â‚±${parseInt(listing.askingPrice || 0).toLocaleString()}</div>
            <div class="listing-category">${listing.categoryName || listing.category}</div>
          </div>
        </div>
      </div>
    `).join('');
  }
}

// ============================================
// HELPER FUNCTIONS
// ============================================

function isSaved(listingId) {
  return userData.savedListings && userData.savedListings.includes(listingId);
}

window.toggleSave = async function(listingId) {
  try {
    const userRef = doc(db, 'users', userData.id);
    let newSavedListings = userData.savedListings || [];
    
    if (isSaved(listingId)) {
      // Remove from saved
      newSavedListings = newSavedListings.filter(id => id !== listingId);
      showToast('Removed from saved listings', 'info');
    } else {
      // Add to saved
      newSavedListings.push(listingId);
      showToast('Added to saved listings', 'success');
    }
    
    await updateDoc(userRef, {
      savedListings: newSavedListings,
      updatedAt: serverTimestamp()
    });
    
    userData.savedListings = newSavedListings;
    await loadSavedListings();
    updateStats();
    renderMarketplace();
    renderSavedListings();
    
  } catch (error) {
    console.error('Error toggling save:', error);
    showToast('Failed to update saved listings', 'error');
  }
}

window.viewListing = function(listingId) {
  // Track view in recently viewed
  if (!userData.recentlyViewed) {
    userData.recentlyViewed = [];
  }
  
  // Remove if already exists, then add to front
  userData.recentlyViewed = userData.recentlyViewed.filter(id => id !== listingId);
  userData.recentlyViewed.unshift(listingId);
  userData.recentlyViewed = userData.recentlyViewed.slice(0, 10); // Keep only last 10
  
  // Update in Firestore
  updateDoc(doc(db, 'users', userData.id), {
    recentlyViewed: userData.recentlyViewed,
    updatedAt: serverTimestamp()
  }).catch(err => console.error('Error updating recently viewed:', err));
  
  // Navigate to listing detail page
  window.open(`listing-detail.html?id=${listingId}`, '_blank');
}

// ============================================
// ROI CALCULATOR
// ============================================

window.calculateROI = function() {
  const purchasePrice = parseFloat(document.getElementById('calcPurchasePrice').value) || 0;
  const monthlyRevenue = parseFloat(document.getElementById('calcMonthlyRevenue').value) || 0;
  const operatingCosts = parseFloat(document.getElementById('calcOperatingCosts').value) || 0;
  const growthRate = parseFloat(document.getElementById('calcGrowthRate').value) || 0;
  const period = parseInt(document.getElementById('calcPeriod').value) || 12;
  
  if (purchasePrice <= 0 || monthlyRevenue <= 0) {
    showToast('Please enter valid purchase price and monthly revenue', 'error');
    return;
  }
  
  // Calculate monthly net profit
  const monthlyProfit = monthlyRevenue - operatingCosts;
  
  // Calculate annual return
  const annualReturn = monthlyProfit * 12;
  
  // Calculate ROI percentage
  const roiPercentage = ((annualReturn / purchasePrice) * 100).toFixed(1);
  
  // Calculate break-even period
  const breakEvenMonths = Math.ceil(purchasePrice / monthlyProfit);
  
  // Calculate total return over period with growth
  let totalReturn = 0;
  let currentMonthlyProfit = monthlyProfit;
  
  for (let i = 0; i < period; i++) {
    totalReturn += currentMonthlyProfit;
    currentMonthlyProfit *= (1 + (growthRate / 100));
  }
  
  // Update results
  document.getElementById('resultMonthlyProfit').textContent = `â‚±${monthlyProfit.toLocaleString()}`;
  document.getElementById('resultAnnualReturn').textContent = `â‚±${annualReturn.toLocaleString()}`;
  document.getElementById('resultROI').textContent = `${roiPercentage}%`;
  document.getElementById('resultBreakEven').textContent = `${breakEvenMonths} months`;
  document.getElementById('resultTotalReturn').textContent = `â‚±${Math.round(totalReturn).toLocaleString()}`;
  
  // Generate analysis
  let analysis = '';
  if (roiPercentage >= 50) {
    analysis = 'Excellent ROI! This investment could provide strong returns. The business appears to have healthy profit margins and quick payback period.';
  } else if (roiPercentage >= 30) {
    analysis = 'Good ROI. This is a solid investment opportunity with reasonable returns. Consider conducting thorough due diligence.';
  } else if (roiPercentage >= 15) {
    analysis = 'Moderate ROI. Returns are acceptable but may require patience. Evaluate growth potential and sustainability carefully.';
  } else if (roiPercentage > 0) {
    analysis = 'Low ROI. Returns are modest. Consider negotiating the purchase price or exploring other opportunities.';
  } else {
    analysis = 'Negative ROI. Operating costs exceed revenue. This investment would result in ongoing losses - not recommended.';
  }
  
  if (breakEvenMonths <= 12) {
    analysis += ` Break-even within ${breakEvenMonths} months is favorable.`;
  } else if (breakEvenMonths <= 24) {
    analysis += ` Break-even period of ${breakEvenMonths} months requires medium-term commitment.`;
  } else {
    analysis += ` Extended break-even period of ${breakEvenMonths} months requires careful consideration.`;
  }
  
  document.getElementById('resultAnalysis').textContent = analysis;
  
  // Show results
  document.getElementById('calculatorResults').style.display = 'block';
  document.getElementById('calculatorResults').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  
  showToast('ROI calculated successfully!', 'success');
}

window.resetCalculator = function() {
  document.getElementById('calculatorForm').reset();
  document.getElementById('calculatorResults').style.display = 'none';
}

// ============================================
// NAVIGATION
// ============================================

window.navigateTo = function(page) {
  // Update sidebar navigation
  document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
  event?.target.closest('.nav-item')?.classList.add('active');
  
  const pageTitles = {
  overview: 'Overview',
  marketplace: 'Marketplace',
  saved: 'Saved Listings',
  calculator: 'ROI Calculator',
  offers: 'My Offers',
  invoices: 'Invoice History',
  inquiries: 'My Inquiries',
  purchases: 'Purchase History',
  settings: 'Settings'
};
  
  document.getElementById('pageTitle').textContent = pageTitles[page] || 'Dashboard';
  
  // Show the correct tab content
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });
  
  const selectedTab = document.getElementById(`tab-${page}`);
  if (selectedTab) {
    selectedTab.classList.add('active');
  }
}

// ============================================
// SETTINGS
// ============================================

window.saveSettings = async function(event) {
  event.preventDefault();
  
  const name = document.getElementById('settingsName').value.trim();
  const phone = document.getElementById('settingsPhone').value.trim();
  const location = document.getElementById('settingsLocation').value.trim();
  
  try {
    await updateDoc(doc(db, 'users', userData.id), {
      name,
      'profile.phone': phone,
      'profile.location': location,
      updatedAt: serverTimestamp()
    });
    
    // Update local data
    userData.name = name;
    userData.profile = { 
      ...userData.profile, 
      phone, 
      location 
    };
    
    updateUserProfile();
    showToast('Settings saved successfully!', 'success');
    
  } catch (error) {
    console.error('Error saving settings:', error);
    showToast('Failed to save settings. Please try again.', 'error');
  }
}

window.resetSettings = function() {
  document.getElementById('settingsName').value = userData.name;
  document.getElementById('settingsEmail').value = userData.email;
  document.getElementById('settingsPhone').value = userData.profile?.phone || '';
  document.getElementById('settingsLocation').value = userData.profile?.location || '';
  
  showToast('Settings reset', 'info');
}

// ============================================
// TOAST NOTIFICATIONS
// ============================================

function showToast(message, type = 'info') {
  // Remove existing toasts
  document.querySelectorAll('.toast').forEach(t => t.remove());
  
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  
  const icon = type === 'success' ? 'fa-check-circle' : 
               type === 'error' ? 'fa-exclamation-circle' : 
               type === 'info' ? 'fa-info-circle' : 'fa-bell';
  
  toast.innerHTML = `
    <i class="fa-solid ${icon}" style="font-size: 1.5rem;"></i>
    <div>
      <strong>${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
      <div style="font-size: 0.9rem;">${message}</div>
    </div>
  `;
  
  document.body.appendChild(toast);
  
  // Auto remove after 4 seconds
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease-out forwards';
    setTimeout(() => toast.remove(), 300);
  }, 4000);
}

// Add slideOut animation
const style = document.createElement('style');
style.textContent = `
  @keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(400px); opacity: 0; }
  }
`;
document.head.appendChild(style);

// ============================================
// LOGOUT
// ============================================

window.logout = async function() {
  if (confirm('Are you sure you want to sign out?')) {
    try {
      // Unsubscribe from listeners
      if (listingsUnsubscribe) {
        listingsUnsubscribe();
      }
      
      await signOut(auth);
      window.location.href = 'index.html';
    } catch (error) {
      console.error('Error signing out:', error);
      showToast('Failed to sign out. Please try again.', 'error');
    }
  }
}

// ============================================
// CLEANUP ON PAGE UNLOAD
// ============================================

window.addEventListener('beforeunload', () => {
  if (listingsUnsubscribe) {
    listingsUnsubscribe();
  }
});

// ============================================
// INITIALIZE ON SETTINGS TAB
// ============================================

window.addEventListener('DOMContentLoaded', () => {
  // Wait for user data to load
  const checkUserData = setInterval(() => {
    if (userData && document.body.classList.contains('loaded')) {
      clearInterval(checkUserData);
      
      // Populate settings form
      const settingsName = document.getElementById('settingsName');
      const settingsEmail = document.getElementById('settingsEmail');
      const settingsPhone = document.getElementById('settingsPhone');
      const settingsLocation = document.getElementById('settingsLocation');
      
      if (settingsName) settingsName.value = userData.name;
      if (settingsEmail) settingsEmail.value = userData.email;
      if (settingsPhone) settingsPhone.value = userData.profile?.phone || '';
      if (settingsLocation) settingsLocation.value = userData.profile?.location || '';
    }
  }, 100);
  
  // Clear after 10 seconds to prevent infinite loop
  setTimeout(() => clearInterval(checkUserData), 10000);
});

console.log('ðŸš€ Systemly Buyer Dashboard - Complete Version Loaded');

// ============================================
// MOBILE MENU FUNCTIONALITY
// ============================================

function initMobileMenu() {
  const sidebar = document.querySelector('.sidebar');
  const mobileMenuToggle = document.getElementById('mobileMenuToggle');
  
  // Create overlay
  const overlay = document.createElement('div');
  overlay.className = 'mobile-overlay';
  document.body.appendChild(overlay);
  
  // Toggle menu
  function toggleMenu() {
    sidebar.classList.toggle('mobile-active');
    overlay.classList.toggle('active');
    document.body.style.overflow = sidebar.classList.contains('mobile-active') ? 'hidden' : '';
  }
  
  // Close menu
  function closeMenu() {
    sidebar.classList.remove('mobile-active');
    overlay.classList.remove('active');
    document.body.style.overflow = '';
  }
  
  // Event listeners
  if (mobileMenuToggle) {
    mobileMenuToggle.addEventListener('click', toggleMenu);
  }
  
  overlay.addEventListener('click', closeMenu);
  
  // Close menu when clicking nav items
  document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', () => {
      setTimeout(closeMenu, 100);
    });
  });
  
  // Close menu on window resize if > 1024px
  window.addEventListener('resize', () => {
    if (window.innerWidth > 1024) {
      closeMenu();
    }
  });
}

// Initialize mobile menu when dashboard loads
const initMobileInterval = setInterval(() => {
  if (document.body.classList.contains('loaded')) {
    clearInterval(initMobileInterval);
    initMobileMenu();
    console.log('ðŸ“± Mobile menu initialized');
  }
}, 100);

// Timeout fallback
setTimeout(() => clearInterval(initMobileInterval), 10000);












</script>

</body>
</html>
