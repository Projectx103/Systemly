<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Buyer Dashboard - Systemly</title>
<link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;600;700;900&family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous">

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --primary: #F97316;
  --secondary: #6366F1;
  --accent: #14B8A6;
  --bg: #FFF7ED;
  --text: #1F2937;
  --white: #FFFFFF;
  --gray-light: #F3F4F6;
  --gray: #6B7280;
  --gray-dark: #374151;
  --success: #10B981;
  --warning: #F59E0B;
  --error: #EF4444;
  --info: #3B82F6;
}

body {
  font-family: 'Sarabun', sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  opacity: 0;
  transition: opacity 0.3s;
}

body.loaded { opacity: 1; }

h1,h2,h3,h4,h5,h6 { font-family: 'Archivo', sans-serif; }

/* Loading Screen */
.loading-screen {
  position: fixed;
  inset: 0;
  background: var(--bg);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 1rem;
  z-index: 9999;
}

.loading-screen.hidden { display: none; }

.loader {
  width: 50px;
  height: 50px;
  border: 4px solid var(--gray-light);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

/* Dashboard Layout */
.dashboard-layout {
  display: grid;
  grid-template-columns: 280px 1fr;
  min-height: 100vh;
}

.sidebar {
  background: var(--white);
  border-right: 1px solid var(--gray-light);
  position: sticky;
  top: 0;
  height: 100vh;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

.sidebar-header {
  padding: 2rem 1.5rem;
  border-bottom: 1px solid var(--gray-light);
}

.logo {
  font-family: 'Archivo', sans-serif;
  font-size: 2rem;
  font-weight: 900;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-decoration: none;
  display: block;
}

.user-profile {
  padding: 1.5rem;
  border-bottom: 1px solid var(--gray-light);
}

.user-profile-content {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1rem;
}

.user-avatar {
  width: 50px;
  height: 50px;
  min-width: 50px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--secondary), var(--accent));
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--white);
  font-weight: 700;
  font-size: 1.2rem;
  flex-shrink: 0;
}

.user-details {
  flex: 1;
  min-width: 0;
}

.user-name {
  font-weight: 600;
  font-size: 1rem;
  margin-bottom: 0.2rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.user-email {
  font-size: 0.85rem;
  color: var(--gray);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.role-badge {
  padding: 0.4rem 0.8rem;
  border-radius: 50px;
  font-size: 0.85rem;
  font-weight: 600;
  background: linear-gradient(135deg, var(--secondary), var(--accent));
  color: var(--white);
  display: inline-block;
}

.sidebar-nav {
  flex: 1;
  padding: 1rem 0;
}

.nav-section {
  margin-bottom: 1.5rem;
}

.nav-section-title {
  padding: 0.5rem 1.5rem;
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--gray);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 0.8rem;
  padding: 0.8rem 1.5rem;
  color: var(--text);
  text-decoration: none;
  transition: all 0.2s;
  position: relative;
  cursor: pointer;
}

.nav-item:hover {
  background: var(--bg);
  color: var(--secondary);
}

.nav-item.active {
  background: linear-gradient(to right, rgba(99, 102, 241, 0.1), transparent);
  color: var(--secondary);
  font-weight: 600;
}

.nav-item.active::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 4px;
  background: linear-gradient(180deg, var(--secondary), var(--accent));
}

.nav-item i {
  width: 20px;
  text-align: center;
  font-size: 1.1rem;
}

.nav-item .badge {
  margin-left: auto;
  background: var(--error);
  color: white;
  padding: 0.2rem 0.5rem;
  border-radius: 50px;
  font-size: 0.75rem;
  font-weight: 700;
}

.sidebar-footer {
  padding: 1.5rem;
  border-top: 1px solid var(--gray-light);
}

.logout-btn {
  width: 100%;
  padding: 0.8rem;
  background: var(--error);
  color: var(--white);
  border: none;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  font-family: 'Sarabun', sans-serif;
  font-size: 1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

.logout-btn:hover {
  background: #dc2626;
  transform: translateY(-2px);
}

/* Main Content */
.main-content {
  overflow-y: auto;
  height: 100vh;
}

.top-bar {
  background: var(--white);
  padding: 1.5rem 2rem;
  border-bottom: 1px solid var(--gray-light);
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 100;
}

.page-title {
  font-size: 1.8rem;
  font-weight: 900;
}

.top-bar-actions {
  display: flex;
  gap: 1rem;
  align-items: center;
}

.content-area {
  padding: 2rem;
}

/* Tab Content */
.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
  animation: fadeIn 0.4s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.stat-card {
  background: var(--white);
  padding: 2rem;
  border-radius: 15px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.06);
  transition: transform 0.3s;
}

.stat-card:hover { transform: translateY(-5px); }

.stat-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.stat-icon {
  width: 50px;
  height: 50px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
}

.stat-icon.primary {
  background: rgba(249, 115, 22, 0.1);
  color: var(--primary);
}

.stat-icon.secondary {
  background: rgba(99, 102, 241, 0.1);
  color: var(--secondary);
}

.stat-icon.accent {
  background: rgba(20, 184, 166, 0.1);
  color: var(--accent);
}

.stat-icon.success {
  background: rgba(16, 185, 129, 0.1);
  color: var(--success);
}

.stat-value {
  font-size: 2rem;
  font-weight: 900;
  color: var(--text);
  margin-bottom: 0.3rem;
}

.stat-label {
  color: var(--gray);
  font-size: 0.9rem;
}

/* Content Cards */
.content-card {
  background: var(--white);
  padding: 2rem;
  border-radius: 15px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.06);
  margin-bottom: 2rem;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--gray-light);
}

.card-header h3 {
  font-size: 1.5rem;
  font-weight: 700;
}

.card-action {
  color: var(--primary);
  text-decoration: none;
  font-weight: 600;
  transition: color 0.3s;
  cursor: pointer;
  background: none;
  border: none;
  font-family: 'Sarabun', sans-serif;
  font-size: 1rem;
}

.card-action:hover { color: var(--secondary); }

/* Listing Grid */
.listing-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 1.5rem;
}

.listing-card {
  background: var(--white);
  border-radius: 15px;
  overflow: hidden;
  box-shadow: 0 4px 15px rgba(0,0,0,0.06);
  transition: all 0.3s;
  cursor: pointer;
}

.listing-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.12);
}

.listing-image {
  width: 100%;
  height: 200px;
  object-fit: cover;
}

.listing-content {
  padding: 1.5rem;
}

.listing-title {
  font-size: 1.2rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
}

.listing-description {
  color: var(--gray);
  font-size: 0.9rem;
  margin-bottom: 1rem;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.listing-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 1rem;
  border-top: 1px solid var(--gray-light);
}

.listing-price {
  font-size: 1.3rem;
  font-weight: 900;
  color: var(--primary);
}

.listing-category {
  font-size: 0.85rem;
  color: var(--gray);
  padding: 0.3rem 0.8rem;
  background: var(--gray-light);
  border-radius: 50px;
}

.favorite-btn {
  position: absolute;
  top: 1rem;
  right: 1rem;
  background: white;
  border: none;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.favorite-btn:hover {
  transform: scale(1.1);
  background: var(--error);
  color: white;
}

.favorite-btn.active {
  background: var(--error);
  color: white;
}

/* ROI Calculator */
.calculator-form {
  display: grid;
  gap: 1.5rem;
}

.form-group {
  margin-bottom: 1rem;
}

.form-label {
  display: block;
  font-weight: 600;
  margin-bottom: 0.5rem;
  color: var(--text);
}

.form-input, .form-select {
  width: 100%;
  padding: 0.8rem 1rem;
  border: 2px solid var(--gray-light);
  border-radius: 10px;
  font-family: 'Sarabun', sans-serif;
  font-size: 1rem;
  transition: all 0.3s;
}

.form-input:focus, .form-select:focus {
  outline: none;
  border-color: var(--secondary);
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.calculator-results {
  background: linear-gradient(135deg, var(--secondary), var(--accent));
  color: white;
  padding: 2rem;
  border-radius: 15px;
  margin-top: 2rem;
}

.result-item {
  display: flex;
  justify-content: space-between;
  padding: 1rem 0;
  border-bottom: 1px solid rgba(255,255,255,0.2);
}

.result-item:last-child {
  border-bottom: none;
}

.result-label {
  font-size: 1rem;
  opacity: 0.9;
}

.result-value {
  font-size: 1.5rem;
  font-weight: 900;
}

/* Button Styles */
.btn {
  padding: 0.8rem 1.5rem;
  border: none;
  border-radius: 10px;
  font-family: 'Sarabun', sans-serif;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: var(--white);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(249, 115, 22, 0.4);
}

.btn-secondary {
  background: var(--gray-light);
  color: var(--text);
}

.btn-secondary:hover {
  background: var(--gray);
  color: var(--white);
}

.btn-success {
  background: var(--success);
  color: var(--white);
}

.btn-full {
  width: 100%;
  justify-content: center;
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: 3rem;
  color: var(--gray);
}

.empty-state i {
  font-size: 3rem;
  margin-bottom: 1rem;
  display: block;
  opacity: 0.3;
}

/* Search Bar */
.search-bar {
  position: relative;
  margin-bottom: 2rem;
}

.search-input {
  width: 100%;
  padding: 1rem 3rem 1rem 1rem;
  border: 2px solid var(--gray-light);
  border-radius: 50px;
  font-size: 1rem;
  transition: all 0.3s;
}

.search-input:focus {
  outline: none;
  border-color: var(--secondary);
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.search-icon {
  position: absolute;
  right: 1.5rem;
  top: 50%;
  transform: translateY(-50%);
  color: var(--gray);
}

/* Filter Buttons */
.filter-buttons {
  display: flex;
  gap: 1rem;
  margin-bottom: 2rem;
  flex-wrap: wrap;
}

.filter-btn {
  padding: 0.6rem 1.2rem;
  border: 2px solid var(--gray-light);
  background: white;
  border-radius: 50px;
  cursor: pointer;
  transition: all 0.3s;
  font-weight: 600;
}

.filter-btn:hover {
  border-color: var(--secondary);
  color: var(--secondary);
}

.filter-btn.active {
  background: linear-gradient(135deg, var(--secondary), var(--accent));
  color: white;
  border-color: transparent;
}

/* Toast Notifications */
.toast {
  position: fixed;
  bottom: 2rem;
  right: 2rem;
  background: var(--white);
  padding: 1rem 1.5rem;
  border-radius: 10px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  display: flex;
  align-items: center;
  gap: 1rem;
  z-index: 3000;
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from { transform: translateX(400px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

.toast.success { border-left: 4px solid var(--success); }
.toast.error { border-left: 4px solid var(--error); }
.toast.info { border-left: 4px solid var(--info); }

/* Inquiry Card */
.inquiry-card {
  background: var(--gray-light);
  padding: 1.5rem;
  border-radius: 10px;
  margin-bottom: 1rem;
}

.inquiry-header {
  display: flex;
  justify-content: space-between;
  align-items: start;
  margin-bottom: 1rem;
}

.inquiry-status {
  padding: 0.3rem 0.8rem;
  border-radius: 50px;
  font-size: 0.85rem;
  font-weight: 600;
}

.inquiry-status.pending {
  background: var(--warning);
  color: white;
}

.inquiry-status.responded {
  background: var(--success);
  color: white;
}

/* Responsive */
@media (max-width: 1024px) {
  .dashboard-layout {
    grid-template-columns: 1fr;
  }
  
  .sidebar {
    display: none;
  }
  
  .stats-grid {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  }
  
  .listing-grid {
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  }
}

@media (max-width: 768px) {
  .top-bar {
    flex-direction: column;
    gap: 1rem;
  }
  
  .content-area {
    padding: 1rem;
  }
  
  .filter-buttons {
    overflow-x: auto;
    flex-wrap: nowrap;
  }
}

.inquiry-card.unread {
  border-left: 4px solid var(--primary);
  background: rgba(249, 115, 22, 0.05);
}



</style>
</head>
<body>

<div class="loading-screen" id="loadingScreen">
  <div class="loader"></div>
  <p>Loading your dashboard...</p>
</div>

<div class="dashboard-layout">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <a href="index.html" class="logo">Systemly</a>
    </div>
    
    <div class="user-profile">
      <div class="user-profile-content">
        <div class="user-avatar" id="sidebarAvatar">B</div>
        <div class="user-details">
          <div class="user-name" id="sidebarName">Buyer</div>
          <div class="user-email" id="sidebarEmail">buyer@email.com</div>
        </div>
      </div>
      <span class="role-badge">Buyer</span>
    </div>
    
    <nav class="sidebar-nav">
      <div class="nav-section">
        <div class="nav-section-title">Browse</div>
        <div class="nav-item active" onclick="navigateTo('overview')">
          <i class="fa-solid fa-house"></i>
          <span>Overview</span>
        </div>
        
        <div class="nav-item" onclick="navigateTo('saved')">
          <i class="fa-solid fa-heart"></i>
          <span>Saved Listings</span>
          <span class="badge" id="savedCount">0</span>
        </div>
      </div>
      
      <div class="nav-section">
        <div class="nav-section-title">Tools</div>
        <div class="nav-item" onclick="navigateTo('calculator')">
          <i class="fa-solid fa-calculator"></i>
          <span>ROI Calculator</span>
        </div>
        <div class="nav-item" onclick="navigateTo('inquiries')">
          <i class="fa-solid fa-envelope"></i>
          <span>My Inquiries</span>
        </div>
      </div>
      
      <div class="nav-section">
  <div class="nav-section-title">Tools</div>
  <div class="nav-item" onclick="navigateTo('calculator')">
    <i class="fa-solid fa-calculator"></i>
    <span>ROI Calculator</span>
  </div>
  <div class="nav-item" onclick="navigateTo('offers')">
    <i class="fa-solid fa-money-bill-trend-up"></i>
    <span>My Offers</span>
    <span class="badge" id="offersCount">0</span>
  </div>
  <div class="nav-item" onclick="navigateTo('messages')">
    <i class="fa-solid fa-envelope"></i>
    <span>Messages</span>
    <span class="badge" id="messagesCount">0</span>
  </div>
</div>
    
    <div class="sidebar-footer">
      <button class="logout-btn" onclick="logout()">
        <i class="fa-solid fa-right-from-bracket"></i>
        Sign Out
      </button>
    </div>
  </aside>
  
  <!-- Main Content -->
  <main class="main-content">
    <div class="top-bar">
      <h1 class="page-title" id="pageTitle">Overview</h1>
      <div class="top-bar-actions">
        <button class="btn btn-secondary" onclick="window.location.href='marketplace.html'">
  <i class="fa-solid fa-store"></i> Browse Marketplace
</button>
        <button class="btn btn-primary" onclick="navigateTo('calculator')">
          <i class="fa-solid fa-calculator"></i> ROI Calculator
        </button>
      </div>
    </div>
    
    <div class="content-area" id="contentArea">
      <!-- OVERVIEW TAB -->
      <div id="tab-overview" class="tab-content active">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-header">
              <div>
                <div class="stat-value" id="savedListingsCount">0</div>
                <div class="stat-label">Saved Listings</div>
              </div>
              <div class="stat-icon secondary">
                <i class="fa-solid fa-heart"></i>
              </div>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-header">
              <div>
                <div class="stat-value" id="activeInquiriesCount">0</div>
                <div class="stat-label">Active Inquiries</div>
              </div>
              <div class="stat-icon accent">
                <i class="fa-solid fa-envelope"></i>
              </div>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-header">
              <div>
                <div class="stat-value" id="totalPurchasesCount">0</div>
                <div class="stat-label">Purchases Made</div>
              </div>
              <div class="stat-icon success">
                <i class="fa-solid fa-shopping-bag"></i>
              </div>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-header">
              <div>
                <div class="stat-value" id="totalSpentAmount">â‚±0</div>
                <div class="stat-label">Total Invested</div>
              </div>
              <div class="stat-icon primary">
                <i class="fa-solid fa-peso-sign"></i>
              </div>
            </div>
          </div>
        </div>
        
        <div class="content-card">
          <div class="card-header">
            <h3>Quick Actions</h3>
          </div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <button class="btn btn-primary" onclick="window.location.href='marketplace.html'">
  <i class="fa-solid fa-store"></i> Browse Marketplace
</button>
            <button class="btn btn-primary" onclick="navigateTo('calculator')">
              <i class="fa-solid fa-calculator"></i> Calculate ROI
            </button>
            <button class="btn btn-primary" onclick="navigateTo('saved')">
              <i class="fa-solid fa-heart"></i> View Saved
            </button>
          </div>
        </div>
        
        <div class="content-card">
          <div class="card-header">
            <h3>Recently Viewed</h3>
            <button class="card-action" onclick="navigateTo('marketplace')">View All</button>
          </div>
          <div id="recentlyViewed"></div>
        </div>
      </div>
      
      <!-- MARKETPLACE TAB -->
    
      
      <!-- SAVED LISTINGS TAB -->
      <div id="tab-saved" class="tab-content">
        <div class="content-card">
          <div class="card-header">
            <h3>Saved Listings</h3>
          </div>
          <div class="listing-grid" id="savedListings"></div>
        </div>
      </div>
      
      <!-- ROI CALCULATOR TAB -->
      <div id="tab-calculator" class="tab-content">
        <div class="content-card">
          <div class="card-header">
            <h3>ROI Calculator</h3>
          </div>
          
          <form class="calculator-form" id="calculatorForm">
            <div class="form-group">
              <label class="form-label">Purchase Price (â‚±)</label>
              <input type="number" id="calcPurchasePrice" class="form-input" placeholder="50000" required>
            </div>
            
            <div class="form-group">
              <label class="form-label">Monthly Revenue (â‚±)</label>
              <input type="number" id="calcMonthlyRevenue" class="form-input" placeholder="5000" required>
            </div>
            
            <div class="form-group">
              <label class="form-label">Monthly Operating Costs (â‚±)</label>
              <input type="number" id="calcOperatingCosts" class="form-input" placeholder="1000">
            </div>
            
            <div class="form-group">
              <label class="form-label">Expected Growth Rate (%)</label>
              <input type="number" id="calcGrowthRate" class="form-input" placeholder="10" step="0.1">
            </div>
            
            <div class="form-group">
              <label class="form-label">Investment Period (months)</label>
              <input type="number" id="calcPeriod" class="form-input" placeholder="12" min="1" max="60">
            </div>
            
            <button type="button" class="btn btn-primary btn-full" onclick="calculateROI()">
              <i class="fa-solid fa-calculator"></i> Calculate ROI
            </button>
          </form>
          
          <div id="calculatorResults" style="display: none;">
            <div class="calculator-results">
              <h4 style="margin-bottom: 1.5rem; font-size: 1.5rem;">Investment Analysis</h4>
              
              <div class="result-item">
                <span class="result-label">Monthly Net Profit</span>
                <span class="result-value" id="resultMonthlyProfit">â‚±0</span>
              </div>
              
              <div class="result-item">
                <span class="result-label">Annual Return</span>
                <span class="result-value" id="resultAnnualReturn">â‚±0</span>
              </div>
              
              <div class="result-item">
                <span class="result-label">ROI Percentage</span>
                <span class="result-value" id="resultROI">0%</span>
              </div>
              
              <div class="result-item">
                <span class="result-label">Break-Even Period</span>
                <span class="result-value" id="resultBreakEven">0 months</span>
              </div>
              
              <div class="result-item">
                <span class="result-label">Total Return (${document.getElementById('calcPeriod')?.value || 12} months)</span>
                <span class="result-value" id="resultTotalReturn">â‚±0</span>
              </div>
              
              <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.2);">
                <p style="opacity: 0.9; font-size: 0.95rem; line-height: 1.6;">
                  <strong>Analysis:</strong> <span id="resultAnalysis">Calculate to see analysis</span>
                </p>
              </div>
            </div>
            
            <button class="btn btn-secondary btn-full" style="margin-top: 1rem;" onclick="resetCalculator()">
              <i class="fa-solid fa-undo"></i> Calculate Another
            </button>
          </div>
        </div>
      </div>
      
      <!-- INQUIRIES TAB -->
      <div id="tab-inquiries" class="tab-content">
        <div class="content-card">
          <div class="card-header">
            <h3>My Inquiries</h3>
            <button class="card-action" onclick="navigateTo('marketplace')">Browse Listings</button>
          </div>
          <div id="inquiriesList"></div>
        </div>
      </div>
      
      <!-- PURCHASES TAB -->
      <div id="tab-purchases" class="tab-content">
        <div class="content-card">
          <div class="card-header">
            <h3>Purchase History</h3>
          </div>
          <div id="purchasesList"></div>
        </div>
      </div>
      


<!-- MY OFFERS TAB -->
<div id="tab-offers" class="tab-content">
  <div class="content-card">
    <div class="card-header">
      <h3>My Offers</h3>
      <button class="card-action" onclick="window.location.href='marketplace.html'">
        <i class="fa-solid fa-plus"></i> Make New Offer
      </button>
    </div>
    <div id="offersList"></div>
  </div>
</div>

<!-- MESSAGES TAB -->
<div id="tab-messages" class="tab-content">
  <div class="content-card">
    <div class="card-header">
      <h3>My Messages</h3>
      <button class="card-action" onclick="loadMessages()">
        <i class="fa-solid fa-sync"></i> Refresh
      </button>
    </div>
    <div id="messagesList"></div>
  </div>
</div>














      <!-- SETTINGS TAB -->
      <div id="tab-settings" class="tab-content">
        <div class="content-card">
          <div class="card-header">
            <h3>Account Settings</h3>
          </div>
          
          <form id="settingsForm" onsubmit="saveSettings(event)">
            <div class="form-group">
              <label class="form-label">Full Name</label>
              <input type="text" id="settingsName" class="form-input" required>
            </div>
            
            <div class="form-group">
              <label class="form-label">Email</label>
              <input type="email" id="settingsEmail" class="form-input" disabled>
              <small style="color: var(--gray); font-size: 0.85rem;">Email cannot be changed</small>
            </div>
            
            <div class="form-group">
              <label class="form-label">Phone</label>
              <input type="tel" id="settingsPhone" class="form-input">
            </div>
            
            <div class="form-group">
              <label class="form-label">Location</label>
              <input type="text" id="settingsLocation" class="form-input" placeholder="City, Country">
            </div>
            
            <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--gray-light);">
              <h4 style="margin-bottom: 1rem;">Notification Preferences</h4>
              <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.8rem; cursor: pointer;">
                <input type="checkbox" id="notifyNewListings" checked> New listings matching my interests
              </label>
              <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.8rem; cursor: pointer;">
                <input type="checkbox" id="notifyPriceDrops" checked> Price drops on saved listings
              </label>
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="notifyNewsletter"> Weekly marketplace newsletter
              </label>
            </div>
            
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
              <button type="submit" class="btn btn-primary">
                <i class="fa-solid fa-save"></i> Save Changes
              </button>
              <button type="button" class="btn btn-secondary" onclick="resetSettings()">
                <i class="fa-solid fa-undo"></i> Reset
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </main>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
import { 
  getFirestore, 
  doc, 
  getDoc, 
  setDoc, 
  updateDoc, 
  collection, 
  query, 
  where, 
  getDocs, 
  addDoc,
  deleteDoc,
  serverTimestamp,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD3PQ5oWrzAXOHnb7wrmpRhL9DWIB7w9rE",
  authDomain: "systemly-db.firebaseapp.com",
  projectId: "systemly-db",
  storageBucket: "systemly-db.firebasestorage.app",
  messagingSenderId: "32599486733",
  appId: "1:32599486733:web:16d34643c8f920a6fd8044"
};

const API_URL = 'https://systemly.onrender.com'; //
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let userData = null;
let allListings = [];
let savedListings = [];
let inquiries = [];
let purchases = [];
let recentlyViewed = [];
let myOffers = [];
let myMessages = [];
let fileReviews = [];
let listingsUnsubscribe = null;




/ ============================================
// LOAD OFFERS
// ============================================

// ============================================
// LOAD OFFERS
// ============================================

async function loadOffers() {
  try {
    console.log('ðŸ“¥ Loading buyer offers...');
    
    const response = await fetch(`${API_URL}/api/offers/buyer/${userData.id}`);
    const data = await response.json();
    
    if (data.success) {
      myOffers = data.offers;
      console.log('âœ… Loaded offers:', myOffers.length);
      
      // Check for file reviews
      await loadFileReviews();
    } else {
      myOffers = [];
    }
    
  } catch (error) {
    console.error('âŒ Error loading offers:', error);
    myOffers = [];
  }
}

// ============================================
// LOAD FILE REVIEWS FOR BUYER
// ============================================

async function loadFileReviews() {
  try {
    console.log('ðŸ“¥ Loading file reviews for buyer...');
    
    const response = await fetch(`${API_URL}/api/file-reviews/buyer/${userData.id}`);
    const data = await response.json();
    
    if (data.success) {
      fileReviews = data.reviews || [];
      console.log('âœ… Loaded file reviews:', fileReviews.length);
      
      // Update offer statuses based on file review status
      fileReviews.forEach(review => {
        const offer = myOffers.find(o => o.id === review.offer_id);
        if (offer && review.status === 'admin-approved') {
          offer.fileReviewStatus = 'approved';
          offer.fileReviewId = review.id;
        }
      });
    } else {
      fileReviews = [];
    }
    
  } catch (error) {
    console.error('âŒ Error loading file reviews:', error);
    fileReviews = [];
  }
}

// ============================================
// LOAD MESSAGES  
// ============================================

async function loadMessages() {
  try {
    console.log('ðŸ“¥ Loading buyer messages...');
    
    // For buyers, we'll need to track messages they sent
    // Since the backend only has seller messages endpoint,
    // we'll use inquiries for now or you can add a buyer messages endpoint
    
    myMessages = [];
    console.log('âœ… Messages loaded');
    
  } catch (error) {
    console.error('âŒ Error loading messages:', error);
    myMessages = [];
  }
}




















// ============================================
// AUTH STATE OBSERVER
// ============================================

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    console.log('âŒ No user authenticated, redirecting to login...');
    window.location.href = 'login.html';
    return;
  }
  console.log('âœ… User authenticated:', user.email);
  try {
    const userDocRef = doc(db, 'users', user.uid);
    const userDoc = await getDoc(userDocRef);
    
    if (userDoc.exists()) {
      const data = userDoc.data();
      userData = {
        id: user.uid,
        email: user.email,
        name: data.name || user.displayName || user.email.split('@')[0],
        role: data.role || 'buyer',
        profile: data.profile || {},
        savedListings: data.savedListings || [],
        recentlyViewed: data.recentlyViewed || []
      };
      
      console.log('âœ… User document loaded:', userData);
      
      // âœ… Set up real-time listener for user document updates
      onSnapshot(userDocRef, async (docSnap) => {
        if (docSnap.exists()) {
          const data = docSnap.data();
          
          // Check if savedListings changed
          const oldSaved = userData.savedListings || [];
          const newSaved = data.savedListings || [];
          
          if (JSON.stringify(oldSaved) !== JSON.stringify(newSaved)) {
            console.log('ðŸ”„ Saved listings updated:', newSaved.length);
            
            userData.savedListings = newSaved;
            
            // Reload saved listings
            await loadSavedListings();
          }
        }
      }, (error) => {
        console.error('âŒ Error in user snapshot:', error);
      });
      
      // âœ… Set up real-time listener for offers and file reviews
      setInterval(async () => {
        await loadOffers();
        renderOffers();
        updateStats();
      }, 10000); // Check every 10 seconds for file review updates
      
      // Ensure buyer role
      if (userData.role !== 'buyer') {
        console.log('âš ï¸ User is not a buyer, but allowing access...');
      }
    } else {
      console.log('ðŸ“ Creating new buyer user document...');
      userData = {
        id: user.uid,
        email: user.email,
        name: user.displayName || user.email.split('@')[0],
        role: 'buyer',
        profile: {},
        savedListings: [],
        recentlyViewed: []
      };
      
      await setDoc(userDocRef, {
        ...userData,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });
      
      console.log('âœ… New buyer user document created');
    }
    
    // Load data
    await loadMarketplaceListings();
    await loadSavedListings();
    await loadInquiries();
    await loadPurchases();
    await loadOffers(); // This will also load file reviews
    await loadMessages();
    
    initializeDashboard();
    
  } catch (error) {
    console.error('âŒ Error loading user data:', error);
    showToast('Failed to load dashboard. Please refresh the page.', 'error');
    document.getElementById('loadingScreen').classList.add('hidden');
    document.body.classList.add('loaded');
  }
});
// ============================================
// LOAD MARKETPLACE LISTINGS
// ============================================

async function loadMarketplaceListings() {
  try {
    console.log('ðŸ“¥ Loading marketplace listings...');
    
    const listingsRef = collection(db, 'listings');
    const q = query(listingsRef, where('status', 'in', ['active', 'approved']));
    
    // Set up real-time listener
    listingsUnsubscribe = onSnapshot(q, (snapshot) => {
      allListings = [];
      
      snapshot.forEach((doc) => {
        const data = doc.data();
        allListings.push({
          id: doc.id,
          ...data
        });
      });
      
      console.log('âœ… Loaded marketplace listings:', allListings.length);
      
      // Update UI if dashboard is loaded
      if (document.body.classList.contains('loaded')) {
        renderMarketplace();
        updateRecentlyViewed();
      }
    }, (error) => {
      console.error('âŒ Error in listings snapshot:', error);
      showToast('Failed to load listings', 'error');
    });
    
  } catch (error) {
    console.error('âŒ Error loading marketplace listings:', error);
    allListings = [];
  }
}

// ============================================
// LOAD SAVED LISTINGS
// ============================================

async function loadSavedListings() {
  try {
    if (!userData || !userData.savedListings || userData.savedListings.length === 0) {
      console.log('No saved listings');
      savedListings = [];
      return;
    }
    
    console.log('ðŸ“¥ Loading saved listings...');
    
    const listingsRef = collection(db, 'listings');
    const q = query(listingsRef, where('__name__', 'in', userData.savedListings));
    
    const snapshot = await getDocs(q);
    savedListings = [];
    
    snapshot.forEach((doc) => {
      savedListings.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    console.log('âœ… Loaded saved listings:', savedListings.length);
    
  } catch (error) {
    console.error('âŒ Error loading saved listings:', error);
    savedListings = [];
  }
}

// ============================================
// LOAD INQUIRIES
// ============================================

async function loadInquiries() {
  try {
    console.log('ðŸ“¥ Loading inquiries...');
    
    const inquiriesRef = collection(db, 'inquiries');
    const q = query(inquiriesRef, where('buyerId', '==', userData.id));
    
    const snapshot = await getDocs(q);
    inquiries = [];
    
    snapshot.forEach((doc) => {
      inquiries.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    console.log('âœ… Loaded inquiries:', inquiries.length);
    
  } catch (error) {
    console.error('âŒ Error loading inquiries:', error);
    inquiries = [];
  }
}

// ============================================
// LOAD PURCHASES
// ============================================

async function loadPurchases() {
  try {
    console.log('ðŸ“¥ Loading purchases...');
    
    const purchasesRef = collection(db, 'purchases');
    const q = query(purchasesRef, where('buyerId', '==', userData.id));
    
    const snapshot = await getDocs(q);
    purchases = [];
    
    snapshot.forEach((doc) => {
      purchases.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    console.log('âœ… Loaded purchases:', purchases.length);
    
  } catch (error) {
    console.error('âŒ Error loading purchases:', error);
    purchases = [];
  }
}

// ============================================
// INITIALIZE DASHBOARD
// ============================================

function initializeDashboard() {
  console.log('ðŸŽ¯ Initializing buyer dashboard...');
  
  document.getElementById('loadingScreen').classList.add('hidden');
  document.body.classList.add('loaded');
  
  updateUserProfile();
  updateStats();
  renderSavedListings();
  renderInquiries();
  renderPurchases();
  renderOffers();
  renderMessages();
  updateRecentlyViewed();
  
  console.log('âœ… Buyer dashboard initialized successfully');
}

function updateUserProfile() {
  const initials = userData.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
  
  document.getElementById('sidebarAvatar').textContent = initials;
  document.getElementById('sidebarName').textContent = userData.name;
  document.getElementById('sidebarEmail').textContent = userData.email;
}

function updateStats() {
  document.getElementById('savedListingsCount').textContent = savedListings.length;
  document.getElementById('savedCount').textContent = savedListings.length;
  document.getElementById('activeInquiriesCount').textContent = inquiries.filter(i => i.status === 'pending').length;
  document.getElementById('totalPurchasesCount').textContent = purchases.length;
  
  const totalSpent = purchases.reduce((sum, p) => sum + (p.amount || 0), 0);
  document.getElementById('totalSpentAmount').textContent = `â‚±${totalSpent.toLocaleString()}`;
  
  // Update badges
  const pendingOffers = myOffers.filter(o => o.status === 'pending').length;
  document.getElementById('offersCount').textContent = pendingOffers;
  
  const unreadMessages = myMessages.filter(m => !m.is_read).length;
  document.getElementById('messagesCount').textContent = unreadMessages;
}

// ============================================
// RENDER MARKETPLACE
// ============================================

function renderMarketplace() {
  const container = document.getElementById('marketplaceListings');
  
  if (allListings.length === 0) {
    container.innerHTML = `
      <div class="empty-state" style="grid-column: 1 / -1;">
        <i class="fa-solid fa-store-slash"></i>
        <p>No listings available at the moment</p>
        <p style="font-size: 0.9rem; color: var(--gray);">Check back soon for new systems!</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = allListings.map(listing => `
    <div class="listing-card" onclick="viewListing('${listing.id}')" style="position: relative;">
      <button class="favorite-btn ${isSaved(listing.id) ? 'active' : ''}" 
              onclick="event.stopPropagation(); toggleSave('${listing.id}')">
        <i class="fa-${isSaved(listing.id) ? 'solid' : 'regular'} fa-heart"></i>
      </button>
      <img src="${listing.mainImage || 'https://via.placeholder.com/400x200'}" 
           alt="${listing.systemName}" 
           class="listing-image">
      <div class="listing-content">
        <h3 class="listing-title">${listing.systemName || 'Untitled'}</h3>
        <p class="listing-description">${listing.shortDescription || 'No description available'}</p>
        <div class="listing-footer">
          <div class="listing-price">â‚±${parseInt(listing.askingPrice || 0).toLocaleString()}</div>
          <div class="listing-category">${listing.categoryName || listing.category}</div>
        </div>
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--gray-light); display: flex; justify-content: space-between; font-size: 0.9rem; color: var(--gray);">
          <span><i class="fa-solid fa-eye"></i> ${listing.views || 0} views</span>
          <span><i class="fa-solid fa-dollar-sign"></i> MRR: â‚±${(listing.mrr || 0).toLocaleString()}</span>
        </div>
      </div>
    </div>
  `).join('');
}

// ============================================
// RENDER SAVED LISTINGS
// ============================================

function renderSavedListings() {
  const container = document.getElementById('savedListings');
  
  if (savedListings.length === 0) {
    container.innerHTML = `
      <div class="empty-state" style="grid-column: 1 / -1;">
        <i class="fa-solid fa-heart-crack"></i>
        <p>No saved listings yet</p>
        <p style="font-size: 0.9rem; color: var(--gray);">Browse the marketplace and save your favorites!</p>
        <br>
        <button class="btn btn-primary" onclick="window.location.href='marketplace.html'">
          <i class="fa-solid fa-store"></i> Browse Marketplace
        </button>
      </div>
    `;
    return;
  }
  
  container.innerHTML = savedListings.map(listing => `
    <div class="listing-card" onclick="viewListing('${listing.id}')" style="position: relative;">
      <button class="favorite-btn active" 
              onclick="event.stopPropagation(); toggleSave('${listing.id}')">
        <i class="fa-solid fa-heart"></i>
      </button>
      <img src="${listing.mainImage || 'https://via.placeholder.com/400x200'}" 
           alt="${listing.systemName}" 
           class="listing-image">
      <div class="listing-content">
        <h3 class="listing-title">${listing.systemName || 'Untitled'}</h3>
        <p class="listing-description">${listing.shortDescription || 'No description available'}</p>
        <div class="listing-footer">
          <div class="listing-price">â‚±${parseInt(listing.askingPrice || 0).toLocaleString()}</div>
          <div class="listing-category">${listing.categoryName || listing.category}</div>
        </div>
      </div>
    </div>
  `).join('');
}

// ============================================
// RENDER INQUIRIES
// ============================================

function renderInquiries() {
  const container = document.getElementById('inquiriesList');
  
  if (inquiries.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fa-solid fa-envelope-open"></i>
        <p>No inquiries sent yet</p>
        <p style="font-size: 0.9rem; color: var(--gray);">Contact sellers about listings you're interested in</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = inquiries.map(inquiry => `
    <div class="inquiry-card">
      <div class="inquiry-header">
        <div>
          <h4>${inquiry.listingName || 'Listing Inquiry'}</h4>
          <p style="color: var(--gray); font-size: 0.9rem; margin-top: 0.3rem;">
            To: ${inquiry.sellerName || 'Seller'}
          </p>
        </div>
        <span class="inquiry-status ${inquiry.status}">${inquiry.status || 'pending'}</span>
      </div>
      <p style="color: var(--text); margin-bottom: 0.5rem;">${inquiry.message || 'No message'}</p>
      <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--gray);">
        <span><i class="fa-solid fa-calendar"></i> ${inquiry.createdAt?.toDate?.().toLocaleDateString() || 'N/A'}</span>
        <button class="btn btn-secondary" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;" 
                onclick="viewListing('${inquiry.listingId}')">
          View Listing
        </button>
      </div>
    </div>
  `).join('');
}

// ============================================
// RENDER PURCHASES
// ============================================

function renderPurchases() {
  const container = document.getElementById('purchasesList');
  
  if (purchases.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fa-solid fa-shopping-bag"></i>
        <p>No purchases yet</p>
        <p style="font-size: 0.9rem; color: var(--gray);">Your purchase history will appear here</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = purchases.map(purchase => `
    <div class="inquiry-card">
      <div class="inquiry-header">
        <div>
          <h4>${purchase.listingName || 'System Purchase'}</h4>
          <p style="color: var(--gray); font-size: 0.9rem; margin-top: 0.3rem;">
            From: ${purchase.sellerName || 'Seller'}
          </p>
        </div>
        <span class="inquiry-status ${purchase.status === 'completed' ? 'responded' : 'pending'}">
          ${purchase.status || 'processing'}
        </span>
      </div>
      <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
        <div>
          <div style="font-size: 1.5rem; font-weight: 900; color: var(--primary);">
            â‚±${parseInt(purchase.amount || 0).toLocaleString()}
          </div>
          <div style="font-size: 0.85rem; color: var(--gray);">
            ${purchase.createdAt?.toDate?.().toLocaleDateString() || 'N/A'}
          </div>
        </div>
        <button class="btn btn-primary" style="padding: 0.6rem 1.2rem;">
          <i class="fa-solid fa-download"></i> Download Assets
        </button>
      </div>
    </div>
  `).join('');
}





// ============================================
// RENDER OFFERS
// ============================================

function renderOffers() {
  const container = document.getElementById('offersList');
  
  if (!container) return;
  
  if (myOffers.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fa-solid fa-money-bill-wave"></i>
        <p>No offers made yet</p>
        <p style="font-size: 0.9rem; color: var(--gray);">Browse listings and make offers to sellers</p>
        <br>
        <button class="btn btn-primary" onclick="window.location.href='marketplace.html'">
          <i class="fa-solid fa-store"></i> Browse Marketplace
        </button>
      </div>
    `;
    return;
  }
  
  container.innerHTML = myOffers.map(offer => {
    const statusColors = {
      pending: 'warning',
      accepted: 'success',
      rejected: 'error',
      countered: 'info',
      'files-uploaded': 'info',
      'files-ready': 'success'
    };
    
    const statusColor = statusColors[offer.status] || 'pending';
    
    // Check if files are ready for this offer
    const hasApprovedFiles = offer.fileReviewStatus === 'approved';
    
    return `
      <div class="inquiry-card">
        <div class="inquiry-header">
          <div>
            <h4>${offer.listing_name || 'Listing Offer'}</h4>
            <p style="color: var(--gray); font-size: 0.9rem; margin-top: 0.3rem;">
              To: ${offer.seller_email}
            </p>
          </div>
          <span class="inquiry-status ${statusColor}">
            ${hasApprovedFiles ? 'FILES READY' : offer.status.toUpperCase()}
          </span>
        </div>
        
        ${hasApprovedFiles ? `
          <div style="background: linear-gradient(135deg, var(--success), var(--accent)); color: white; padding: 1.5rem; border-radius: 10px; margin: 1rem 0;">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
              <i class="fa-solid fa-check-circle" style="font-size: 2rem;"></i>
              <div>
                <h4 style="margin-bottom: 0.3rem;">âœ… Files Approved by Admin</h4>
                <p style="opacity: 0.9; font-size: 0.9rem;">The seller has uploaded all necessary files and they have been verified. Proceed with payment to complete the purchase.</p>
              </div>
            </div>
            <button class="btn" style="background: white; color: var(--success); width: 100%; margin-top: 1rem; font-weight: 700; font-size: 1.1rem;" 
                    onclick="proceedToPayment('${offer.id}', '${offer.fileReviewId}')">
              <i class="fa-solid fa-credit-card"></i> Proceed to Payment - â‚±${parseFloat(offer.offer_amount).toLocaleString()}
            </button>
          </div>
        ` : offer.status === 'files-uploaded' ? `
          <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 10px; margin: 1rem 0; border-left: 4px solid var(--info);">
            <div style="display: flex; align-items: center; gap: 0.8rem;">
              <i class="fa-solid fa-hourglass-half" style="color: var(--info); font-size: 1.5rem;"></i>
              <div>
                <strong>Files Uploaded - Pending Admin Review</strong>
                <p style="font-size: 0.9rem; color: var(--gray); margin-top: 0.3rem;">The seller has uploaded the transfer files. Our admin team is currently reviewing them to ensure everything is in order.</p>
              </div>
            </div>
          </div>
        ` : ''}
        
        <div style="background: var(--gray-light); padding: 1rem; border-radius: 10px; margin: 1rem 0;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-size: 0.85rem; color: var(--gray); margin-bottom: 0.3rem;">Your Offer</div>
              <div style="font-size: 1.8rem; font-weight: 900; color: var(--primary);">
                â‚±${parseFloat(offer.offer_amount).toLocaleString()}
              </div>
            </div>
            ${offer.status === 'countered' ? `
              <div style="text-align: right;">
                <div style="font-size: 0.85rem; color: var(--gray); margin-bottom: 0.3rem;">Counter Offer</div>
                <div style="font-size: 1.5rem; font-weight: 700; color: var(--secondary);">
                  â‚±${parseFloat(offer.counter_amount || 0).toLocaleString()}
                </div>
              </div>
            ` : ''}
          </div>
        </div>
        
        ${offer.message ? `
          <div style="margin: 1rem 0; padding: 1rem; background: white; border-left: 3px solid var(--secondary); border-radius: 5px;">
            <strong style="font-size: 0.9rem; color: var(--gray);">Your Message:</strong>
            <p style="margin-top: 0.5rem; color: var(--text);">${offer.message}</p>
          </div>
        ` : ''}
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--gray-light);">
          <span style="font-size: 0.85rem; color: var(--gray);">
            <i class="fa-solid fa-calendar"></i> 
            ${new Date(offer.created_at).toLocaleDateString()}
          </span>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.9rem;" 
                    onclick="viewListing('${offer.listing_id}')">
              <i class="fa-solid fa-eye"></i> View Listing
            </button>
            ${offer.status === 'pending' ? `
              <button class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.9rem; background: var(--error);" 
                      onclick="cancelOffer('${offer.id}')">
                <i class="fa-solid fa-times"></i> Cancel Offer
              </button>
            ` : ''}
            ${offer.status === 'countered' ? `
              <button class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.9rem;" 
                      onclick="acceptCounterOffer('${offer.id}', '${offer.counter_amount}')">
                <i class="fa-solid fa-check"></i> Accept Counter
              </button>
            ` : ''}
          </div>
        </div>
      </div>
    `;
  }).join('');
}

// ============================================
// RENDER MESSAGES
// ============================================

function renderMessages() {
  const container = document.getElementById('messagesList');
  
  if (!container) return;
  
  if (myMessages.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fa-solid fa-envelope-open"></i>
        <p>No messages yet</p>
        <p style="font-size: 0.9rem; color: var(--gray);">Contact sellers about listings you're interested in</p>
        <br>
        <button class="btn btn-primary" onclick="window.location.href='marketplace.html'">
          <i class="fa-solid fa-store"></i> Browse Marketplace
        </button>
      </div>
    `;
    return;
  }
  
  container.innerHTML = myMessages.map(msg => `
    <div class="inquiry-card ${!msg.is_read ? 'unread' : ''}">
      <div class="inquiry-header">
        <div>
          <h4>${msg.subject || 'Message'}</h4>
          <p style="color: var(--gray); font-size: 0.9rem; margin-top: 0.3rem;">
            To: ${msg.seller_email}
          </p>
        </div>
        ${!msg.is_read ? '<span class="inquiry-status pending">NEW</span>' : ''}
      </div>
      
      <div style="margin: 1rem 0; padding: 1rem; background: white; border-radius: 5px;">
        <p style="color: var(--text); line-height: 1.6;">${msg.message}</p>
      </div>
      
      <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; color: var(--gray);">
        <span>
          <i class="fa-solid fa-calendar"></i> 
          ${new Date(msg.created_at).toLocaleDateString()}
        </span>
        <button class="btn btn-secondary" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;" 
                onclick="viewListing('${msg.listing_id}')">
          View Listing
        </button>
      </div>
    </div>
  `).join('');
}





// ============================================
// PROCEED TO PAYMENT
// ============================================

window.proceedToPayment = async function(offerId, fileReviewId) {
  if (!confirm('Proceed to payment? You will be redirected to complete the transaction.')) return;
  
  try {
    // Show loading
    showToast('Preparing payment...', 'info');
    
    // Here you would typically:
    // 1. Create a payment intent
    // 2. Redirect to payment gateway
    // 3. Handle payment confirmation
    
    // For now, we'll simulate the payment process
    const paymentConfirmed = confirm(`
Payment Details:
Amount: â‚±${myOffers.find(o => o.id === offerId)?.offer_amount}

Click OK to confirm payment (Demo Mode)
Click Cancel to return
    `);
    
    if (paymentConfirmed) {
      // Update offer status to paid
      const response = await fetch(`${API_URL}/api/offers/${offerId}/payment`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          paymentStatus: 'completed',
          paymentDate: new Date().toISOString(),
          fileReviewId: fileReviewId
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        showToast('Payment successful! Files will be transferred to you shortly.', 'success');
        
        // Reload offers and file reviews
        await loadOffers();
        renderOffers();
        updateStats();
        
        // Show success message with download option
        setTimeout(() => {
          if (confirm('Payment completed! Would you like to download the files now?')) {
            downloadPurchasedFiles(fileReviewId);
          }
        }, 1000);
      } else {
        throw new Error(data.error || 'Payment failed');
      }
    }
    
  } catch (error) {
    console.error('âŒ Payment error:', error);
    showToast('Payment failed: ' + error.message, 'error');
  }
}

// ============================================
// DOWNLOAD PURCHASED FILES
// ============================================

window.downloadPurchasedFiles = async function(fileReviewId) {
  try {
    showToast('Preparing files for download...', 'info');
    
    // Get file list from review
    const response = await fetch(`${API_URL}/api/file-reviews/buyer/${fileReviewId}/files`);
    const data = await response.json();
    
    if (data.success && data.files && data.files.length > 0) {
      // Download each file
      for (const file of data.files) {
        await downloadFile(fileReviewId, file.filename);
        await new Promise(resolve => setTimeout(resolve, 500)); // Delay between downloads
      }
      
      showToast('All files downloaded successfully!', 'success');
    } else {
      throw new Error('No files available for download');
    }
    
  } catch (error) {
    console.error('âŒ Download error:', error);
    showToast('Failed to download files: ' + error.message, 'error');
  }
}

async function downloadFile(reviewId, filename) {
  try {
    const response = await fetch(`${API_URL}/api/admin/download-file/${reviewId}/${encodeURIComponent(filename)}`);
    
    if (!response.ok) throw new Error('Download failed');
    
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    window.URL.revokeObjectURL(url);
    
  } catch (error) {
    console.error('Download error for ' + filename + ':', error);
    throw error;
  }
}














// ============================================
// OFFER ACTIONS
// ============================================

window.cancelOffer = async function(offerId) {
  if (!confirm('Are you sure you want to cancel this offer?')) return;
  
  try {
    const response = await fetch(`${API_URL}/api/offers/${offerId}`, {
      method: 'DELETE'
    });
    
    const data = await response.json();
    
    if (data.success) {
      showToast('Offer cancelled successfully', 'success');
      await loadOffers();
      renderOffers();
      updateStats();
    } else {
      throw new Error(data.error || 'Failed to cancel offer');
    }
  } catch (error) {
    console.error('Error cancelling offer:', error);
    showToast('Failed to cancel offer', 'error');
  }
}

window.acceptCounterOffer = async function(offerId, counterAmount) {
  if (!confirm(`Accept the counter offer of â‚±${parseFloat(counterAmount).toLocaleString()}?`)) return;
  
  try {
    const response = await fetch(`${API_URL}/api/offers/${offerId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        status: 'accepted',
        offerAmount: counterAmount
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      showToast('Counter offer accepted!', 'success');
      await loadOffers();
      renderOffers();
      updateStats();
    } else {
      throw new Error(data.error || 'Failed to accept counter offer');
    }
  } catch (error) {
    console.error('Error accepting counter offer:', error);
    showToast('Failed to accept counter offer', 'error');
  }
}










// ============================================
// UPDATE RECENTLY VIEWED
// ============================================

function updateRecentlyViewed() {
  const container = document.getElementById('recentlyViewed');
  
  if (!userData.recentlyViewed || userData.recentlyViewed.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fa-solid fa-clock-rotate-left"></i>
        <p>No recently viewed listings</p>
      </div>
    `;
    return;
  }
  
  const recentIds = userData.recentlyViewed.slice(0, 3);
  const recentListings = allListings.filter(l => recentIds.includes(l.id));
  
  container.innerHTML = `
    <div class="listing-grid">
      ${recentListings.map(listing => `
        <div class="listing-card" onclick="viewListing('${listing.id}')">
          <img src="${listing.mainImage || 'https://via.placeholder.com/400x200'}" 
               alt="${listing.systemName}" 
               class="listing-image">
          <div class="listing-content">
            <h3 class="listing-title">${listing.systemName || 'Untitled'}</h3>
            <p class="listing-description">${listing.shortDescription || 'No description available'}</p>
            <div class="listing-footer">
              <div class="listing-price">â‚±${parseInt(listing.askingPrice || 0).toLocaleString()}</div>
              <div class="listing-category">${listing.categoryName || listing.category}</div>
            </div>
          </div>
        </div>
      `).join('')}
    </div>
  `;
}

// ============================================
// SEARCH AND FILTERS
// ============================================

function setupSearchAndFilters() {
  const searchInput = document.getElementById('searchInput');
  const filterButtons = document.querySelectorAll('.filter-btn');
  
  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      filterListings(searchTerm, getCurrentCategory());
    });
  }
  
  filterButtons.forEach(btn => {
    btn.addEventListener('click', (e) => {
      filterButtons.forEach(b => b.classList.remove('active'));
      e.target.classList.add('active');
      
      const category = e.target.dataset.category;
      const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
      filterListings(searchTerm, category);
    });
  });
}

function getCurrentCategory() {
  const activeBtn = document.querySelector('.filter-btn.active');
  return activeBtn ? activeBtn.dataset.category : 'all';
}

function filterListings(searchTerm, category) {
  let filtered = allListings;
  
  // Filter by category
  if (category !== 'all') {
    filtered = filtered.filter(l => l.category === category);
  }
  
  // Filter by search term
  if (searchTerm) {
    filtered = filtered.filter(l => 
      (l.systemName || '').toLowerCase().includes(searchTerm) ||
      (l.shortDescription || '').toLowerCase().includes(searchTerm) ||
      (l.detailedDescription || '').toLowerCase().includes(searchTerm)
    );
  }
  
  // Re-render
  const container = document.getElementById('marketplaceListings');
  if (filtered.length === 0) {
    container.innerHTML = `
      <div class="empty-state" style="grid-column: 1 / -1;">
        <i class="fa-solid fa-search"></i>
        <p>No listings found</p>
        <p style="font-size: 0.9rem; color: var(--gray);">Try adjusting your search or filters</p>
      </div>
    `;
  } else {
    container.innerHTML = filtered.map(listing => `
      <div class="listing-card" onclick="viewListing('${listing.id}')" style="position: relative;">
        <button class="favorite-btn ${isSaved(listing.id) ? 'active' : ''}" 
                onclick="event.stopPropagation(); toggleSave('${listing.id}')">
          <i class="fa-${isSaved(listing.id) ? 'solid' : 'regular'} fa-heart"></i>
        </button>
        <img src="${listing.mainImage || 'https://via.placeholder.com/400x200'}" 
             alt="${listing.systemName}" 
             class="listing-image">
        <div class="listing-content">
          <h3 class="listing-title">${listing.systemName || 'Untitled'}</h3>
          <p class="listing-description">${listing.shortDescription || 'No description available'}</p>
          <div class="listing-footer">
            <div class="listing-price">â‚±${parseInt(listing.askingPrice || 0).toLocaleString()}</div>
            <div class="listing-category">${listing.categoryName || listing.category}</div>
          </div>
        </div>
      </div>
    `).join('');
  }
}

// ============================================
// HELPER FUNCTIONS
// ============================================

function isSaved(listingId) {
  return userData.savedListings && userData.savedListings.includes(listingId);
}

window.toggleSave = async function(listingId) {
  try {
    const userRef = doc(db, 'users', userData.id);
    let newSavedListings = userData.savedListings || [];
    
    if (isSaved(listingId)) {
      // Remove from saved
      newSavedListings = newSavedListings.filter(id => id !== listingId);
      showToast('Removed from saved listings', 'info');
    } else {
      // Add to saved
      newSavedListings.push(listingId);
      showToast('Added to saved listings', 'success');
    }
    
    await updateDoc(userRef, {
      savedListings: newSavedListings,
      updatedAt: serverTimestamp()
    });
    
    userData.savedListings = newSavedListings;
    await loadSavedListings();
    updateStats();
    renderMarketplace();
    renderSavedListings();
    
  } catch (error) {
    console.error('Error toggling save:', error);
    showToast('Failed to update saved listings', 'error');
  }
}

window.viewListing = function(listingId) {
  // Track view in recently viewed
  if (!userData.recentlyViewed) {
    userData.recentlyViewed = [];
  }
  
  // Remove if already exists, then add to front
  userData.recentlyViewed = userData.recentlyViewed.filter(id => id !== listingId);
  userData.recentlyViewed.unshift(listingId);
  userData.recentlyViewed = userData.recentlyViewed.slice(0, 10); // Keep only last 10
  
  // Update in Firestore
  updateDoc(doc(db, 'users', userData.id), {
    recentlyViewed: userData.recentlyViewed,
    updatedAt: serverTimestamp()
  }).catch(err => console.error('Error updating recently viewed:', err));
  
  // Navigate to listing detail page
  window.open(`listing-detail.html?id=${listingId}`, '_blank');
}

// ============================================
// ROI CALCULATOR
// ============================================

window.calculateROI = function() {
  const purchasePrice = parseFloat(document.getElementById('calcPurchasePrice').value) || 0;
  const monthlyRevenue = parseFloat(document.getElementById('calcMonthlyRevenue').value) || 0;
  const operatingCosts = parseFloat(document.getElementById('calcOperatingCosts').value) || 0;
  const growthRate = parseFloat(document.getElementById('calcGrowthRate').value) || 0;
  const period = parseInt(document.getElementById('calcPeriod').value) || 12;
  
  if (purchasePrice <= 0 || monthlyRevenue <= 0) {
    showToast('Please enter valid purchase price and monthly revenue', 'error');
    return;
  }
  
  // Calculate monthly net profit
  const monthlyProfit = monthlyRevenue - operatingCosts;
  
  // Calculate annual return
  const annualReturn = monthlyProfit * 12;
  
  // Calculate ROI percentage
  const roiPercentage = ((annualReturn / purchasePrice) * 100).toFixed(1);
  
  // Calculate break-even period
  const breakEvenMonths = Math.ceil(purchasePrice / monthlyProfit);
  
  // Calculate total return over period with growth
  let totalReturn = 0;
  let currentMonthlyProfit = monthlyProfit;
  
  for (let i = 0; i < period; i++) {
    totalReturn += currentMonthlyProfit;
    currentMonthlyProfit *= (1 + (growthRate / 100));
  }
  
  // Update results
  document.getElementById('resultMonthlyProfit').textContent = `â‚±${monthlyProfit.toLocaleString()}`;
  document.getElementById('resultAnnualReturn').textContent = `â‚±${annualReturn.toLocaleString()}`;
  document.getElementById('resultROI').textContent = `${roiPercentage}%`;
  document.getElementById('resultBreakEven').textContent = `${breakEvenMonths} months`;
  document.getElementById('resultTotalReturn').textContent = `â‚±${Math.round(totalReturn).toLocaleString()}`;
  
  // Generate analysis
  let analysis = '';
  if (roiPercentage >= 50) {
    analysis = 'Excellent ROI! This investment could provide strong returns. The business appears to have healthy profit margins and quick payback period.';
  } else if (roiPercentage >= 30) {
    analysis = 'Good ROI. This is a solid investment opportunity with reasonable returns. Consider conducting thorough due diligence.';
  } else if (roiPercentage >= 15) {
    analysis = 'Moderate ROI. Returns are acceptable but may require patience. Evaluate growth potential and sustainability carefully.';
  } else if (roiPercentage > 0) {
    analysis = 'Low ROI. Returns are modest. Consider negotiating the purchase price or exploring other opportunities.';
  } else {
    analysis = 'Negative ROI. Operating costs exceed revenue. This investment would result in ongoing losses - not recommended.';
  }
  
  if (breakEvenMonths <= 12) {
    analysis += ` Break-even within ${breakEvenMonths} months is favorable.`;
  } else if (breakEvenMonths <= 24) {
    analysis += ` Break-even period of ${breakEvenMonths} months requires medium-term commitment.`;
  } else {
    analysis += ` Extended break-even period of ${breakEvenMonths} months requires careful consideration.`;
  }
  
  document.getElementById('resultAnalysis').textContent = analysis;
  
  // Show results
  document.getElementById('calculatorResults').style.display = 'block';
  document.getElementById('calculatorResults').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  
  showToast('ROI calculated successfully!', 'success');
}

window.resetCalculator = function() {
  document.getElementById('calculatorForm').reset();
  document.getElementById('calculatorResults').style.display = 'none';
}

// ============================================
// NAVIGATION
// ============================================

window.navigateTo = function(page) {
  // Update sidebar navigation
  document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
  event?.target.closest('.nav-item')?.classList.add('active');
  
  // Update page title
  const pageTitles = {
  overview: 'Overview',
  marketplace: 'Marketplace',
  saved: 'Saved Listings',
  calculator: 'ROI Calculator',
  offers: 'My Offers',
  messages: 'Messages',
  inquiries: 'My Inquiries',
  purchases: 'Purchase History',
  settings: 'Settings'
};
  
  document.getElementById('pageTitle').textContent = pageTitles[page] || 'Dashboard';
  
  // Show the correct tab content
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });
  
  const selectedTab = document.getElementById(`tab-${page}`);
  if (selectedTab) {
    selectedTab.classList.add('active');
  }
}

// ============================================
// SETTINGS
// ============================================

window.saveSettings = async function(event) {
  event.preventDefault();
  
  const name = document.getElementById('settingsName').value.trim();
  const phone = document.getElementById('settingsPhone').value.trim();
  const location = document.getElementById('settingsLocation').value.trim();
  
  try {
    await updateDoc(doc(db, 'users', userData.id), {
      name,
      'profile.phone': phone,
      'profile.location': location,
      updatedAt: serverTimestamp()
    });
    
    // Update local data
    userData.name = name;
    userData.profile = { 
      ...userData.profile, 
      phone, 
      location 
    };
    
    updateUserProfile();
    showToast('Settings saved successfully!', 'success');
    
  } catch (error) {
    console.error('Error saving settings:', error);
    showToast('Failed to save settings. Please try again.', 'error');
  }
}

window.resetSettings = function() {
  document.getElementById('settingsName').value = userData.name;
  document.getElementById('settingsEmail').value = userData.email;
  document.getElementById('settingsPhone').value = userData.profile?.phone || '';
  document.getElementById('settingsLocation').value = userData.profile?.location || '';
  
  showToast('Settings reset', 'info');
}

// ============================================
// TOAST NOTIFICATIONS
// ============================================

function showToast(message, type = 'info') {
  // Remove existing toasts
  document.querySelectorAll('.toast').forEach(t => t.remove());
  
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  
  const icon = type === 'success' ? 'fa-check-circle' : 
               type === 'error' ? 'fa-exclamation-circle' : 
               type === 'info' ? 'fa-info-circle' : 'fa-bell';
  
  toast.innerHTML = `
    <i class="fa-solid ${icon}" style="font-size: 1.5rem;"></i>
    <div>
      <strong>${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
      <div style="font-size: 0.9rem;">${message}</div>
    </div>
  `;
  
  document.body.appendChild(toast);
  
  // Auto remove after 4 seconds
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease-out forwards';
    setTimeout(() => toast.remove(), 300);
  }, 4000);
}

// Add slideOut animation
const style = document.createElement('style');
style.textContent = `
  @keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(400px); opacity: 0; }
  }
`;
document.head.appendChild(style);

// ============================================
// LOGOUT
// ============================================

window.logout = async function() {
  if (confirm('Are you sure you want to sign out?')) {
    try {
      // Unsubscribe from listeners
      if (listingsUnsubscribe) {
        listingsUnsubscribe();
      }
      
      await signOut(auth);
      window.location.href = 'index.html';
    } catch (error) {
      console.error('Error signing out:', error);
      showToast('Failed to sign out. Please try again.', 'error');
    }
  }
}

// ============================================
// CLEANUP ON PAGE UNLOAD
// ============================================

window.addEventListener('beforeunload', () => {
  if (listingsUnsubscribe) {
    listingsUnsubscribe();
  }
});

// ============================================
// INITIALIZE ON SETTINGS TAB
// ============================================

window.addEventListener('DOMContentLoaded', () => {
  // Wait for user data to load
  const checkUserData = setInterval(() => {
    if (userData && document.body.classList.contains('loaded')) {
      clearInterval(checkUserData);
      
      // Populate settings form
      const settingsName = document.getElementById('settingsName');
      const settingsEmail = document.getElementById('settingsEmail');
      const settingsPhone = document.getElementById('settingsPhone');
      const settingsLocation = document.getElementById('settingsLocation');
      
      if (settingsName) settingsName.value = userData.name;
      if (settingsEmail) settingsEmail.value = userData.email;
      if (settingsPhone) settingsPhone.value = userData.profile?.phone || '';
      if (settingsLocation) settingsLocation.value = userData.profile?.location || '';
    }
  }, 100);
  
  // Clear after 10 seconds to prevent infinite loop
  setTimeout(() => clearInterval(checkUserData), 10000);
});

console.log('ðŸš€ Systemly Buyer Dashboard - Complete Version Loaded');
</script>

</body>
</html>
